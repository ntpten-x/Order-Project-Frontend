"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3490],{71567:function(e,t,o){o.d(t,{q:function(){return r},v:function(){return n}});let n="/api",r={AUTH:{LOGIN:"/auth/login",ME:"/auth/me",CSRF:"/csrf"},POS:{PRODUCTS:"/pos/products",ORDERS:"/pos/orders",TABLES:"/pos/tables",DISCOUNTS:"/pos/discounts",DELIVERY:"/pos/delivery",PAYMENT_METHODS:"/pos/paymentMethod",PAYMENTS:"/pos/payments",CATEGORY:"/pos/category",SHIFTS:{BASE:"/pos/shifts",CURRENT:"/pos/shifts/current",OPEN:"/pos/shifts/open",CLOSE:"/pos/shifts/close"},DASHBOARD:{SALES:"/pos/dashboard/sales",TOP_ITEMS:"/pos/dashboard/top-items"},CHANNELS:{STATS:"/pos/orders/stats"},SHOP_PROFILE:"/pos/shopProfile",SALES_ORDER_ITEMS:"/pos/salesOrderItem",SALES_ORDER_DETAILS:"/pos/salesOrderDetail",PRODUCTS_UNIT:"/pos/productsUnit",PAYMENT_DETAILS:"/pos/paymentDetails",BRANCH:"/branches"}}},14362:function(e,t,o){o.d(t,{AuthProvider:function(){return d},a:function(){return f}});var n=o(57437),r=o(2265),a=o(99376),i=o(5447),l=o(84859),c=o(48651),s=o(3369);let u=(0,r.createContext)(void 0),d=e=>{let{children:t}=e,[o,d]=(0,r.useState)(null),[f,h]=(0,r.useState)(!0),p=(0,a.useRouter)(),S=(0,a.usePathname)(),g=async()=>{try{let e="";e=localStorage.getItem("token_ws")||"";let t=await i.O.getMe(e);d(t)}catch(e){d(null)}finally{h(!1)}};(0,r.useEffect)(()=>{g()},[]);let{showLoading:E,hideLoading:m}=(0,s.x)();(0,r.useEffect)(()=>{f||o||"/login"===S||p.push("/login")},[o,f,S,p]);let v=async e=>{try{E("กำลังเข้าสู่ระบบ...");let t=await i.O.getCsrfToken(),{token:o,...n}=await i.O.login(e,t);o&&localStorage.setItem("token_ws",o),d(n),p.push("/")}catch(e){throw e}finally{m()}},T=async()=>{try{E("กำลังออกจากระบบ...");let e="";e=localStorage.getItem("token_ws")||"",await i.O.logout(e),localStorage.removeItem("token_ws"),l.x.clearQueue(),d(null),p.push("/login")}catch(e){console.error("Logout error:",e)}finally{m()}};return f?(0,n.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-white",children:(0,n.jsx)(c.Z,{size:"large"})}):o||"/login"===S?(0,n.jsx)(u.Provider,{value:{user:o,loading:f,login:v,logout:T,checkAuth:g},children:t}):null},f=()=>{let e=(0,r.useContext)(u);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},46252:function(e,t,o){o.d(t,{J:function(){return l},SocketProvider:function(){return c}});var n=o(57437),r=o(2265),a=o(68680),i=o(14362);let l=(0,r.createContext)({socket:null,isConnected:!1}),c=e=>{let{children:t}=e,[o,c]=(0,r.useState)(null),[s,u]=(0,r.useState)(!1),{user:d}=(0,i.a)();return(0,r.useEffect)(()=>{if(!d){o&&(o.disconnect(),c(null),u(!1));return}let e=localStorage.getItem("token_ws"),t=(0,a.io)("http://localhost:3000",{transports:["websocket"],withCredentials:!0,auth:e?{token:e}:void 0});return t.on("connect",()=>{console.log("Socket Connected:",t.id),u(!0)}),t.on("disconnect",()=>{console.log("Socket Disconnected"),u(!1)}),c(t),()=>{t.disconnect()}},[d]),(0,n.jsx)(l.Provider,{value:{socket:o,isConnected:s},children:t})}},3369:function(e,t,o){o.d(t,{GlobalLoadingProvider:function(){return c},O:function(){return u},x:function(){return s}});var n=o(57437),r=o(2265),a=o(48651);let i=(0,r.createContext)(void 0),l=(0,r.createContext)(void 0),c=e=>{let{children:t}=e,[o,c]=(0,r.useState)({}),[s,u]=(0,r.useState)(void 0),d=(0,r.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";c(e=>({...e,[t]:(e[t]||0)+1})),e&&u(e)},[]),f=(0,r.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";c(t=>{if(!t[e])return t;let o={...t};return o[e]-=1,o[e]<=0&&delete o[e],o})},[]),h=(0,r.useCallback)(()=>{c({}),u(void 0)},[]),p=Object.keys(o).length>0,S=(0,r.useMemo)(()=>({isLoading:p,loadingMessage:s}),[p,s]),g=(0,r.useMemo)(()=>({showLoading:d,hideLoading:f,resetLoading:h}),[d,f,h]);return(0,n.jsx)(l.Provider,{value:g,children:(0,n.jsxs)(i.Provider,{value:S,children:[t,p&&(0,n.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center pointer-events-auto bg-black/10 backdrop-blur-[1px]",children:(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:10,background:"rgba(255, 255, 255, 0.9)",padding:"20px 40px",borderRadius:12,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[(0,n.jsx)(a.Z,{size:"large"}),s&&(0,n.jsx)("div",{style:{fontSize:14,color:"#1f1f1f",fontWeight:500},children:s})]})})]})})};function s(){let e=(0,r.useContext)(i),t=(0,r.useContext)(l);if(!e||!t)throw Error("useGlobalLoading must be used within a GlobalLoadingProvider");return(0,r.useMemo)(()=>({...e,...t}),[e,t])}function u(){let e=(0,r.useContext)(l);if(!e)throw Error("useGlobalLoadingDispatch must be used within a GlobalLoadingProvider");return e}},24675:function(e,t,o){o.d(t,{s:function(){return a}});var n=o(2265),r=o(46252);let a=()=>(0,n.useContext)(r.J)},2913:function(e,t,o){function n(e,t){return({GET:"".concat(r.API_BASE_URL).concat(t),POST:"".concat(r.API_BASE_URL).concat(t),PUT:"".concat(r.API_BASE_URL).concat(t),DELETE:"".concat(r.API_BASE_URL).concat(t),PATCH:"".concat(r.API_BASE_URL).concat(t)})[e]}o.d(t,{b:function(){return n}});let r={get API_BASE_URL(){return"/api"}}},5447:function(e,t,o){o.d(t,{O:function(){return a}});var n=o(71567),r=o(2913);let a={login:async(e,t,o)=>{try{let a=(0,r.b)("POST",n.q.AUTH.LOGIN),i={"Content-Type":"application/json"};t&&(i["X-CSRF-Token"]=t),o&&(i.Cookie=o);let l=await fetch(a,{method:"POST",headers:i,credentials:"include",body:JSON.stringify(e)});if(!l.ok){let e=await l.json().catch(()=>({}));throw Error(e.message||e.detail||"เข้าสู่ระบบไม่สำเร็จ")}let c=await l.json();return{...c.user,token:c.token}}catch(e){throw Error(e.message||"เข้าสู่ระบบไม่สำเร็จ")}},logout:async(e,t,o)=>{try{let n=(0,r.b)("POST","/auth/logout"),a={"Content-Type":"application/json"};e&&(a.Authorization="Bearer ".concat(e)),t&&(a["X-CSRF-Token"]=t),o&&(a.Cookie=o),await fetch(n,{method:"POST",headers:a,credentials:"include"})}catch(e){console.error("Logout failed",e)}},getMe:async e=>{try{let t=(0,r.b)("GET",n.q.AUTH.ME),o=await fetch(t,{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},credentials:"include",cache:"no-store"});if(!o.ok)throw Error("Unauthorized");return await o.json()}catch(e){throw e}},async getCsrfToken(){try{let e=await fetch("".concat(n.v).concat(n.q.AUTH.CSRF),{credentials:"include"});if(!e.ok)return"";return(await e.json()).csrfToken}catch(e){return console.error("Failed to fetch CSRF token",e),""}}}},84859:function(e,t,o){o.d(t,{M:function(){return l},x:function(){return i}});let n="pos_offline_queue",r=()=>{let e=localStorage.getItem(n);return e?JSON.parse(e):[]},a=e=>{localStorage.setItem(n,JSON.stringify(e))},i={addToQueue:(e,t)=>{let o=r(),n={id:"offline-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),type:e,payload:t,timestamp:Date.now(),retryCount:0};return a([...o,n]),n},getQueue:()=>r(),removeFromQueue:e=>{a(r().filter(t=>t.id!==e))},incrementRetry:(e,t)=>{a(r().map(o=>o.id===e?{...o,retryCount:o.retryCount+1,lastError:t}:o))},clearQueue:()=>{localStorage.removeItem(n)},pruneExceeded:()=>{a(r().filter(e=>e.retryCount<=5))}},l={maxRetry:5,backoff:e=>Math.min(3e4,2e3*e)}},67697:function(e,t,o){o.d(t,{D:function(){return i},v:function(){return a}});var n=o(2265);let r=e=>{if("string"==typeof e)return e;if(e&&"object"==typeof e){var t;if("id"in e&&e.id)return e.id;if("data"in e&&(null===(t=e.data)||void 0===t?void 0:t.id))return e.data.id}};function a(e,t,o){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e=>e.id,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:()=>!0;(0,n.useEffect)(()=>{if(!e)return;let n=e=>{if(!i(e))return;let t=a(e);o(o=>o.some(e=>a(e)===t)?o:[...o,e])},l=e=>{let t=a(e);o(o=>i(e)?o.some(e=>a(e)===t)?o.map(o=>a(o)===t?e:o):[...o,e]:o.filter(e=>a(e)!==t))},c=e=>{let t=r(e);t&&o(e=>e.filter(e=>a(e)!==t))};return e.on(t.create,n),e.on(t.update,l),e.on(t.delete,c),()=>{e.off(t.create,n),e.off(t.update,l),e.off(t.delete,c)}},[e,t.create,t.update,t.delete,a,o,i])}function i(e){let{socket:t,events:o=[],onRefresh:r,intervalMs:a,enabled:i=!0,debounceMs:l}=e;(0,n.useEffect)(()=>{if(!i||!t||0===o.length)return;let e=null,n=()=>{if(!l||l<=0){r();return}e&&clearTimeout(e),e=setTimeout(()=>{e=null,r()},l)};return o.forEach(e=>t.on(e,n)),()=>{e&&clearTimeout(e),o.forEach(e=>t.off(e,n))}},[i,t,o,r,l]),(0,n.useEffect)(()=>{if(!i||!a)return;let e=setInterval(r,a);return()=>clearInterval(e)},[i,a,r])}}}]);