(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8012],{89212:function(e,t,n){Promise.resolve().then(n.bind(n,54531))},54531:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return O}});var r=n(57437),a=n(2265),o=n(88589),i=n(44967),s=n(64625),l=n(48651),c=n(47451),d=n(69410),u=n(80336),h=n(50742),f=n(99376),p=n(29),x=n.n(p),m=n(82646),g=n(17588),b=n(26349);let{Title:y,Text:S}=m.default,j={minHeight:"100vh",background:"#f8f9fc",paddingBottom:40},E={background:"#fff",padding:"20px 24px",borderBottom:"1px solid #f0f0f0",display:"flex",justifyContent:"space-between",alignItems:"center",position:"sticky",top:0,zIndex:10,boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},T={maxWidth:800,margin:"32px auto",padding:"32px",background:"#fff",borderRadius:20,boxShadow:"0 4px 20px rgba(0,0,0,0.05)"},k=()=>(0,r.jsx)(x(),{id:"d6a7379aac763388",children:".manage-form-card .ant-form-item-label label{font-weight:600;color:#374151}.manage-form-card .ant-input,.manage-form-card .ant-input-number,.manage-form-card .ant-select-selector{-webkit-border-radius:12px!important;-moz-border-radius:12px!important;border-radius:12px!important;padding-top:8px;padding-bottom:8px}"}),w=e=>{let{isEdit:t,onBack:n,onDelete:a}=e;return(0,r.jsxs)("div",{style:E,children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:16},children:[(0,r.jsx)(h.ZP,{icon:(0,r.jsx)(g.Z,{}),onClick:n,style:{borderRadius:"50%",width:40,height:40,display:"flex",alignItems:"center",justifyContent:"center",border:"none",background:"#f3f4f6"}}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,r.jsx)(y,{level:4,style:{margin:0},children:t?"แก้ไขข้อมูลสาขา":"เพิ่มสาขาใหม่"}),t&&(0,r.jsx)("div",{style:{background:"#f3f4f6",padding:"2px 8px",borderRadius:6,fontSize:12,color:"#6b7280",fontWeight:600},children:"EDIT MODE"})]}),(0,r.jsx)(S,{type:"secondary",style:{fontSize:13},children:t?"ปรับปรุงข้อมูลสาขาที่มีอยู่":"กรอกข้อมูลเพื่อสร้างสาขาใหม่"})]})]}),t&&a&&(0,r.jsx)(h.ZP,{danger:!0,icon:(0,r.jsx)(b.Z,{}),onClick:a,style:{borderRadius:12,height:40},children:"ลบสาขา"})]})};var v=n(1665),C=n(14362),_=n(97235);let{TextArea:P}=o.default;function O(e){let{params:t}=e,n=(0,f.useRouter)(),[p]=i.Z.useForm(),[x,m]=(0,a.useState)(!1),[g,b]=(0,a.useState)(!1),{user:y,loading:S}=(0,C.a)(),{message:E,modal:O}=s.Z.useApp(),A=t.mode[0],I=t.mode[1]||null,R="edit"===A&&!!I,Z=(0,a.useCallback)(async()=>{m(!0);try{let e=await v.x.getById(I);p.setFieldsValue({branch_name:e.branch_name,branch_code:e.branch_code,address:e.address,phone:e.phone,tax_id:e.tax_id,is_active:e.is_active})}catch(e){console.error(e),E.error("ไม่สามารถดึงข้อมูลสาขาได้"),n.push("/branch")}finally{m(!1)}},[I,p,n,E]);(0,a.useEffect)(()=>{if(!S&&y){if("Admin"!==y.role){n.push("/");return}R&&Z()}},[S,y,R,Z,n]);let L=async e=>{b(!0);try{let t=await (0,_.P)();R?(await v.x.update(I,e,void 0,t),E.success("อัปเดตสาขาสำเร็จ")):(await v.x.create(e,void 0,t),E.success("สร้างสาขาสำเร็จ")),n.push("/branch")}catch(e){console.error(e),E.error(e.message||"เกิดข้อผิดพลาดในการบันทึกข้อมูล")}finally{b(!1)}},D=()=>n.push("/branch");return S||R&&x?(0,r.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",background:"#f8f9fc"},children:(0,r.jsx)(l.Z,{size:"large"})}):(0,r.jsxs)("div",{style:j,children:[(0,r.jsx)(k,{}),(0,r.jsx)(w,{isEdit:R,onBack:D,onDelete:R?()=>{I&&O.confirm({title:"ยืนยันการลบสาขา",content:"คุณต้องการลบสาขานี้หรือไม่?",okText:"ลบ",okType:"danger",cancelText:"ยกเลิก",centered:!0,onOk:async()=>{try{let e=await (0,_.P)();await v.x.delete(I,void 0,e),E.success("ลบสาขาสำเร็จ"),n.push("/branch")}catch(e){E.error("ไม่สามารถลบสาขาได้")}}})}:void 0}),(0,r.jsx)("div",{className:"manage-form-card",style:T,children:(0,r.jsxs)(i.Z,{form:p,layout:"vertical",onFinish:L,requiredMark:!1,autoComplete:"off",initialValues:{is_active:!0},children:[(0,r.jsxs)(c.Z,{gutter:24,children:[(0,r.jsx)(d.Z,{xs:24,md:12,children:(0,r.jsx)(i.Z.Item,{name:"branch_name",label:"ชื่อสาขา *",rules:[{required:!0,message:"กรุณากรอกชื่อสาขา"}],children:(0,r.jsx)(o.default,{size:"large",placeholder:"ระบุชื่อสาขา",maxLength:100})})}),(0,r.jsx)(d.Z,{xs:24,md:12,children:(0,r.jsx)(i.Z.Item,{name:"branch_code",label:"รหัสสาขา *",rules:[{required:!0,message:"กรุณากรอกรหัสสาขา"},{pattern:/^[A-Za-z0-9]+$/,message:"รหัสสาขาต้องเป็นตัวอักษรภาษาอังกฤษหรือตัวเลข"}],children:(0,r.jsx)(o.default,{size:"large",placeholder:"เช่น B001",maxLength:20})})})]}),(0,r.jsx)(i.Z.Item,{name:"address",label:"ที่อยู่",children:(0,r.jsx)(P,{rows:3,placeholder:"ที่อยู่สาขา",style:{borderRadius:12}})}),(0,r.jsxs)(c.Z,{gutter:24,children:[(0,r.jsx)(d.Z,{xs:24,md:12,children:(0,r.jsx)(i.Z.Item,{name:"phone",label:"เบอร์โทรศัพท์",children:(0,r.jsx)(o.default,{size:"large",placeholder:"02xxxxxxx",maxLength:20})})}),(0,r.jsx)(d.Z,{xs:24,md:12,children:(0,r.jsx)(i.Z.Item,{name:"tax_id",label:"เลขประจำตัวผู้เสียภาษี (Tax ID)",children:(0,r.jsx)(o.default,{size:"large",placeholder:"ระบุเลขผู้เสียภาษี",maxLength:50})})})]}),(0,r.jsx)(i.Z.Item,{name:"is_active",label:"สถานะ",valuePropName:"checked",children:(0,r.jsx)(u.Z,{checkedChildren:"เปิดใช้งาน",unCheckedChildren:"ปิดปรับปรุง"})}),(0,r.jsxs)("div",{style:{marginTop:32,display:"flex",justifyContent:"flex-end",gap:12},children:[(0,r.jsx)(h.ZP,{size:"large",onClick:D,style:{borderRadius:12,minWidth:100},children:"ยกเลิก"}),(0,r.jsx)(h.ZP,{type:"primary",htmlType:"submit",loading:g,size:"large",style:{borderRadius:12,minWidth:120,background:"#7c3aed",border:"none"},children:R?"บันทึกการแก้ไข":"สร้างสาขา"})]})]})})]})}},71567:function(e,t,n){"use strict";n.d(t,{q:function(){return a},v:function(){return r}});let r="/api",a={AUTH:{LOGIN:"/auth/login",ME:"/auth/me",CSRF:"/csrf"},POS:{PRODUCTS:"/pos/products",ORDERS:"/pos/orders",TABLES:"/pos/tables",DISCOUNTS:"/pos/discounts",DELIVERY:"/pos/delivery",PAYMENT_METHODS:"/pos/paymentMethod",PAYMENTS:"/pos/payments",CATEGORY:"/pos/category",SHIFTS:{BASE:"/pos/shifts",CURRENT:"/pos/shifts/current",OPEN:"/pos/shifts/open",CLOSE:"/pos/shifts/close"},DASHBOARD:{SALES:"/pos/dashboard/sales",TOP_ITEMS:"/pos/dashboard/top-items"},CHANNELS:{STATS:"/pos/orders/stats"},SHOP_PROFILE:"/pos/shopProfile",SALES_ORDER_ITEMS:"/pos/salesOrderItem",SALES_ORDER_DETAILS:"/pos/salesOrderDetail",PRODUCTS_UNIT:"/pos/productsUnit",PAYMENT_DETAILS:"/pos/paymentDetails",BRANCH:"/branches"}}},14362:function(e,t,n){"use strict";n.d(t,{AuthProvider:function(){return u},a:function(){return h}});var r=n(57437),a=n(2265),o=n(99376),i=n(5447),s=n(84859),l=n(48651),c=n(3369);let d=(0,a.createContext)(void 0),u=e=>{let{children:t}=e,[n,u]=(0,a.useState)(null),[h,f]=(0,a.useState)(!0),p=(0,o.useRouter)(),x=(0,o.usePathname)(),m=async()=>{try{let e="";e=localStorage.getItem("token_ws")||"";let t=await i.O.getMe(e);u(t)}catch(e){u(null)}finally{f(!1)}};(0,a.useEffect)(()=>{m()},[]);let{showLoading:g,hideLoading:b}=(0,c.x)();(0,a.useEffect)(()=>{h||n||"/login"===x||p.push("/login")},[n,h,x,p]);let y=async e=>{try{g("กำลังเข้าสู่ระบบ...");let t=await i.O.getCsrfToken(),{token:n,...r}=await i.O.login(e,t);n&&localStorage.setItem("token_ws",n),u(r),p.push("/")}catch(e){throw e}finally{b()}},S=async()=>{try{g("กำลังออกจากระบบ...");let e="";e=localStorage.getItem("token_ws")||"",await i.O.logout(e),localStorage.removeItem("token_ws"),s.x.clearQueue(),u(null),p.push("/login")}catch(e){console.error("Logout error:",e)}finally{b()}};return h?(0,r.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-white",children:(0,r.jsx)(l.Z,{size:"large"})}):n||"/login"===x?(0,r.jsx)(d.Provider,{value:{user:n,loading:h,login:y,logout:S,checkAuth:m},children:t}):null},h=()=>{let e=(0,a.useContext)(d);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},3369:function(e,t,n){"use strict";n.d(t,{GlobalLoadingProvider:function(){return l},O:function(){return d},x:function(){return c}});var r=n(57437),a=n(2265),o=n(48651);let i=(0,a.createContext)(void 0),s=(0,a.createContext)(void 0),l=e=>{let{children:t}=e,[n,l]=(0,a.useState)({}),[c,d]=(0,a.useState)(void 0),u=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";l(e=>({...e,[t]:(e[t]||0)+1})),e&&d(e)},[]),h=(0,a.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";l(t=>{if(!t[e])return t;let n={...t};return n[e]-=1,n[e]<=0&&delete n[e],n})},[]),f=(0,a.useCallback)(()=>{l({}),d(void 0)},[]),p=Object.keys(n).length>0,x=(0,a.useMemo)(()=>({isLoading:p,loadingMessage:c}),[p,c]),m=(0,a.useMemo)(()=>({showLoading:u,hideLoading:h,resetLoading:f}),[u,h,f]);return(0,r.jsx)(s.Provider,{value:m,children:(0,r.jsxs)(i.Provider,{value:x,children:[t,p&&(0,r.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center pointer-events-auto bg-black/10 backdrop-blur-[1px]",children:(0,r.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:10,background:"rgba(255, 255, 255, 0.9)",padding:"20px 40px",borderRadius:12,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[(0,r.jsx)(o.Z,{size:"large"}),c&&(0,r.jsx)("div",{style:{fontSize:14,color:"#1f1f1f",fontWeight:500},children:c})]})})]})})};function c(){let e=(0,a.useContext)(i),t=(0,a.useContext)(s);if(!e||!t)throw Error("useGlobalLoading must be used within a GlobalLoadingProvider");return(0,a.useMemo)(()=>({...e,...t}),[e,t])}function d(){let e=(0,a.useContext)(s);if(!e)throw Error("useGlobalLoadingDispatch must be used within a GlobalLoadingProvider");return e}},2913:function(e,t,n){"use strict";function r(e,t){return({GET:"".concat(a.API_BASE_URL).concat(t),POST:"".concat(a.API_BASE_URL).concat(t),PUT:"".concat(a.API_BASE_URL).concat(t),DELETE:"".concat(a.API_BASE_URL).concat(t),PATCH:"".concat(a.API_BASE_URL).concat(t)})[e]}n.d(t,{b:function(){return r}});let a={get API_BASE_URL(){return"/api"}}},81026:function(e,t,n){"use strict";n.d(t,{E:function(){return o},M:function(){return a}});var r=n(20019);let a=r.Ryn({id:r.Z_8(),branch_name:r.Z_8(),branch_code:r.Z_8(),address:r.Z_8().optional().nullable(),phone:r.Z_8().optional().nullable(),tax_id:r.Z_8().optional().nullable(),is_active:r.O72().default(!0),create_date:r.Z_8().or(r.hTZ()).transform(e=>new Date(e))}),o=r.IXX(a)},5447:function(e,t,n){"use strict";n.d(t,{O:function(){return o}});var r=n(71567),a=n(2913);let o={login:async(e,t,n)=>{try{let o=(0,a.b)("POST",r.q.AUTH.LOGIN),i={"Content-Type":"application/json"};t&&(i["X-CSRF-Token"]=t),n&&(i.Cookie=n);let s=await fetch(o,{method:"POST",headers:i,credentials:"include",body:JSON.stringify(e)});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.message||e.detail||"เข้าสู่ระบบไม่สำเร็จ")}let l=await s.json();return{...l.user,token:l.token}}catch(e){throw Error(e.message||"เข้าสู่ระบบไม่สำเร็จ")}},logout:async(e,t,n)=>{try{let r=(0,a.b)("POST","/auth/logout"),o={"Content-Type":"application/json"};e&&(o.Authorization="Bearer ".concat(e)),t&&(o["X-CSRF-Token"]=t),n&&(o.Cookie=n),await fetch(r,{method:"POST",headers:o,credentials:"include"})}catch(e){console.error("Logout failed",e)}},getMe:async e=>{try{let t=(0,a.b)("GET",r.q.AUTH.ME),n=await fetch(t,{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},credentials:"include",cache:"no-store"});if(!n.ok)throw Error("Unauthorized");return await n.json()}catch(e){throw e}},async getCsrfToken(){try{let e=await fetch("".concat(r.v).concat(r.q.AUTH.CSRF),{credentials:"include"});if(!e.ok)return"";return(await e.json()).csrfToken}catch(e){return console.error("Failed to fetch CSRF token",e),""}}}},1665:function(e,t,n){"use strict";n.d(t,{x:function(){return s}});var r=n(71567),a=n(2913),o=n(81026);let i=r.q.POS.BRANCH,s={getAll:async e=>{let t=(0,a.b)("GET",i),n={};e&&(n.Cookie=e);let r=await fetch(t,{cache:"no-store",credentials:"include",headers:n});if(!r.ok)throw Error("Failed to fetch branches");let s=await r.json();return o.E.parse(s)},getById:async(e,t)=>{let n=(0,a.b)("GET","".concat(i,"/").concat(e)),r={};t&&(r.Cookie=t);let s=await fetch(n,{cache:"no-store",credentials:"include",headers:r});if(!s.ok)throw Error("Failed to fetch branch");let l=await s.json();return o.M.parse(l)},create:async(e,t,n)=>{let r=(0,a.b)("POST",i),o={"Content-Type":"application/json"};t&&(o.Cookie=t),n&&(o["X-CSRF-Token"]=n);let s=await fetch(r,{method:"POST",body:JSON.stringify(e),headers:o,credentials:"include"});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.error||e.message||"Failed to create branch")}return s.json()},update:async(e,t,n,r)=>{let o=(0,a.b)("PUT","".concat(i,"/").concat(e)),s={"Content-Type":"application/json"};n&&(s.Cookie=n),r&&(s["X-CSRF-Token"]=r);let l=await fetch(o,{method:"PUT",body:JSON.stringify(t),headers:s,credentials:"include"});if(!l.ok){let e=await l.json().catch(()=>({}));throw Error(e.error||e.message||"Failed to update branch")}return l.json()},delete:async(e,t,n)=>{let r=(0,a.b)("DELETE","".concat(i,"/").concat(e)),o={};t&&(o.Cookie=t),n&&(o["X-CSRF-Token"]=n);let s=await fetch(r,{method:"DELETE",headers:o,credentials:"include"});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.error||e.message||"Failed to delete branch")}}}},84859:function(e,t,n){"use strict";n.d(t,{M:function(){return s},x:function(){return i}});let r="pos_offline_queue",a=()=>{let e=localStorage.getItem(r);return e?JSON.parse(e):[]},o=e=>{localStorage.setItem(r,JSON.stringify(e))},i={addToQueue:(e,t)=>{let n=a(),r={id:"offline-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),type:e,payload:t,timestamp:Date.now(),retryCount:0};return o([...n,r]),r},getQueue:()=>a(),removeFromQueue:e=>{o(a().filter(t=>t.id!==e))},incrementRetry:(e,t)=>{o(a().map(n=>n.id===e?{...n,retryCount:n.retryCount+1,lastError:t}:n))},clearQueue:()=>{localStorage.removeItem(r)},pruneExceeded:()=>{o(a().filter(e=>e.retryCount<=5))}},s={maxRetry:5,backoff:e=>Math.min(3e4,2e3*e)}},97235:function(e,t,n){"use strict";n.d(t,{P:function(){return s}});var r=n(5447);let a=null,o=0,i=null;async function s(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=Date.now();return!e&&a&&t-o<6e5?a:(i||(i=r.O.getCsrfToken().then(e=>(a=e||"",o=Date.now(),a)).finally(()=>{i=null})),i)}}},function(e){e.O(0,[5015,7717,7698,742,3211,7993,8651,2646,6207,7213,9021,2224,3248,5616,8589,19,4967,2239,4480,2119,2971,2117,1744],function(){return e(e.s=89212)}),_N_E=e.O()}]);