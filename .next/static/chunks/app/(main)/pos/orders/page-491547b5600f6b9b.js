(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4900,3490],{62121:function(e,t,r){Promise.resolve().then(r.bind(r,34841))},34841:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return D}});var n=r(57437),o=r(29),s=r.n(o),a=r(2265),l=r(82646),i=r(38616),c=r(80009),d=r(23496),u=r(50742),h=r(88589),f=r(96931),y=r(2297),m=r(85180),p=r(35631),x=r(6520),g=r(17588),S=r(63680),v=r(89245),j=r(5540),E=r(99376),_=r(32446),b=r(61414),w=r(1165),T=r(24675),C=r(67697),k=r(11713),L=r(45345),P=r(53286),A=r(71096),O=r.n(A);r(6729);let{Title:I,Text:R}=l.default,{useBreakpoint:N}=i.default;function D(){let e=(0,E.useRouter)(),t=!N().md,{socket:r}=(0,T.s)(),[o,l]=(0,a.useState)(1),[i,A]=(0,a.useState)(""),[D,Z]=(0,a.useState)("");(0,a.useEffect)(()=>{let e=setTimeout(()=>{Z(i.trim()),l(1)},400);return()=>clearTimeout(e)},[i]);let{orders:M,total:z,isLoading:H,refetch:U}=function(e){let{page:t=1,limit:r=50,status:n,type:o,query:s}=e,{data:a,error:l,isLoading:i,isFetching:c,refetch:d}=(0,k.a)({queryKey:["ordersSummary",t,r,n||"all",o||"all",s||""],queryFn:async()=>await P.x.getAllSummary(void 0,t,r,n,o,s),placeholderData:L.Wk,staleTime:3e3});return{orders:(null==a?void 0:a.data)||[],total:(null==a?void 0:a.total)||0,currentPage:(null==a?void 0:a.page)||t,lastPage:(null==a?void 0:a.last_page)||1,isLoading:i,isFetching:c,isError:l,refetch:d}}({page:o,limit:10,status:"Pending,Cooking,Served,WaitingForPayment",query:D||void 0});(0,C.D)({socket:r,events:["orders:create","orders:update","orders:delete","payments:create","payments:update"],onRefresh:()=>U(),intervalMs:15e3,debounceMs:1e3});let B=[{title:"เลขที่ออเดอร์",dataIndex:"order_no",key:"order_no",align:"center",render:e=>(0,n.jsx)(R,{strong:!0,style:{whiteSpace:"nowrap"},children:e})},{title:"วันเวลา",dataIndex:"create_date",key:"date",align:"center",render:e=>(0,n.jsxs)("div",{style:{whiteSpace:"nowrap"},children:[(0,n.jsx)(R,{children:O()(e).format("DD MMM YYYY")}),(0,n.jsx)("br",{}),(0,n.jsx)(R,{type:"secondary",style:{fontSize:12},children:O()(e).format("HH:mm")})]})},{title:"ประเภท",dataIndex:"order_type",key:"type",align:"center",render:e=>(0,n.jsx)(c.Z,{color:(0,b.Gs)(e),style:{margin:0},children:(0,b.mz)(e)})},{title:"โต๊ะ / รหัสอ้างอิง",key:"reference",align:"center",render:(e,t)=>{let r=(0,b.jN)(t),o="default";return t.order_type===_.m.DineIn&&(o="cyan"),t.order_type===_.m.Delivery&&(o="orange"),(0,n.jsx)(c.Z,{color:o,style:{margin:0},children:r})}},{title:"รายละเอียดรายการ",key:"items_summary",width:200,align:"center",render:(e,t)=>{let r=t.items_summary||{},o=t.items_count||0,s=Object.entries(r);return 0===o?(0,n.jsx)(R,{type:"secondary",children:"-"}):(0,n.jsxs)("div",{style:{fontSize:13,lineHeight:"1.6",textAlign:"left",display:"inline-block",minWidth:140},children:[s.length>0?(0,n.jsxs)(n.Fragment,{children:[s.map(e=>{let[t,r]=e;return(0,n.jsxs)("div",{style:w.L2.summaryRow,children:[(0,n.jsx)(R,{type:"secondary",children:t}),(0,n.jsxs)(R,{strong:!0,children:[r," รายการ"]})]},t)}),(0,n.jsx)(d.Z,{style:{margin:"4px 0"}})]}):null,(0,n.jsxs)("div",{style:w.L2.summaryRowBold,children:[(0,n.jsx)(R,{strong:!0,children:"รวม"}),(0,n.jsxs)(R,{strong:!0,style:{color:w.mv.primary},children:[o," รายการ"]})]})]})}},{title:"ยอดรวม",dataIndex:"total_amount",key:"total",align:"center",render:e=>(0,n.jsx)(R,{strong:!0,style:{whiteSpace:"nowrap"},children:(0,b.xG)(e)})},{title:"สถานะ",dataIndex:"status",key:"status",align:"center",render:e=>(0,n.jsx)(c.Z,{color:(0,b.OY)(e),style:{margin:0},children:(0,b.d7)(e)})},{title:"จัดการ",key:"action",align:"center",render:(t,r)=>(0,n.jsx)(u.ZP,{type:"primary",icon:(0,n.jsx)(x.Z,{}),onClick:()=>e.push("/pos/orders/".concat(r.id)),style:{whiteSpace:"nowrap"},children:"ดูรายละเอียด"})}];return(0,n.jsxs)("div",{style:w.L2.container,children:[(0,n.jsx)(s(),{id:w.$k.__hash,children:w.$k}),(0,n.jsx)("div",{style:w.L2.header,className:"orders-header",children:(0,n.jsxs)("div",{style:w.L2.headerContent,className:"orders-content",children:[(0,n.jsx)(u.ZP,{icon:(0,n.jsx)(g.Z,{}),onClick:()=>e.push("/pos"),type:"text",style:{color:"#fff",fontSize:18,marginRight:16}}),(0,n.jsx)("div",{style:w.L2.headerIcon,className:"orders-header-icon",children:(0,n.jsx)(S.Z,{style:{color:"#fff"}})}),(0,n.jsxs)("div",{style:w.L2.headerTextContainer,children:[(0,n.jsx)(I,{level:2,style:w.L2.headerTitle,className:"orders-page-title",children:"รายการออเดอร์ปัจจุบัน"}),(0,n.jsx)(R,{style:w.L2.headerSubtitle,className:"orders-page-subtitle",children:"จัดการและติดตามสถานะออเดอร์ที่กำลังดำเนินการ"})]}),(0,n.jsx)(h.default,{allowClear:!0,placeholder:"ค้นหาเลขที่ออเดอร์/โต๊ะ/เดลิเวอรี่",value:i,onChange:e=>A(e.target.value),size:t?"middle":"large",style:{width:t?200:280}}),(0,n.jsx)(u.ZP,{icon:(0,n.jsx)(v.Z,{}),onClick:()=>U(),size:t?"middle":"large",ghost:!0,children:"รีเฟรช"})]})}),(0,n.jsx)("div",{style:w.L2.contentWrapper,className:"orders-content-wrapper",children:(0,n.jsx)(f.Z,{bordered:!1,style:{borderRadius:16,boxShadow:"0 4px 12px rgba(0,0,0,0.05)"},bodyStyle:w.L2.cardBody,children:t?(0,n.jsx)(p.Z,{loading:H,dataSource:M,renderItem:t=>{let r=t.items_count||0;return(0,n.jsxs)("div",{style:w.L2.orderCard,onClick:()=>e.push("/pos/orders/".concat(t.id)),className:"orders-card",children:[(0,n.jsxs)("div",{style:w.L2.cardHeader,className:"orders-card-header",children:[(0,n.jsxs)("div",{style:w.L2.cardHeaderLeft,children:[(0,n.jsxs)(R,{strong:!0,style:{fontSize:16},children:["#",t.order_no]}),(0,n.jsx)(c.Z,{color:(0,b.OY)(t.status),style:{margin:0},children:(0,b.d7)(t.status)})]}),(0,n.jsx)(c.Z,{color:(0,b.Gs)(t.order_type),children:(0,b.mz)(t.order_type)})]}),(0,n.jsxs)("div",{style:w.L2.cardBody,className:"orders-card-body",children:[(0,n.jsxs)("div",{style:w.L2.refSection,children:[t.order_type===_.m.DineIn&&t.table&&(0,n.jsxs)("div",{style:w.L2.refValue,className:"orders-ref-value",children:["โต๊ะ ",t.table.table_name]}),(t.order_type===_.m.Delivery||t.order_type===_.m.TakeAway)&&(0,n.jsx)("div",{style:w.L2.refValue,className:"orders-ref-value",children:t.delivery_code?"Ref: ".concat(t.delivery_code):"-"})]}),(0,n.jsxs)("div",{style:w.L2.itemsSummary,children:[(0,n.jsxs)("div",{style:w.L2.metaSection,children:[(0,n.jsx)(S.Z,{}),(0,n.jsxs)(R,{strong:!0,children:[r," รายการ"]})]}),(0,n.jsxs)("div",{style:w.L2.metaSection,children:[(0,n.jsx)(j.Z,{}),(0,n.jsx)(R,{children:O()(t.create_date).format("HH:mm น.")})]})]}),(0,n.jsxs)("div",{style:w.L2.totalSection,children:[(0,n.jsx)(R,{style:w.L2.totalLabel,children:"ยอดรวม"}),(0,n.jsx)("div",{style:w.L2.totalAmount,className:"orders-total-amount",children:(0,b.xG)(Number(t.total_amount))})]}),(0,n.jsx)(u.ZP,{type:"primary",ghost:!0,icon:(0,n.jsx)(x.Z,{}),style:w.L2.actionButton,children:"รายละเอียด"})]})]})},pagination:{current:o,pageSize:10,total:z,onChange:e=>l(e),size:"small",style:{textAlign:"center",marginTop:16}}}):(0,n.jsx)(y.Z,{columns:B,dataSource:M,loading:H,rowKey:"id",virtual:!0,scroll:{y:600},pagination:{current:o,pageSize:10,total:z,onChange:e=>l(e),showTotal:e=>"ทั้งหมด ".concat(e," รายการ")},locale:{emptyText:(0,n.jsx)(m.Z,{description:"ไม่พบรายการออเดอร์"})}})})})]})}O().locale("th")},71567:function(e,t,r){"use strict";r.d(t,{q:function(){return o},v:function(){return n}});let n="/api",o={AUTH:{LOGIN:"/auth/login",ME:"/auth/me",CSRF:"/csrf"},POS:{PRODUCTS:"/pos/products",ORDERS:"/pos/orders",TABLES:"/pos/tables",DISCOUNTS:"/pos/discounts",DELIVERY:"/pos/delivery",PAYMENT_METHODS:"/pos/paymentMethod",PAYMENTS:"/pos/payments",CATEGORY:"/pos/category",SHIFTS:{BASE:"/pos/shifts",CURRENT:"/pos/shifts/current",OPEN:"/pos/shifts/open",CLOSE:"/pos/shifts/close"},DASHBOARD:{SALES:"/pos/dashboard/sales",TOP_ITEMS:"/pos/dashboard/top-items"},CHANNELS:{STATS:"/pos/orders/stats"},SHOP_PROFILE:"/pos/shopProfile",SALES_ORDER_ITEMS:"/pos/salesOrderItem",SALES_ORDER_DETAILS:"/pos/salesOrderDetail",PRODUCTS_UNIT:"/pos/productsUnit",PAYMENT_DETAILS:"/pos/paymentDetails",BRANCH:"/branches"}}},14362:function(e,t,r){"use strict";r.d(t,{AuthProvider:function(){return u},a:function(){return h}});var n=r(57437),o=r(2265),s=r(99376),a=r(5447),l=r(84859),i=r(48651),c=r(3369);let d=(0,o.createContext)(void 0),u=e=>{let{children:t}=e,[r,u]=(0,o.useState)(null),[h,f]=(0,o.useState)(!0),y=(0,s.useRouter)(),m=(0,s.usePathname)(),p=async()=>{try{let e="";e=localStorage.getItem("token_ws")||"";let t=await a.O.getMe(e);u(t)}catch(e){u(null)}finally{f(!1)}};(0,o.useEffect)(()=>{p()},[]);let{showLoading:x,hideLoading:g}=(0,c.x)();(0,o.useEffect)(()=>{h||r||"/login"===m||y.push("/login")},[r,h,m,y]);let S=async e=>{try{x("กำลังเข้าสู่ระบบ...");let t=await a.O.getCsrfToken(),{token:r,...n}=await a.O.login(e,t);r&&localStorage.setItem("token_ws",r),u(n),y.push("/")}catch(e){throw e}finally{g()}},v=async()=>{try{x("กำลังออกจากระบบ...");let e="";e=localStorage.getItem("token_ws")||"",await a.O.logout(e),localStorage.removeItem("token_ws"),l.x.clearQueue(),u(null),y.push("/login")}catch(e){console.error("Logout error:",e)}finally{g()}};return h?(0,n.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-white",children:(0,n.jsx)(i.Z,{size:"large"})}):r||"/login"===m?(0,n.jsx)(d.Provider,{value:{user:r,loading:h,login:S,logout:v,checkAuth:p},children:t}):null},h=()=>{let e=(0,o.useContext)(d);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},46252:function(e,t,r){"use strict";r.d(t,{J:function(){return l},SocketProvider:function(){return i}});var n=r(57437),o=r(2265),s=r(68680),a=r(14362);let l=(0,o.createContext)({socket:null,isConnected:!1}),i=e=>{let{children:t}=e,[r,i]=(0,o.useState)(null),[c,d]=(0,o.useState)(!1),{user:u}=(0,a.a)();return(0,o.useEffect)(()=>{if(!u){r&&(r.disconnect(),i(null),d(!1));return}let e=localStorage.getItem("token_ws"),t=(0,s.io)("http://localhost:3000",{transports:["websocket"],withCredentials:!0,auth:e?{token:e}:void 0});return t.on("connect",()=>{console.log("Socket Connected:",t.id),d(!0)}),t.on("disconnect",()=>{console.log("Socket Disconnected"),d(!1)}),i(t),()=>{t.disconnect()}},[u]),(0,n.jsx)(l.Provider,{value:{socket:r,isConnected:c},children:t})}},3369:function(e,t,r){"use strict";r.d(t,{GlobalLoadingProvider:function(){return i},O:function(){return d},x:function(){return c}});var n=r(57437),o=r(2265),s=r(48651);let a=(0,o.createContext)(void 0),l=(0,o.createContext)(void 0),i=e=>{let{children:t}=e,[r,i]=(0,o.useState)({}),[c,d]=(0,o.useState)(void 0),u=(0,o.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";i(e=>({...e,[t]:(e[t]||0)+1})),e&&d(e)},[]),h=(0,o.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";i(t=>{if(!t[e])return t;let r={...t};return r[e]-=1,r[e]<=0&&delete r[e],r})},[]),f=(0,o.useCallback)(()=>{i({}),d(void 0)},[]),y=Object.keys(r).length>0,m=(0,o.useMemo)(()=>({isLoading:y,loadingMessage:c}),[y,c]),p=(0,o.useMemo)(()=>({showLoading:u,hideLoading:h,resetLoading:f}),[u,h,f]);return(0,n.jsx)(l.Provider,{value:p,children:(0,n.jsxs)(a.Provider,{value:m,children:[t,y&&(0,n.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center pointer-events-auto bg-black/10 backdrop-blur-[1px]",children:(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:10,background:"rgba(255, 255, 255, 0.9)",padding:"20px 40px",borderRadius:12,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[(0,n.jsx)(s.Z,{size:"large"}),c&&(0,n.jsx)("div",{style:{fontSize:14,color:"#1f1f1f",fontWeight:500},children:c})]})})]})})};function c(){let e=(0,o.useContext)(a),t=(0,o.useContext)(l);if(!e||!t)throw Error("useGlobalLoading must be used within a GlobalLoadingProvider");return(0,o.useMemo)(()=>({...e,...t}),[e,t])}function d(){let e=(0,o.useContext)(l);if(!e)throw Error("useGlobalLoadingDispatch must be used within a GlobalLoadingProvider");return e}},24675:function(e,t,r){"use strict";r.d(t,{s:function(){return s}});var n=r(2265),o=r(46252);let s=()=>(0,n.useContext)(o.J)},2913:function(e,t,r){"use strict";function n(e,t){return({GET:"".concat(o.API_BASE_URL).concat(t),POST:"".concat(o.API_BASE_URL).concat(t),PUT:"".concat(o.API_BASE_URL).concat(t),DELETE:"".concat(o.API_BASE_URL).concat(t),PATCH:"".concat(o.API_BASE_URL).concat(t)})[e]}r.d(t,{b:function(){return n}});let o={get API_BASE_URL(){return"/api"}}},5447:function(e,t,r){"use strict";r.d(t,{O:function(){return s}});var n=r(71567),o=r(2913);let s={login:async(e,t,r)=>{try{let s=(0,o.b)("POST",n.q.AUTH.LOGIN),a={"Content-Type":"application/json"};t&&(a["X-CSRF-Token"]=t),r&&(a.Cookie=r);let l=await fetch(s,{method:"POST",headers:a,credentials:"include",body:JSON.stringify(e)});if(!l.ok){let e=await l.json().catch(()=>({}));throw Error(e.message||e.detail||"เข้าสู่ระบบไม่สำเร็จ")}let i=await l.json();return{...i.user,token:i.token}}catch(e){throw Error(e.message||"เข้าสู่ระบบไม่สำเร็จ")}},logout:async(e,t,r)=>{try{let n=(0,o.b)("POST","/auth/logout"),s={"Content-Type":"application/json"};e&&(s.Authorization="Bearer ".concat(e)),t&&(s["X-CSRF-Token"]=t),r&&(s.Cookie=r),await fetch(n,{method:"POST",headers:s,credentials:"include"})}catch(e){console.error("Logout failed",e)}},getMe:async e=>{try{let t=(0,o.b)("GET",n.q.AUTH.ME),r=await fetch(t,{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},credentials:"include",cache:"no-store"});if(!r.ok)throw Error("Unauthorized");return await r.json()}catch(e){throw e}},async getCsrfToken(){try{let e=await fetch("".concat(n.v).concat(n.q.AUTH.CSRF),{credentials:"include"});if(!e.ok)return"";return(await e.json()).csrfToken}catch(e){return console.error("Failed to fetch CSRF token",e),""}}}},84859:function(e,t,r){"use strict";r.d(t,{M:function(){return l},x:function(){return a}});let n="pos_offline_queue",o=()=>{let e=localStorage.getItem(n);return e?JSON.parse(e):[]},s=e=>{localStorage.setItem(n,JSON.stringify(e))},a={addToQueue:(e,t)=>{let r=o(),n={id:"offline-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),type:e,payload:t,timestamp:Date.now(),retryCount:0};return s([...r,n]),n},getQueue:()=>o(),removeFromQueue:e=>{s(o().filter(t=>t.id!==e))},incrementRetry:(e,t)=>{s(o().map(r=>r.id===e?{...r,retryCount:r.retryCount+1,lastError:t}:r))},clearQueue:()=>{localStorage.removeItem(n)},pruneExceeded:()=>{s(o().filter(e=>e.retryCount<=5))}},l={maxRetry:5,backoff:e=>Math.min(3e4,2e3*e)}},67697:function(e,t,r){"use strict";r.d(t,{D:function(){return a},v:function(){return s}});var n=r(2265);let o=e=>{if("string"==typeof e)return e;if(e&&"object"==typeof e){var t;if("id"in e&&e.id)return e.id;if("data"in e&&(null===(t=e.data)||void 0===t?void 0:t.id))return e.data.id}};function s(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e=>e.id,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:()=>!0;(0,n.useEffect)(()=>{if(!e)return;let n=e=>{if(!a(e))return;let t=s(e);r(r=>r.some(e=>s(e)===t)?r:[...r,e])},l=e=>{let t=s(e);r(r=>a(e)?r.some(e=>s(e)===t)?r.map(r=>s(r)===t?e:r):[...r,e]:r.filter(e=>s(e)!==t))},i=e=>{let t=o(e);t&&r(e=>e.filter(e=>s(e)!==t))};return e.on(t.create,n),e.on(t.update,l),e.on(t.delete,i),()=>{e.off(t.create,n),e.off(t.update,l),e.off(t.delete,i)}},[e,t.create,t.update,t.delete,s,r,a])}function a(e){let{socket:t,events:r=[],onRefresh:o,intervalMs:s,enabled:a=!0,debounceMs:l}=e;(0,n.useEffect)(()=>{if(!a||!t||0===r.length)return;let e=null,n=()=>{if(!l||l<=0){o();return}e&&clearTimeout(e),e=setTimeout(()=>{e=null,o()},l)};return r.forEach(e=>t.on(e,n)),()=>{e&&clearTimeout(e),r.forEach(e=>t.off(e,n))}},[a,t,r,o,l]),(0,n.useEffect)(()=>{if(!a||!s)return;let e=setInterval(o,s);return()=>clearInterval(e)},[a,s,o])}}},function(e){e.O(0,[5015,7717,7698,742,3211,7993,8651,2646,6207,7213,1721,9,5616,8589,5496,3834,8640,6931,19,8056,9763,3410,1713,2297,3180,4191,2971,2117,1744],function(){return e(e.s=62121)}),_N_E=e.O()}]);