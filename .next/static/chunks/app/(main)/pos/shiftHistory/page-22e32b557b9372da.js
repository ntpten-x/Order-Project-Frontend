(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7068],{48359:function(e,t,l){Promise.resolve().then(l.bind(l,10654))},10654:function(e,t,l){"use strict";l.r(t),l.d(t,{default:function(){return X}});var i,s,n=l(57437),a=l(2265),r=l(29827),d=l(11713),o=l(60283),c=l(7408),u=l(80009),x=l(50742),f=l(24783),h=l(88589),p=l(24738),y=l(48651),j=l(62297),m=l(53743),g=l(96931),v=l(84588),b=l(89245),_=l(5540),S=l(95159),C=l(29332),Z=l(29436),O=l(71096),E=l.n(O),z=l(13257),k=l.n(z);l(6729);var w=l(99376),D=l(24675),N=l(67918),I=l(59226);(i=s||(s={})).OPEN="OPEN",i.CLOSED="CLOSED";var T=l(12028),L=l(2938),H=l(25193),P=l(37410),Y=l(27623),M=l(20148),R=l(2786),q=l(69397);let W={...(0,q.yf)("linear-gradient(135deg, #0284c7 0%, #0369a1 100%)"),shiftCard:q.YO,shiftCardInner:q.lv},B=(0,q.IU)(".shift-history-page",".shift-history-card");E().extend(k()),E().locale("th");let{Text:F,Title:V}=o.default,{RangePicker:A}=c.default;function K(e){return Number(e||0)}function Q(e){return"฿".concat(K(e).toLocaleString("th-TH"))}function U(e){if(!e)return"-";let t=E()(e);return t.isValid()?t.format("DD/MM/YYYY HH:mm"):"-"}function G(e){var t,l;let{shift:i,onViewSummary:a}=e,r=i.status===s.CLOSED;return(0,n.jsx)("div",{className:"shift-history-card",style:{...W.shiftCard(!0),borderRadius:16,marginBottom:12},children:(0,n.jsxs)("div",{style:{...W.shiftCardInner,alignItems:"flex-start"},children:[(0,n.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6,flexWrap:"wrap"},children:[(0,n.jsxs)(F,{strong:!0,style:{fontSize:15,color:"#0f172a"},children:["Shift #",i.id.slice(0,8)]}),(0,n.jsx)(u.Z,{color:r?"default":"green",children:r?"ปิดกะแล้ว":"กำลังเปิดกะ"})]}),(0,n.jsxs)(F,{type:"secondary",style:{display:"block",fontSize:13},children:["ผู้เปิดกะ: ",(null===(t=i.user)||void 0===t?void 0:t.name)||(null===(l=i.user)||void 0===l?void 0:l.username)||"-"]}),(0,n.jsxs)(F,{type:"secondary",style:{display:"block",fontSize:13},children:["เปิดกะ: ",U(i.open_time)," | ปิดกะ: ",U(i.close_time)]}),(0,n.jsxs)(F,{type:"secondary",style:{display:"block",fontSize:12,marginTop:2},children:["ระยะเวลากะ: ",function(e,t){let l=E()(e),i=t?E()(t):E()();if(!l.isValid()||!i.isValid())return"-";let s=E().duration(i.diff(l)),n=Math.floor(s.asHours()),a=s.minutes();return"".concat(n," ชม. ").concat(a," นาที")}(i.open_time,i.close_time)]}),(0,n.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",gap:8,marginTop:10},children:[(0,n.jsx)(J,{label:"เงินเริ่มต้น",value:Q(i.start_amount),color:"#334155"}),(0,n.jsx)(J,{label:"ยอดคาดหวัง",value:Q(i.expected_amount),color:"#0369a1"}),(0,n.jsx)(J,{label:"ยอดนับจริง",value:Q(i.end_amount),color:"#0f766e"}),(0,n.jsx)(J,{label:"ผลต่าง",value:Q(i.diff_amount),color:K(i.diff_amount)>=0?"#059669":"#dc2626"})]})]}),(0,n.jsx)(x.ZP,{onClick:()=>a(i.id),children:"ดูสรุปกะ"})]})})}function J(e){let{label:t,value:l,color:i}=e;return(0,n.jsxs)("div",{style:{border:"1px solid #e2e8f0",borderRadius:10,padding:"8px 10px"},children:[(0,n.jsx)(F,{type:"secondary",style:{fontSize:12},children:t}),(0,n.jsx)("div",{style:{fontWeight:700,color:i,marginTop:2},children:l})]})}function X(){let e=(0,w.useRouter)(),t=(0,r.NL)(),{socket:l}=(0,D.s)(),{isAuthorized:i,isChecking:o}=(0,N.e)({allowedRoles:["Admin","Manager","Employee"]}),[c,O]=(0,a.useState)(1),[E,z]=(0,a.useState)(10),[k,q]=(0,a.useState)(""),[V,U]=(0,a.useState)("all"),[J,X]=(0,a.useState)(null),[el,ei]=(0,a.useState)(null),es=(0,a.useMemo)(()=>(null==J?void 0:J[0])?J[0].startOf("day").toISOString():void 0,[J]),en=(0,a.useMemo)(()=>(null==J?void 0:J[1])?J[1].endOf("day").toISOString():void 0,[J]),ea=(0,d.a)({queryKey:["shiftHistory",c,E,k,V,es,en],queryFn:async()=>I.t.getHistory({page:c,limit:E,q:k.trim()||void 0,status:"all"===V?void 0:V,date_from:es,date_to:en}),placeholderData:e=>e,enabled:i,staleTime:15e3}),er=(0,d.a)({queryKey:["shiftSummaryById",el],queryFn:async()=>el?await I.t.getSummary(el):null,enabled:!!el,staleTime:1e4});(0,a.useEffect)(()=>{if(!l)return;let e=()=>{t.invalidateQueries({queryKey:["shiftHistory"]})};return l.on(T.b.shifts.update,e),()=>{l.off(T.b.shifts.update,e)}},[l,t]);let ed=ea.data,eo=(null==ed?void 0:ed.data)||[],ec=null==ed?void 0:ed.pagination,eu=null==ed?void 0:ed.stats,ex=(null==eu?void 0:eu.open)||0,ef=(null==eu?void 0:eu.closed)||0,eh=(null==eu?void 0:eu.total)||0;return o?(0,n.jsx)(L.H,{message:"กำลังตรวจสอบสิทธิ์การใช้งาน..."}):i?(0,n.jsxs)("div",{className:"shift-history-page",style:W.container,children:[(0,n.jsx)("style",{children:B}),(0,n.jsx)(M.Z,{title:"ประวัติกะการทำงาน",subtitle:"ทั้งหมด ".concat(eh," กะ"),icon:(0,n.jsx)(v.Z,{}),onBack:()=>e.back(),actions:(0,n.jsxs)(f.Z,{size:8,children:[(0,n.jsx)(x.ZP,{icon:(0,n.jsx)(b.Z,{}),onClick:()=>ea.refetch(),loading:ea.isFetching}),(0,n.jsx)(x.ZP,{icon:(0,n.jsx)(_.Z,{}),onClick:()=>e.push("/pos/shift"),children:"ไปหน้ากะปัจจุบัน"})]})}),(0,n.jsx)(H.Z,{children:(0,n.jsxs)(Y.Z,{children:[(0,n.jsx)(P.Z,{title:"ภาพรวม",children:(0,n.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:10},children:[(0,n.jsx)($,{label:"จำนวนกะทั้งหมด",value:String(eh),color:"#0f172a",icon:(0,n.jsx)(_.Z,{})}),(0,n.jsx)($,{label:"กะที่เปิดอยู่",value:String(ex),color:"#059669",icon:(0,n.jsx)(u.Z,{color:"green",children:"OPEN"})}),(0,n.jsx)($,{label:"กะที่ปิดแล้ว",value:String(ef),color:"#64748b",icon:(0,n.jsx)(u.Z,{children:"CLOSED"})}),(0,n.jsx)($,{label:"รวมเงินเริ่มต้น",value:Q(null==eu?void 0:eu.total_start_amount),color:"#0369a1",icon:(0,n.jsx)(S.Z,{})}),(0,n.jsx)($,{label:"รวมยอดนับจริง",value:Q(null==eu?void 0:eu.total_end_amount),color:"#0f766e",icon:(0,n.jsx)(et,{})}),(0,n.jsx)($,{label:"รวมผลต่าง",value:Q(null==eu?void 0:eu.total_diff_amount),color:K(null==eu?void 0:eu.total_diff_amount)>=0?"#059669":"#dc2626",icon:(0,n.jsx)(C.Z,{})})]})}),(0,n.jsx)(P.Z,{title:"ค้นหาและตัวกรอง",children:(0,n.jsxs)("div",{style:{display:"grid",gap:10},children:[(0,n.jsx)(h.default,{allowClear:!0,prefix:(0,n.jsx)(Z.Z,{style:{color:"#94A3B8"}}),placeholder:"ค้นหาจาก Shift ID, username หรือชื่อผู้เปิดกะ",value:k,onChange:e=>{O(1),q(e.target.value)}}),(0,n.jsx)(p.Z,{value:V,onChange:e=>{O(1),U(e)},options:[{label:"ทั้งหมด (".concat(eh,")"),value:"all"},{label:"OPEN (".concat(ex,")"),value:s.OPEN},{label:"CLOSED (".concat(ef,")"),value:s.CLOSED}]}),(0,n.jsx)(A,{value:J,onChange:e=>{O(1),X(e)},format:"DD/MM/YYYY",allowClear:!0,style:{width:"100%"},placeholder:["วันที่เริ่มต้น","วันที่สิ้นสุด"]})]})}),(0,n.jsx)(P.Z,{title:"รายการประวัติกะ",extra:(0,n.jsx)("span",{style:{fontWeight:600},children:eo.length}),children:ea.isLoading?(0,n.jsx)("div",{style:{display:"flex",justifyContent:"center",padding:"48px 0"},children:(0,n.jsx)(y.Z,{size:"large"})}):eo.length>0?(0,n.jsxs)(n.Fragment,{children:[eo.map(e=>(0,n.jsx)(G,{shift:e,onViewSummary:ei},e.id)),(0,n.jsx)("div",{style:{display:"flex",justifyContent:"center",marginTop:16},children:(0,n.jsx)(j.Z,{current:(null==ec?void 0:ec.page)||c,pageSize:(null==ec?void 0:ec.limit)||E,total:(null==ec?void 0:ec.total)||0,showSizeChanger:!0,onChange:(e,t)=>{O(e),z(t)}})})]}):(0,n.jsx)(R.Z,{title:"ไม่พบข้อมูลประวัติกะ",description:"ลองปรับคำค้นหา หรือตัวกรองช่วงวันที่"})})]})}),(0,n.jsx)(m.Z,{open:!!el,title:"สรุปข้อมูลกะ",onCancel:()=>ei(null),footer:null,width:760,children:er.isLoading?(0,n.jsx)("div",{style:{padding:"40px 0",textAlign:"center"},children:(0,n.jsx)(y.Z,{})}):er.data?(0,n.jsxs)("div",{style:{display:"grid",gap:12},children:[(0,n.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:10},children:[(0,n.jsx)(ee,{label:"ยอดขายรวม",value:Q(er.data.summary.total_sales),color:"#10b981"}),(0,n.jsx)(ee,{label:"กำไรสุทธิ",value:Q(er.data.summary.net_profit),color:"#0369a1"}),(0,n.jsx)(ee,{label:"เงินเริ่มต้น",value:Q(er.data.shift_info.start_amount),color:"#334155"}),(0,n.jsx)(ee,{label:"ผลต่าง",value:Q(er.data.shift_info.diff_amount),color:K(er.data.shift_info.diff_amount)>=0?"#059669":"#dc2626"})]}),(0,n.jsx)(g.Z,{size:"small",title:"วิธีชำระเงิน",children:(0,n.jsx)("div",{style:{display:"grid",gap:8,gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))"},children:Object.entries(er.data.summary.payment_methods||{}).map(e=>{let[t,l]=e;return(0,n.jsxs)("div",{style:{border:"1px solid #e2e8f0",borderRadius:10,padding:"8px 10px"},children:[(0,n.jsx)(F,{type:"secondary",children:t}),(0,n.jsx)("div",{style:{fontWeight:700},children:Q(l)})]},t)})})}),(0,n.jsx)(g.Z,{size:"small",title:"สินค้าขายดี",children:er.data.top_products.length>0?(0,n.jsx)("div",{style:{display:"grid",gap:8},children:er.data.top_products.map((e,t)=>(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",border:"1px solid #e2e8f0",borderRadius:10,padding:"8px 10px"},children:[(0,n.jsxs)(F,{strong:!0,children:[t+1,". ",e.name]}),(0,n.jsxs)(F,{children:[e.quantity," ",e.unit||"หน่วย"," | ",Q(e.revenue)]})]},"".concat(e.id,"-").concat(t)))}):(0,n.jsx)(F,{type:"secondary",children:"ไม่พบข้อมูลสินค้าขายดี"})})]}):(0,n.jsx)(F,{type:"secondary",children:"ไม่พบข้อมูลสรุปกะ"})})]}):(0,n.jsx)(L.H,{message:"คุณไม่มีสิทธิ์เข้าถึงหน้านี้",tone:"danger"})}function $(e){let{label:t,value:l,color:i,icon:s}=e;return(0,n.jsxs)(g.Z,{size:"small",style:{borderRadius:12},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,n.jsx)("span",{style:{color:i},children:s}),(0,n.jsx)(F,{type:"secondary",children:t})]}),(0,n.jsx)(V,{level:4,style:{margin:"8px 0 0",color:i},children:l})]})}function ee(e){let{label:t,value:l,color:i}=e;return(0,n.jsxs)("div",{style:{border:"1px solid #e2e8f0",borderRadius:10,padding:"10px 12px"},children:[(0,n.jsx)(F,{type:"secondary",children:t}),(0,n.jsx)("div",{style:{fontSize:20,fontWeight:700,color:i},children:l})]})}function et(){return(0,n.jsx)(S.Z,{})}}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=48359)}),_N_E=e.O()}]);