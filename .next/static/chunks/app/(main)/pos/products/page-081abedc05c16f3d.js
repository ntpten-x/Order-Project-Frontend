(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3843],{50304:function(e,t,i){Promise.resolve().then(i.bind(i,92837))},92837:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return $}});var a=i(57437),n=i(2265),s=i(60283),r=i(80009),l=i(24783),o=i(66487),c=i(50742),d=i(34029),p=i(53743),u=i(61778),h=i(88589),g=i(24738),y=i(93834),m=i(33145),f=i(62376),x=i(13377),j=i(26349),v=i(89245),b=i(96473),w=i(29436),Z=i(99376),_=i(3369),k=i(26972),C=i(24675),S=i(97235),E=i(67918),F=i(67697),P=i(73814),R=i(69397);let T={...(0,R.yf)("linear-gradient(135deg, #4F46E5 0%, #4338CA 100%)"),productCard:R.YO,productCardInner:R.lv},z="\n  ".concat((0,R.IU)(".products-page",".product-card"),"\n\n  @media (max-width: 576px) {\n    .products-header-content {\n      flex-direction: column !important;\n      align-items: stretch !important;\n      gap: 16px !important;\n    }\n    \n    .products-header-left {\n      width: 100%;\n    }\n\n    .products-header-actions {\n      width: 100%;\n      display: flex;\n      gap: 8px;\n    }\n\n    .products-search-input {\n      width: 100% !important;\n      flex: 1;\n    }\n\n    .products-add-btn-text {\n      display: none;\n    }\n    \n    .ant-empty-description {\n        padding: 0 20px;\n    }\n\n    .product-card-inner {\n        padding: 12px !important;\n        gap: 10px !important;\n    }\n  }\n");var A=i(79657),N=i(11713),I=i(2913),U=i(98170);let L=async(e,t)=>{let i=(0,I.b)("GET","/pos/productsUnit");t&&(i+="?".concat(t.toString()));let a={};e&&(a.Cookie=e);let n=await fetch(i,{cache:"no-store",credentials:"include",headers:a});if(!n.ok){var s;let e=await n.json().catch(()=>({}));throw Error((null==e?void 0:null===(s=e.error)||void 0===s?void 0:s.message)||e.error||e.message||"Failed to fetch products units")}return(0,U.hH)(await n.json())},M="pos:products-units";var O=i(67338);function W(e,t){let i=e.length>0,a=t.length>0;return{hasCategories:i,hasUnits:a,isReady:i&&a,missingFields:[!i&&"หมวดหมู่สินค้า",!a&&"หน่วยสินค้า"].filter(Boolean)}}function D(e,t){let i=W(e,t);return i.isReady?"":"กรุณาเพิ่ม".concat(i.missingFields.join("และ"),"ให้เรียบร้อยก่อนใช้งาน")}var q=i(12028),B=i(2938),H=i(25193),J=i(37410),X=i(27623),G=i(20148),K=i(2786);let{Text:Y}=s.default,Q=e=>{let{total:t,active:i,inactive:n}=e;return(0,a.jsxs)("div",{style:{background:"#fff",borderRadius:16,border:"1px solid #e2e8f0",display:"grid",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",gap:8,padding:14},children:[(0,a.jsxs)("div",{style:{textAlign:"center"},children:[(0,a.jsx)("span",{style:{fontSize:24,fontWeight:700,color:"#0f172a",display:"block"},children:t}),(0,a.jsx)(Y,{style:{fontSize:12,color:"#64748b"},children:"ทั้งหมด"})]}),(0,a.jsxs)("div",{style:{textAlign:"center"},children:[(0,a.jsx)("span",{style:{fontSize:24,fontWeight:700,color:"#0f766e",display:"block"},children:i}),(0,a.jsx)(Y,{style:{fontSize:12,color:"#64748b"},children:"ใช้งาน"})]}),(0,a.jsxs)("div",{style:{textAlign:"center"},children:[(0,a.jsx)("span",{style:{fontSize:24,fontWeight:700,color:"#b91c1c",display:"block"},children:n}),(0,a.jsx)(Y,{style:{fontSize:12,color:"#64748b"},children:"ปิดใช้งาน"})]})]})},V=e=>{var t,i,n,s,d;let{product:p,onEdit:u,onDelete:h,onToggleActive:g,updatingStatusId:y}=e;return(0,a.jsx)("div",{className:"product-card",style:{...T.productCard(p.is_active),borderRadius:16},onClick:()=>u(p),children:(0,a.jsxs)("div",{className:"product-card-inner",style:T.productCardInner,children:[(0,a.jsx)("div",{style:{width:64,height:64,borderRadius:14,border:"1px solid #F1F5F9",overflow:"hidden",position:"relative",background:"#F8FAFC",flexShrink:0},children:p.img_url?(0,a.jsx)(m.default,{src:p.img_url,alt:p.display_name||p.product_name,fill:!0,style:{objectFit:"cover"},sizes:"64px"}):(0,a.jsx)("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%)"},children:(0,a.jsx)(f.Z,{style:{fontSize:20,color:"#4F46E5"}})})}),(0,a.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[(0,a.jsx)(Y,{strong:!0,style:{fontSize:16,color:"#0f172a"},ellipsis:{tooltip:p.display_name},children:p.display_name}),(0,a.jsx)(r.Z,{color:p.is_active?"green":"default",children:p.is_active?"ใช้งาน":"ปิดใช้งาน"})]}),(0,a.jsx)(Y,{type:"secondary",style:{display:"block",marginBottom:6},ellipsis:{tooltip:p.product_name},children:p.product_name}),(0,a.jsxs)(l.Z,{size:6,wrap:!0,children:[(0,a.jsx)(r.Z,{style:{margin:0,border:"none",background:"#ecfdf5",color:"#047857"},children:(0,O.T4)(Number(p.price||0))}),Number(null!==(n=null!==(i=p.price_delivery)&&void 0!==i?i:p.price)&&void 0!==n?n:0)!==Number(null!==(s=p.price)&&void 0!==s?s:0)?(0,a.jsxs)(r.Z,{style:{margin:0,border:"none",background:"#fdf2f8",color:"#be185d"},children:["Delivery ",(0,O.T4)(Number(null!==(d=p.price_delivery)&&void 0!==d?d:0))]}):null,(null===(t=p.category)||void 0===t?void 0:t.display_name)?(0,a.jsx)(r.Z,{style:{margin:0,border:"none",background:"#eff6ff",color:"#1d4ed8"},children:p.category.display_name}):null]})]}),(0,a.jsxs)("div",{style:{display:"flex",gap:6,alignItems:"center"},children:[(0,a.jsx)(o.Z,{size:"small",checked:p.is_active,loading:y===p.id,onClick:(e,t)=>{null==t||t.stopPropagation(),g(p,e)}}),(0,a.jsx)(c.ZP,{type:"text",icon:(0,a.jsx)(x.Z,{}),onClick:e=>{e.stopPropagation(),u(p)},style:{borderRadius:10,color:"#4F46E5",background:"#EEF2FF",width:36,height:36}}),(0,a.jsx)(c.ZP,{type:"text",danger:!0,icon:(0,a.jsx)(j.Z,{}),onClick:e=>{e.stopPropagation(),h(p)},style:{borderRadius:10,background:"#fef2f2",width:36,height:36}})]})]})})};function $(){let e=(0,Z.useRouter)(),[t,i]=(0,n.useState)([]),[s,r]=(0,n.useState)(0),[o,m]=(0,n.useState)(null),[x,R]=(0,n.useState)(1),[I,U]=(0,n.useState)(1),[O,$]=(0,n.useState)(!1),[ee,et]=(0,n.useState)(""),[ei,ea]=(0,n.useState)("all"),[en,es]=(0,n.useState)("all"),[er,el]=(0,n.useState)(null),{execute:eo}=(0,k.J)(),{showLoading:ec}=(0,_.x)(),{socket:ed}=(0,C.s)(),{isAuthorized:ep,isChecking:eu}=(0,E.e)({allowedRoles:["Admin","Manager"]}),{data:eh=[],isLoading:eg}=(0,A.L)(),{data:ey=[],isLoading:em}=(0,N.a)({queryKey:["products-units"],queryFn:async()=>{let e=await L();return(null==e?void 0:e.length)&&(0,P.v)(M,e),e},initialData:()=>(0,P.t)(M,3e5)||void 0,staleTime:3e5,refetchOnWindowFocus:!1,retry:1}),ef=(0,n.useMemo)(()=>W(eh,ey),[eh,ey]);(0,n.useEffect)(()=>{(0,S.P)()},[]),(0,n.useEffect)(()=>{let e=(0,P.t)("pos:products:v3",6e5);(null==e?void 0:e.items)&&(i(e.items),r(e.total||e.items.length),R(e.page||1),U(e.last_page||1),m("number"==typeof e.active_total?e.active_total:null))},[]);let ex=(0,n.useCallback)(async()=>{eo(async()=>{let e=new URLSearchParams;e.set("page","1"),e.set("limit","50"),ee.trim()&&e.set("q",ee.trim()),"active"===ei&&e.set("is_active","true"),"inactive"===ei&&e.set("is_active","false"),"all"!==en&&e.set("category_id",en);let t=new URLSearchParams;t.set("page","1"),t.set("limit","1"),t.set("is_active","true"),"all"!==en&&t.set("category_id",en);let[a,n]=await Promise.all([fetch("/api/pos/products?".concat(e.toString())),fetch("/api/pos/products?".concat(t.toString()))]);if(!a.ok){let e=await a.json().catch(()=>({}));throw Error(e.error||e.message||"ไม่สามารถดึงข้อมูลสินค้าได้")}if(!n.ok){let e=await n.json().catch(()=>({}));throw Error(e.error||e.message||"ไม่สามารถดึงจำนวนสินค้าได้")}let s=await a.json(),l=await n.json(),o=Array.isArray(s.data)?s.data:[],c="number"==typeof s.total?s.total:o.length,d="number"==typeof s.page?s.page:1,p="number"==typeof s.last_page?s.last_page:1,u="number"==typeof l.total?l.total:null;i(o),r(c),R(d),U(p),m(u),ee.trim()||"all"!==ei||"all"!==en||(0,P.v)("pos:products:v3",{items:o,total:c,page:d,last_page:p,active_total:null!=u?u:void 0})},"กำลังโหลดข้อมูลสินค้า...")},[eo,ee,ei,en]);(0,n.useEffect)(()=>{if(!ep)return;let e=setTimeout(()=>{ex()},300);return()=>clearTimeout(e)},[ep,ex]),(0,F.D)({socket:ed,events:[q.b.products.create,q.b.products.update,q.b.products.delete],onRefresh:ex,enabled:ep,debounceMs:400}),(0,F.v)(ed,{create:q.b.categories.create,update:q.b.categories.update,delete:q.b.categories.delete},()=>ex());let ej=(0,n.useCallback)(async()=>{if(!O&&!(x>=I)){$(!0);try{let e=x+1,t=new URLSearchParams;t.set("page",e.toString()),t.set("limit","50"),ee.trim()&&t.set("q",ee.trim()),"active"===ei&&t.set("is_active","true"),"inactive"===ei&&t.set("is_active","false"),"all"!==en&&t.set("category_id",en);let a=await fetch("/api/pos/products?".concat(t.toString()));if(!a.ok){let e=await a.json().catch(()=>({}));throw Error(e.error||e.message||"โหลดข้อมูลเพิ่มไม่สำเร็จ")}let n=await a.json(),l=Array.isArray(n.data)?n.data:[],o="number"==typeof n.total?n.total:s,c="number"==typeof n.page?n.page:e,d="number"==typeof n.last_page?n.last_page:I;i(e=>{let t=new Map(e.map(e=>[e.id,e]));return l.forEach(e=>t.set(e.id,e)),Array.from(t.values())}),r(o),R(c),U(d)}catch(e){d.ZP.error(e instanceof Error?e.message:"โหลดข้อมูลเพิ่มไม่สำเร็จ")}finally{$(!1)}}},[O,x,I,ee,ei,en,s]),ev=()=>{ec("กำลังเปิดหน้าจัดการสินค้า..."),e.push("/pos/products/manage/add")},eb=t=>{ec("กำลังเปิดหน้าแก้ไขสินค้า..."),e.push("/pos/products/manage/edit/".concat(t.id))},ew=e=>{p.Z.confirm({title:"ยืนยันการลบสินค้า",content:'คุณต้องการลบสินค้า "'.concat(e.display_name,'" หรือไม่?'),okText:"ลบ",okType:"danger",cancelText:"ยกเลิก",centered:!0,icon:(0,a.jsx)(j.Z,{style:{color:"#EF4444"}}),onOk:async()=>{await eo(async()=>{let t=await (0,S.P)();if(!(await fetch("/api/pos/products/delete/".concat(e.id),{method:"DELETE",headers:{"X-CSRF-Token":t}})).ok)throw Error("ไม่สามารถลบสินค้าได้");i(t=>t.filter(t=>t.id!==e.id)),r(e=>Math.max(e-1,0)),d.ZP.success('ลบสินค้า "'.concat(e.display_name,'" สำเร็จ'))},"กำลังลบสินค้า...")}})},eZ=async(e,t)=>{el(e.id);try{let a=await (0,S.P)(),n=await fetch("/api/pos/products/update/".concat(e.id),{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":a},body:JSON.stringify({is_active:t})});if(!n.ok){let e=await n.json().catch(()=>({}));throw Error(e.error||e.message||"ไม่สามารถเปลี่ยนสถานะสินค้าได้")}let s=await n.json();i(t=>t.map(t=>t.id===e.id?s:t)),d.ZP.success(t?"เปิดใช้งานสินค้าแล้ว":"ปิดใช้งานสินค้าแล้ว")}catch(e){console.error(e),d.ZP.error(e instanceof Error?e.message:"ไม่สามารถเปลี่ยนสถานะสินค้าได้")}finally{el(null)}};if(eu)return(0,a.jsx)(B.H,{message:"กำลังตรวจสอบสิทธิ์การใช้งาน..."});if(!ep)return(0,a.jsx)(B.H,{message:"คุณไม่มีสิทธิ์เข้าถึงหน้านี้ กำลังพากลับ...",tone:"danger"});let e_=null!=o?o:t.filter(e=>e.is_active).length,ek=Math.max((s||t.length)-e_,0),eC=eg||em;return eC||ef.isReady||0!==t.length?(0,a.jsxs)("div",{className:"products-page",style:T.container,children:[(0,a.jsx)("style",{children:z}),(0,a.jsx)(G.Z,{title:"สินค้า",subtitle:"ทั้งหมด ".concat(s||t.length," รายการ"),icon:(0,a.jsx)(f.Z,{}),actions:(0,a.jsxs)(l.Z,{size:8,wrap:!0,children:[(0,a.jsx)(c.ZP,{icon:(0,a.jsx)(v.Z,{}),onClick:ex}),(0,a.jsx)(c.ZP,{type:"primary",icon:(0,a.jsx)(b.Z,{}),onClick:ev,disabled:!ef.isReady,children:"เพิ่มสินค้า"})]})}),(0,a.jsx)(H.Z,{children:(0,a.jsxs)(X.Z,{children:[eC||ef.isReady||!(t.length>0)?null:(0,a.jsx)(J.Z,{title:"ต้องตั้งค่าก่อนเพิ่มสินค้า",children:(0,a.jsx)(u.Z,{message:"ข้อมูลอ้างอิงยังไม่ครบ",description:D(eh,ey),type:"warning",showIcon:!0})}),(0,a.jsx)(Q,{total:s||t.length,active:e_,inactive:ek}),(0,a.jsx)(J.Z,{title:"ค้นหาและตัวกรอง",children:(0,a.jsxs)("div",{style:{display:"grid",gap:10,gridTemplateColumns:"1fr"},children:[(0,a.jsx)(h.default,{prefix:(0,a.jsx)(w.Z,{style:{color:"#94A3B8"}}),allowClear:!0,placeholder:"ค้นหาจากชื่อสินค้า ชื่อแสดง หรือคำค้นอื่น...",value:ee,onChange:e=>et(e.target.value)}),(0,a.jsx)(g.Z,{options:[{label:"ทั้งหมด",value:"all"},{label:"ใช้งาน",value:"active"},{label:"ปิดใช้งาน",value:"inactive"}],value:ei,onChange:e=>ea(e)}),(0,a.jsx)(y.default,{value:en,onChange:es,options:[{value:"all",label:"ทุกหมวดหมู่"},...eh.map(e=>({value:e.id,label:e.display_name}))],placeholder:"กรองตามหมวดหมู่"})]})}),(0,a.jsx)(J.Z,{title:"รายการสินค้า",extra:(0,a.jsx)("span",{style:{fontWeight:600},children:t.length}),children:t.length>0?(0,a.jsxs)(a.Fragment,{children:[t.map(e=>(0,a.jsx)(V,{product:e,onEdit:eb,onDelete:ew,onToggleActive:eZ,updatingStatusId:er},e.id)),(0,a.jsx)("div",{style:{display:"flex",justifyContent:"center",paddingTop:12},children:x<I?(0,a.jsx)(c.ZP,{onClick:ej,loading:O,style:{borderRadius:12},children:"โหลดเพิ่ม"}):(0,a.jsx)(Y,{type:"secondary",style:{fontSize:12},children:"ไม่มีข้อมูลเพิ่มเติม"})})]}):(0,a.jsx)(K.Z,{title:ee.trim()?"ไม่พบสินค้าตามคำค้น":"ยังไม่มีสินค้า",description:ee.trim()?"ลองเปลี่ยนคำค้น หรือตัวกรอง":"เพิ่มสินค้าแรกเพื่อเริ่มใช้งาน",action:ee.trim()?null:(0,a.jsx)(c.ZP,{type:"primary",icon:(0,a.jsx)(b.Z,{}),onClick:ev,disabled:!ef.isReady,children:"เพิ่มสินค้า"})})})]})})]}):(0,a.jsxs)("div",{className:"products-page",style:T.container,children:[(0,a.jsx)("style",{children:z}),(0,a.jsx)(G.Z,{title:"สินค้า",subtitle:"ตั้งค่าระบบก่อนเพิ่มสินค้า",icon:(0,a.jsx)(f.Z,{}),actions:(0,a.jsxs)(l.Z,{size:8,wrap:!0,children:[(0,a.jsx)(c.ZP,{icon:(0,a.jsx)(v.Z,{}),onClick:ex}),(0,a.jsx)(c.ZP,{type:"primary",icon:(0,a.jsx)(b.Z,{}),disabled:!0,children:"เพิ่มสินค้า"})]})}),(0,a.jsx)(H.Z,{children:(0,a.jsx)(X.Z,{children:(0,a.jsx)(K.Z,{title:"ยังไม่พร้อมเพิ่มสินค้า",description:D(eh,ey),action:(0,a.jsxs)(l.Z,{size:10,wrap:!0,children:[ef.hasCategories?null:(0,a.jsx)(c.ZP,{type:"primary",onClick:()=>e.push("/pos/category"),children:"เพิ่มหมวดหมู่"}),ef.hasUnits?null:(0,a.jsx)(c.ZP,{type:"primary",onClick:()=>e.push("/pos/productsUnit"),children:"เพิ่มหน่วยสินค้า"})]})})})})]})}}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=50304)}),_N_E=e.O()}]);