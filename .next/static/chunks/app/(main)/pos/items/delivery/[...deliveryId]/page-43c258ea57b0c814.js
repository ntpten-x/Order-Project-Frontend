(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9110],{16923:function(e,t,s){Promise.resolve().then(s.bind(s,76732))},76732:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return q}});var i=s(57437),n=s(29),l=s.n(n),r=s(2265),d=s(99376),o=s(19683),a=s(34029),c=s(80009),y=s(85180),x=s(50742),p=s(47451),u=s(69410),h=s(96931),f=s(91652),j=s(23496),g=s(24783),m=s(61778),v=s(17588),b=s(67605),Z=s(13377),k=s(62376),w=s(83669),_=s(15424),S=s(53286),C=s(63836),T=s(54528),W=s(97235),B=s(32446),P=s(94532),z=s(45963),I=s(49747),O=s(71096),R=s.n(O);s(6729);var D=s(61414),N=s(60300),A=s(3369),E=s(24675),G=s(67697);let{Title:F,Text:H}=o.default;function q(){var e,t,s;let n=(0,d.useRouter)(),o=(0,d.useParams)(),[O,R]=a.ZP.useMessage(),q=Array.isArray(null==o?void 0:o.deliveryId)?o.deliveryId[0]:null==o?void 0:o.deliveryId,[L,M]=(0,r.useState)(null),[Q,Y]=(0,r.useState)(!0),[U,V]=(0,r.useState)(!0),{showLoading:$,hideLoading:J}=(0,A.x)(),{socket:K}=(0,E.s)(),[X,ee]=(0,r.useState)({open:!1,type:"confirm",title:"",content:"",onOk:()=>{}}),et=()=>ee(e=>({...e,open:!1})),es=(0,r.useCallback)(async()=>{if(q)try{Y(!0),$("กำลังโหลดข้อมูลออเดอร์...");let[e,t]=await Promise.all([S.x.getById(q),C.E.getByName("Delivery").catch(()=>null)]);if(e.status!==B.i.WaitingForPayment){n.push("/pos/channels");return}if(e.order_type!==B.m.Delivery){O.warning("รายการนี้ไม่ใช่ Order Delivery"),n.push("/pos/channels");return}M(e),V(!!t)}catch(e){O.error("ไม่สามารถโหลดข้อมูลออเดอร์ได้")}finally{Y(!1),J()}},[q,O,n,$,J]);(0,r.useEffect)(()=>{q&&es()},[es,q]),(0,G.D)({socket:K,events:["orders:update","orders:delete","payments:create","payments:update"],onRefresh:()=>{q&&es()},intervalMs:15e3,enabled:!!q});let{subtotal:ei,discount:en,vat:el,total:er}=(0,I.hs)(L,Number((null==L?void 0:L.total_amount)||0)),ed=async()=>{var e;L&&ee({open:!0,type:"confirm",title:"ยืนยันการส่งมอบสินค้า",content:(0,i.jsxs)("div",{style:{textAlign:"center"},children:[(0,i.jsxs)("div",{style:{fontSize:16,marginBottom:12},children:["คุณกำลังจะส่งมอบสินค้าให้ไรเดอร์สำหรับออเดอร์ ",(0,i.jsxs)(H,{strong:!0,children:["#",L.order_no]})]}),(0,i.jsxs)(c.Z,{color:"blue",style:{fontSize:14,padding:"4px 12px"},children:[null===(e=L.delivery)||void 0===e?void 0:e.delivery_name," ",L.delivery_code?"(".concat(L.delivery_code,")"):""]})]}),okText:"ยืนยันส่งมอบ",cancelText:"ยกเลิก",onOk:async()=>{try{$("กำลังดำเนินการส่งมอบ..."),et();let e=await (0,W.P)(),t=await C.E.getByName("Delivery"),s={order_id:L.id,payment_method_id:null==t?void 0:t.id,amount:er,amount_received:er,change_amount:0,status:P.b.Success};await T.U.create(s,void 0,e),O.success("ส่งมอบสินค้าให้ไรเดอร์เรียบร้อย"),n.push("/pos/dashboard/".concat(L.id))}catch(e){O.error("เกิดข้อผิดพลาดในการส่งมอบ")}finally{J()}}})},eo=async()=>{L&&ee({open:!0,type:"warning",title:"ย้อนกลับไปแก้ไขออเดอร์?",content:'สถานะออเดอร์จะถูกเปลี่ยนกลับเป็น "กำลังดำเนินการ" เพื่อให้คุณสามารถแก้ไขรายการอาหารได้ คุณแน่ใจหรือไม่?',okText:"ตกลง",cancelText:"ยกเลิก",onOk:async()=>{try{var e;$("กำลังดำเนินการ..."),et();let t=await (0,W.P)(),s=(null===(e=L.items)||void 0===e?void 0:e.filter(e=>e.status!==B.i.Cancelled))||[];await Promise.all(s.map(e=>S.x.updateItemStatus(e.id,B.i.Served,void 0,t))),await S.x.updateStatus(L.id,B.i.Pending,t),O.success("ย้อนกลับไปแก้ไขออเดอร์เรียบร้อย"),n.push((0,D.HL)(L.id))}catch(e){O.error("ไม่สามารถเปลี่ยนสถานะออเดอร์ได้")}finally{J()}}})};return Q&&!L?null:L?(0,i.jsxs)("div",{style:z.ZW.container,children:[(0,i.jsx)(l(),{id:z.um.__hash,children:z.um}),R,(0,i.jsx)("div",{style:{...z.ZW.heroSection,background:"linear-gradient(135deg, #eb2f96 0%, #c41d7f 100%)"},className:"payment-hero-mobile",children:(0,i.jsx)("div",{style:z.ZW.contentWrapper,className:"payment-content-mobile",children:(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:16},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"flex-start",gap:16},children:[(0,i.jsx)(x.ZP,{type:"text",icon:(0,i.jsx)(v.Z,{style:{fontSize:20}}),style:{color:"#fff",padding:0,height:"auto",marginTop:4},onClick:()=>n.back()}),(0,i.jsxs)("div",{children:[(0,i.jsx)(F,{level:3,style:z.ZW.pageTitle,children:"สรุปออเดอร์เดลิเวอรี่"}),(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:8,flexWrap:"wrap"},children:[(0,i.jsxs)(c.Z,{color:"magenta",style:{borderRadius:6,border:"none",fontWeight:600},children:[(0,i.jsx)(b.Z,{})," ",(null===(e=L.delivery)||void 0===e?void 0:e.delivery_name)||"Delivery"," ",L.delivery_code?"#".concat(L.delivery_code):""]}),(0,i.jsx)(c.Z,{color:(0,D.OY)(L.status),style:{borderRadius:6,border:"none"},children:(0,D.d7)(L.status)}),(0,i.jsxs)(H,{style:{color:"rgba(255,255,255,0.85)",fontSize:13},children:["#",L.order_no]})]})]})]}),(0,i.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,i.jsx)(x.ZP,{icon:(0,i.jsx)(Z.Z,{}),onClick:eo,style:{background:"rgba(255,255,255,0.2)",border:"none",color:"#fff"},children:"แก้ไขออเดอร์"}),(0,i.jsx)(x.ZP,{danger:!0,onClick:()=>{L&&ee({open:!0,type:"danger",title:"ยืนยันการยกเลิกออเดอร์?",content:"การดำเนินการนี้จะยกเลิกสินค้าทุกรายการ คุณแน่ใจหรือไม่?",okText:"ยืนยันการยกเลิก",cancelText:"ยกเลิก",onOk:async()=>{try{var e;$("กำลังดำเนินการยกเลิก..."),et();let t=await (0,W.P)(),s=(null===(e=L.items)||void 0===e?void 0:e.filter(e=>e.status!==B.i.Cancelled))||[];await Promise.all(s.map(e=>S.x.updateItemStatus(e.id,B.i.Cancelled,void 0,t))),await S.x.updateStatus(L.id,B.i.Cancelled,t),O.success("ยกเลิกออเดอร์เรียบร้อย"),n.push((0,D.d$)(L.order_type))}catch(e){O.error("ไม่สามารถยกเลิกออเดอร์ได้")}finally{J()}}})},children:"ยกเลิกออเดอร์"})]})]})})}),(0,i.jsx)("div",{style:{...z.ZW.contentWrapper,marginTop:-30,paddingBottom:40},children:(0,i.jsxs)(p.Z,{gutter:[24,24],children:[(0,i.jsx)(u.Z,{xs:24,lg:14,children:(0,i.jsxs)(h.Z,{style:z.ZW.card,children:[(0,i.jsx)(F,{level:4,style:{marginBottom:20},children:"รายการอาหาร"}),(0,i.jsx)("div",{style:{overflowY:"auto",paddingRight:8,minHeight:300,maxHeight:600},children:null===(t=L.items)||void 0===t?void 0:t.filter(e=>e.status!==B.i.Cancelled).map((e,t)=>{var s,n;return(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16,paddingBottom:16,borderBottom:"1px solid ".concat(z.QF.borderLight)},children:[(0,i.jsxs)("div",{style:{display:"flex",gap:12,flex:1,minWidth:0},children:[(0,i.jsx)(f.Z,{shape:"square",size:56,src:null===(s=e.product)||void 0===s?void 0:s.img_url,icon:(0,i.jsx)(k.Z,{}),style:{backgroundColor:"#f0f2f5",flexShrink:0,borderRadius:10}}),(0,i.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,i.jsx)(H,{strong:!0,style:{display:"block",fontSize:15},ellipsis:!0,children:null===(n=e.product)||void 0===n?void 0:n.display_name}),(0,i.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:4},children:[(0,i.jsx)(H,{type:"secondary",style:{fontSize:13},children:(0,D.xG)(e.price)}),(0,i.jsxs)(c.Z,{style:{margin:0,fontSize:11,borderRadius:4},children:["x",e.quantity]})]}),e.notes&&(0,i.jsxs)(H,{type:"secondary",style:{display:"block",fontSize:12,fontStyle:"italic",marginTop:4},children:["* ",e.notes]})]})]}),(0,i.jsx)(H,{strong:!0,style:{fontSize:15},children:(0,D.xG)(Number(e.total_price))})]},e.id||t)})}),(0,i.jsxs)("div",{style:{...z.ZW.summaryBox,background:"#f8fafc",borderRadius:16,padding:20},children:[(0,i.jsxs)(p.Z,{justify:"space-between",style:{marginBottom:8},children:[(0,i.jsx)(H,{type:"secondary",children:"ยอดรวม (Subtotal)"}),(0,i.jsx)(H,{children:(0,D.xG)(ei)})]}),en>0&&(0,i.jsxs)(p.Z,{justify:"space-between",style:{marginBottom:8,color:z.QF.success},children:[(0,i.jsx)(H,{type:"success",children:"ส่วนลด (Discount)"}),(0,i.jsxs)(H,{type:"success",children:["-",(0,D.xG)(en)]})]}),el>0&&(0,i.jsxs)(p.Z,{justify:"space-between",style:{marginBottom:8},children:[(0,i.jsx)(H,{type:"secondary",children:"VAT (7%)"}),(0,i.jsx)(H,{children:(0,D.xG)(el)})]}),(0,i.jsx)(j.Z,{style:{margin:"12px 0"}}),(0,i.jsxs)(p.Z,{justify:"space-between",align:"middle",children:[(0,i.jsx)(F,{level:4,style:{margin:0},children:"ยอดรวมสุทธิ"}),(0,i.jsx)(F,{level:3,style:{color:"#eb2f96",margin:0},children:(0,D.xG)(er)})]})]})]})}),(0,i.jsx)(u.Z,{xs:24,lg:10,children:(0,i.jsxs)(h.Z,{style:{...z.ZW.card,textAlign:"center",padding:"24px 0"},children:[(0,i.jsxs)("div",{style:{marginBottom:32},children:[(0,i.jsx)("div",{style:{width:80,height:80,borderRadius:"50%",background:"#fff0f6",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"},children:(0,i.jsx)(b.Z,{style:{fontSize:40,color:"#eb2f96"}})}),(0,i.jsx)(F,{level:4,children:"พร้อมสำหรับการจัดส่ง"}),(0,i.jsx)(H,{type:"secondary",children:"ตรวจสอบความถูกต้องของรายการอาหารและเครื่องดื่ม ก่อนส่งมอบให้ไรเดอร์"})]}),(0,i.jsx)(h.Z,{style:{background:"#f9fafb",borderRadius:16,border:"1px dashed #d1d5db",marginBottom:32},bodyStyle:{padding:16},children:(0,i.jsxs)(g.Z,{orientation:"vertical",style:{width:"100%"},size:12,children:[(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(H,{type:"secondary",children:"ผู้ให้บริการ"}),(0,i.jsx)(H,{strong:!0,children:(null===(s=L.delivery)||void 0===s?void 0:s.delivery_name)||"-"})]}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(H,{type:"secondary",children:"รหัสออเดอร์ไรเดอร์"}),(0,i.jsx)(H,{strong:!0,children:L.delivery_code||"-"})]}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(H,{type:"secondary",children:"เลขที่ออเดอร์ POS"}),(0,i.jsx)(H,{strong:!0,children:L.order_no})]})]})}),!U&&(0,i.jsx)(m.Z,{message:"ไม่พบวิธีการชำระเงิน 'Delivery'",description:"กรุณาเพิ่มวิธีการชำระเงินชื่อ 'Delivery' ในเมนูตั้งค่า เพื่อให้สามารถส่งมอบสินค้าได้",type:"error",showIcon:!0,style:{marginBottom:16,textAlign:"left"}}),(0,i.jsx)(x.ZP,{type:"primary",size:"large",block:!0,icon:(0,i.jsx)(w.Z,{}),disabled:!U,style:{height:64,fontSize:18,borderRadius:16,background:U?"#eb2f96":void 0,borderColor:U?"#eb2f96":void 0,fontWeight:700,boxShadow:U?"0 8px 16px rgba(235, 47, 150, 0.25)":"none"},onClick:ed,children:"ส่งมอบสินค้าให้ไรเดอร์"}),(0,i.jsxs)("div",{style:{marginTop:20,display:"flex",alignItems:"center",justifyContent:"center",gap:8},children:[(0,i.jsx)(_.Z,{style:{color:"#8c8c8c"}}),(0,i.jsx)(H,{type:"secondary",style:{fontSize:13},children:"เมื่อกดแล้ว ระบบจะบันทึกยอดขายและปิดออเดอร์นี้"})]})]})})]})}),(0,i.jsx)(N.Z,{open:X.open,type:X.type,title:X.title,content:X.content,okText:X.okText,cancelText:X.cancelText,onOk:X.onOk,onCancel:et})]}):(0,i.jsx)(y.Z,{description:"ไม่พบข้อมูลออเดอร์"})}R().locale("th")}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=16923)}),_N_E=e.O()}]);