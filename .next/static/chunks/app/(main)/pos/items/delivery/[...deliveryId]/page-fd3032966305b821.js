(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9110],{16923:function(e,t,n){Promise.resolve().then(n.bind(n,76732))},76732:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return Q}});var i=n(57437),s=n(29),l=n.n(s),r=n(2265),d=n(99376),o=n(19683),a=n(34029),c=n(80009),y=n(85180),x=n(50742),u=n(47451),p=n(69410),h=n(96931),m=n(91652),j=n(23496),f=n(24783),g=n(61778),v=n(67605),b=n(13377),Z=n(62376),k=n(83669),w=n(15424),S=n(53286),_=n(63836),C=n(54528),B=n(97235),P=n(7806),T=n(32446),z=n(94532),W=n(45963),I=n(49747),O=n(71096),R=n.n(O);n(6729);var D=n(61414),N=n(60300),A=n(3369),E=n(24675),G=n(67697),F=n(25193),H=n(37410),M=n(20148);let{Title:q,Text:L}=o.default;function Q(){var e;let t=(0,d.useRouter)(),n=(0,d.useParams)(),[s,o]=a.ZP.useMessage(),O=Array.isArray(null==n?void 0:n.deliveryId)?n.deliveryId[0]:null==n?void 0:n.deliveryId,[R,Q]=(0,r.useState)(null),[U,V]=(0,r.useState)(!0),[Y,$]=(0,r.useState)(!0),{showLoading:J,hideLoading:K}=(0,A.x)(),{socket:X}=(0,E.s)(),[ee,et]=(0,r.useState)({open:!1,type:"confirm",title:"",content:"",onOk:()=>{}}),en=()=>et(e=>({...e,open:!1})),ei=(0,r.useCallback)(async()=>{if(O)try{V(!0),J("กำลังโหลดข้อมูลออเดอร์...");let[e,n]=await Promise.all([S.x.getById(O),_.E.getByName("Delivery").catch(()=>null)]);if(e.status!==T.i.WaitingForPayment){t.push("/pos/channels");return}if(e.order_type!==T.m.Delivery){s.warning("รายการนี้ไม่ใช่ Order Delivery"),t.push("/pos/channels");return}Q(e),$(!!n)}catch(e){s.error("ไม่สามารถโหลดข้อมูลออเดอร์ได้")}finally{V(!1),K()}},[O,s,t,J,K]);(0,r.useEffect)(()=>{O&&ei()},[ei,O]),(0,G.D)({socket:X,events:["orders:update","orders:delete","payments:create","payments:update"],onRefresh:()=>{O&&ei()},intervalMs:15e3,enabled:!!O});let{subtotal:es,discount:el,vat:er,total:ed}=(0,I.hs)(R,Number((null==R?void 0:R.total_amount)||0)),eo=(0,r.useMemo)(()=>{if(!(null==R?void 0:R.items))return[];let e=R.items.filter(e=>e.status!==T.i.Cancelled);return(0,P.S)(e)},[null==R?void 0:R.items]),ea=async()=>{var e;R&&et({open:!0,type:"confirm",title:"ยืนยันการส่งมอบสินค้า",content:(0,i.jsxs)("div",{style:{textAlign:"center"},children:[(0,i.jsxs)("div",{style:{fontSize:16,marginBottom:12},children:["คุณกำลังจะส่งมอบสินค้าให้ไรเดอร์สำหรับออเดอร์ ",(0,i.jsxs)(L,{strong:!0,children:["#",R.order_no]})]}),(0,i.jsxs)(c.Z,{color:"blue",style:{fontSize:14,padding:"4px 12px"},children:[null===(e=R.delivery)||void 0===e?void 0:e.delivery_name," ",R.delivery_code?"(".concat(R.delivery_code,")"):""]})]}),okText:"ยืนยันส่งมอบ",cancelText:"ยกเลิก",onOk:async()=>{try{J("กำลังดำเนินการส่งมอบ..."),en();let e=await (0,B.P)(),n=await _.E.getByName("Delivery"),i={order_id:R.id,payment_method_id:null==n?void 0:n.id,amount:ed,amount_received:ed,change_amount:0,status:z.b.Success};await C.U.create(i,void 0,e),s.success("ส่งมอบสินค้าให้ไรเดอร์เรียบร้อย"),t.push("/pos/dashboard/".concat(R.id))}catch(e){s.error("เกิดข้อผิดพลาดในการส่งมอบ")}finally{K()}}})},ec=async()=>{R&&et({open:!0,type:"warning",title:"ย้อนกลับไปแก้ไขออเดอร์?",content:'สถานะออเดอร์จะถูกเปลี่ยนกลับเป็น "กำลังดำเนินการ" เพื่อให้คุณสามารถแก้ไขรายการอาหารได้ คุณแน่ใจหรือไม่?',okText:"ตกลง",cancelText:"ยกเลิก",onOk:async()=>{try{var e;J("กำลังดำเนินการ..."),en();let n=await (0,B.P)(),i=(null===(e=R.items)||void 0===e?void 0:e.filter(e=>e.status!==T.i.Cancelled))||[];await Promise.all(i.map(e=>S.x.updateItemStatus(e.id,T.i.Served,void 0,n))),await S.x.updateStatus(R.id,T.i.Pending,n),s.success("ย้อนกลับไปแก้ไขออเดอร์เรียบร้อย"),t.push((0,D.HL)(R.id))}catch(e){s.error("ไม่สามารถเปลี่ยนสถานะออเดอร์ได้")}finally{K()}}})};return U&&!R?null:R?(0,i.jsxs)("div",{style:W.ZW.container,children:[(0,i.jsx)(l(),{id:W.um.__hash,children:W.um}),o,(0,i.jsx)(M.Z,{title:"สรุปออเดอร์เดลิเวอรี่",subtitle:"#".concat(R.order_no),icon:(0,i.jsx)(v.Z,{}),onBack:()=>t.back(),actions:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(x.ZP,{icon:(0,i.jsx)(b.Z,{}),onClick:ec,children:"แก้ไขออเดอร์"}),(0,i.jsx)(x.ZP,{danger:!0,onClick:()=>{R&&et({open:!0,type:"danger",title:"ยืนยันการยกเลิกออเดอร์?",content:"การดำเนินการนี้จะยกเลิกสินค้าทุกรายการ คุณแน่ใจหรือไม่?",okText:"ยืนยันการยกเลิก",cancelText:"ยกเลิก",onOk:async()=>{try{var e;J("กำลังดำเนินการยกเลิก..."),en();let n=await (0,B.P)(),i=(null===(e=R.items)||void 0===e?void 0:e.filter(e=>e.status!==T.i.Cancelled))||[];await Promise.all(i.map(e=>S.x.updateItemStatus(e.id,T.i.Cancelled,void 0,n))),await S.x.updateStatus(R.id,T.i.Cancelled,n),s.success("ยกเลิกออเดอร์เรียบร้อย"),t.push((0,D.d$)(R.order_type))}catch(e){s.error("ไม่สามารถยกเลิกออเดอร์ได้")}finally{K()}}})},children:"ยกเลิกออเดอร์"})]})}),(0,i.jsx)(F.Z,{maxWidth:1400,children:(0,i.jsx)(H.Z,{style:{background:"transparent",border:"none"},children:(0,i.jsx)("div",{style:{...W.ZW.contentWrapper,marginTop:0,paddingBottom:40},children:(0,i.jsxs)(u.Z,{gutter:[24,24],children:[(0,i.jsx)(p.Z,{xs:24,lg:14,children:(0,i.jsxs)(h.Z,{style:W.ZW.card,children:[(0,i.jsx)(q,{level:4,style:{marginBottom:20},children:"รายการอาหาร"}),(0,i.jsx)("div",{style:{overflowY:"auto",paddingRight:8,minHeight:300,maxHeight:600},children:eo.map((e,t)=>{var n,s;return(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16,paddingBottom:16,borderBottom:"1px solid ".concat(W.QF.borderLight)},children:[(0,i.jsxs)("div",{style:{display:"flex",gap:12,flex:1,minWidth:0},children:[(0,i.jsx)(m.Z,{shape:"square",size:56,src:null===(n=e.product)||void 0===n?void 0:n.img_url,icon:(0,i.jsx)(Z.Z,{}),style:{backgroundColor:"#f0f2f5",flexShrink:0,borderRadius:10}}),(0,i.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,i.jsx)(L,{strong:!0,style:{display:"block",fontSize:15},ellipsis:!0,children:null===(s=e.product)||void 0===s?void 0:s.display_name}),(0,i.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:4},children:[(0,i.jsx)(L,{type:"secondary",style:{fontSize:13},children:(0,D.xG)(e.price)}),(0,i.jsxs)(c.Z,{style:{margin:0,fontSize:11,borderRadius:4},children:["x",e.quantity]})]}),e.notes&&(0,i.jsxs)(L,{type:"secondary",style:{display:"block",fontSize:12,fontStyle:"italic",marginTop:4},children:["* ",e.notes]})]})]}),(0,i.jsx)(L,{strong:!0,style:{fontSize:15},children:(0,D.xG)(Number(e.total_price))})]},e.id||t)})}),(0,i.jsxs)("div",{style:{...W.ZW.summaryBox,background:"#f8fafc",borderRadius:16,padding:20},children:[(0,i.jsxs)(u.Z,{justify:"space-between",style:{marginBottom:8},children:[(0,i.jsx)(L,{type:"secondary",children:"ยอดรวม (Subtotal)"}),(0,i.jsx)(L,{children:(0,D.xG)(es)})]}),el>0&&(0,i.jsxs)(u.Z,{justify:"space-between",style:{marginBottom:8,color:W.QF.success},children:[(0,i.jsx)(L,{type:"success",children:"ส่วนลด (Discount)"}),(0,i.jsxs)(L,{type:"success",children:["-",(0,D.xG)(el)]})]}),er>0&&(0,i.jsxs)(u.Z,{justify:"space-between",style:{marginBottom:8},children:[(0,i.jsx)(L,{type:"secondary",children:"VAT (7%)"}),(0,i.jsx)(L,{children:(0,D.xG)(er)})]}),(0,i.jsx)(j.Z,{style:{margin:"12px 0"}}),(0,i.jsxs)(u.Z,{justify:"space-between",align:"middle",children:[(0,i.jsx)(q,{level:4,style:{margin:0},children:"ยอดรวมสุทธิ"}),(0,i.jsx)(q,{level:3,style:{color:"#eb2f96",margin:0},children:(0,D.xG)(ed)})]})]})]})}),(0,i.jsx)(p.Z,{xs:24,lg:10,children:(0,i.jsxs)(h.Z,{style:{...W.ZW.card,textAlign:"center",padding:"24px 0"},children:[(0,i.jsxs)("div",{style:{marginBottom:32},children:[(0,i.jsx)("div",{style:{width:80,height:80,borderRadius:"50%",background:"#fff0f6",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"},children:(0,i.jsx)(v.Z,{style:{fontSize:40,color:"#eb2f96"}})}),(0,i.jsx)(q,{level:4,children:"พร้อมสำหรับการจัดส่ง"}),(0,i.jsx)(L,{type:"secondary",children:"ตรวจสอบความถูกต้องของรายการอาหารและเครื่องดื่ม ก่อนส่งมอบให้ไรเดอร์"})]}),(0,i.jsx)(h.Z,{style:{background:"#f9fafb",borderRadius:16,border:"1px dashed #d1d5db",marginBottom:32},bodyStyle:{padding:16},children:(0,i.jsxs)(f.Z,{orientation:"vertical",style:{width:"100%"},size:12,children:[(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(L,{type:"secondary",children:"ผู้ให้บริการ"}),(0,i.jsx)(L,{strong:!0,children:(null===(e=R.delivery)||void 0===e?void 0:e.delivery_name)||"-"})]}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(L,{type:"secondary",children:"รหัสออเดอร์ไรเดอร์"}),(0,i.jsx)(L,{strong:!0,children:R.delivery_code||"-"})]}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(L,{type:"secondary",children:"เลขที่ออเดอร์ POS"}),(0,i.jsx)(L,{strong:!0,children:R.order_no})]})]})}),!Y&&(0,i.jsx)(g.Z,{message:"ไม่พบวิธีการชำระเงิน 'Delivery'",description:"กรุณาเพิ่มวิธีการชำระเงินชื่อ 'Delivery' ในเมนูตั้งค่า เพื่อให้สามารถส่งมอบสินค้าได้",type:"error",showIcon:!0,style:{marginBottom:16,textAlign:"left"}}),(0,i.jsx)(x.ZP,{type:"primary",size:"large",block:!0,icon:(0,i.jsx)(k.Z,{}),disabled:!Y,style:{height:64,fontSize:18,borderRadius:16,background:Y?"#eb2f96":void 0,borderColor:Y?"#eb2f96":void 0,fontWeight:700,boxShadow:Y?"0 8px 16px rgba(235, 47, 150, 0.25)":"none"},onClick:ea,children:"ส่งมอบสินค้าให้ไรเดอร์"}),(0,i.jsxs)("div",{style:{marginTop:20,display:"flex",alignItems:"center",justifyContent:"center",gap:8},children:[(0,i.jsx)(w.Z,{style:{color:"#8c8c8c"}}),(0,i.jsx)(L,{type:"secondary",style:{fontSize:13},children:"เมื่อกดแล้ว ระบบจะบันทึกยอดขายและปิดออเดอร์นี้"})]})]})})]})})})}),(0,i.jsx)(N.Z,{open:ee.open,type:ee.type,title:ee.title,content:ee.content,okText:ee.okText,cancelText:ee.cancelText,onOk:ee.onOk,onCancel:en})]}):(0,i.jsx)(y.Z,{description:"ไม่พบข้อมูลออเดอร์"})}R().locale("th")}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=16923)}),_N_E=e.O()}]);