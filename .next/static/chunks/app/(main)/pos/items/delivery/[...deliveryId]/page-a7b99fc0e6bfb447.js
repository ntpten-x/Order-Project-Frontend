(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9110],{16923:function(e,t,s){Promise.resolve().then(s.bind(s,76732))},76732:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return U}});var i=s(57437),n=s(29),l=s.n(n),r=s(2265),d=s(99376),a=s(60283),o=s(34029),c=s(80009),y=s(85180),x=s(50742),u=s(47451),p=s(69410),h=s(96931),m=s(91652),j=s(23496),f=s(24783),g=s(61778),v=s(67605),b=s(13377),Z=s(62376),k=s(83669),w=s(15424),S=s(53286),_=s(63836),C=s(54528),B=s(97235),O=s(7806),P=s(32446),T=s(94532),z=s(45963),I=s(49747),D=s(71096),W=s.n(D);s(6729);var R=s(61414),N=s(60300),A=s(3369),E=s(24675),G=s(67697),F=s(12028),H=s(25193),M=s(37410),q=s(20148);let{Title:L,Text:Q}=a.default;function U(){var e;let t=(0,d.useRouter)(),s=(0,d.useParams)(),[n,a]=o.ZP.useMessage(),D=Array.isArray(null==s?void 0:s.deliveryId)?s.deliveryId[0]:null==s?void 0:s.deliveryId,[W,U]=(0,r.useState)(null),[V,Y]=(0,r.useState)(!0),[$,J]=(0,r.useState)(!0),{showLoading:K,hideLoading:X}=(0,A.x)(),{socket:ee}=(0,E.s)(),[et,es]=(0,r.useState)({open:!1,type:"confirm",title:"",content:"",onOk:()=>{}}),ei=()=>es(e=>({...e,open:!1})),en=(0,r.useCallback)(async()=>{if(D)try{Y(!0),K("กำลังโหลดข้อมูลออเดอร์...");let[e,s]=await Promise.all([S.x.getById(D),_.E.getByName("Delivery").catch(()=>null)]);if(e.status!==P.i.WaitingForPayment){t.push("/pos/channels");return}if(e.order_type!==P.m.Delivery){n.warning("รายการนี้ไม่ใช่ Order Delivery"),t.push("/pos/channels");return}U(e),J(!!s)}catch(e){n.error("ไม่สามารถโหลดข้อมูลออเดอร์ได้")}finally{Y(!1),X()}},[D,n,t,K,X]);(0,r.useEffect)(()=>{D&&en()},[en,D]),(0,G.D)({socket:ee,events:[F.b.orders.update,F.b.orders.delete,F.b.payments.create,F.b.payments.update,F.b.salesOrderItem.create,F.b.salesOrderItem.update,F.b.salesOrderItem.delete,F.b.salesOrderDetail.create,F.b.salesOrderDetail.update,F.b.salesOrderDetail.delete],onRefresh:()=>{D&&en()},intervalMs:15e3,enabled:!!D});let{subtotal:el,discount:er,vat:ed,total:ea}=(0,I.hs)(W,Number((null==W?void 0:W.total_amount)||0)),eo=(0,r.useMemo)(()=>{if(!(null==W?void 0:W.items))return[];let e=W.items.filter(e=>e.status!==P.i.Cancelled);return(0,O.S)(e)},[null==W?void 0:W.items]),ec=async()=>{var e;W&&es({open:!0,type:"confirm",title:"ยืนยันการส่งมอบสินค้า",content:(0,i.jsxs)("div",{style:{textAlign:"center"},children:[(0,i.jsxs)("div",{style:{fontSize:16,marginBottom:12},children:["คุณกำลังจะส่งมอบสินค้าให้ไรเดอร์สำหรับออเดอร์ ",(0,i.jsxs)(Q,{strong:!0,children:["#",W.order_no]})]}),(0,i.jsxs)(c.Z,{color:"blue",style:{fontSize:14,padding:"4px 12px"},children:[null===(e=W.delivery)||void 0===e?void 0:e.delivery_name," ",W.delivery_code?"(".concat(W.delivery_code,")"):""]})]}),okText:"ยืนยันส่งมอบ",cancelText:"ยกเลิก",onOk:async()=>{try{K("กำลังดำเนินการส่งมอบ..."),ei();let e=await (0,B.P)(),s=await _.E.getByName("Delivery"),i={order_id:W.id,payment_method_id:null==s?void 0:s.id,amount:ea,amount_received:ea,change_amount:0,status:T.b.Success};await C.U.create(i,void 0,e),n.success("ส่งมอบสินค้าให้ไรเดอร์เรียบร้อย"),t.push("/pos/dashboard/".concat(W.id))}catch(e){n.error("เกิดข้อผิดพลาดในการส่งมอบ")}finally{X()}}})},ey=async()=>{W&&es({open:!0,type:"warning",title:"ย้อนกลับไปแก้ไขออเดอร์?",content:'สถานะออเดอร์จะถูกเปลี่ยนกลับเป็น "กำลังดำเนินการ" เพื่อให้คุณสามารถแก้ไขรายการอาหารได้ คุณแน่ใจหรือไม่?',okText:"ตกลง",cancelText:"ยกเลิก",onOk:async()=>{try{var e;K("กำลังดำเนินการ..."),ei();let s=await (0,B.P)(),i=(null===(e=W.items)||void 0===e?void 0:e.filter(e=>e.status!==P.i.Cancelled))||[];await Promise.all(i.map(e=>S.x.updateItemStatus(e.id,P.i.Served,void 0,s))),await S.x.updateStatus(W.id,P.i.Pending,s),n.success("ย้อนกลับไปแก้ไขออเดอร์เรียบร้อย"),t.push((0,R.HL)(W.id))}catch(e){n.error("ไม่สามารถเปลี่ยนสถานะออเดอร์ได้")}finally{X()}}})};return V&&!W?null:W?(0,i.jsxs)("div",{style:z.ZW.container,children:[(0,i.jsx)(l(),{id:z.um.__hash,children:z.um}),a,(0,i.jsx)(q.Z,{title:"สรุปออเดอร์เดลิเวอรี่",subtitle:"#".concat(W.order_no),icon:(0,i.jsx)(v.Z,{}),onBack:()=>t.back(),actions:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(x.ZP,{icon:(0,i.jsx)(b.Z,{}),onClick:ey,children:"แก้ไขออเดอร์"}),(0,i.jsx)(x.ZP,{danger:!0,onClick:()=>{W&&es({open:!0,type:"danger",title:"ยืนยันการยกเลิกออเดอร์?",content:"การดำเนินการนี้จะยกเลิกสินค้าทุกรายการ คุณแน่ใจหรือไม่?",okText:"ยืนยันการยกเลิก",cancelText:"ยกเลิก",onOk:async()=>{try{var e;K("กำลังดำเนินการยกเลิก..."),ei();let s=await (0,B.P)(),i=(null===(e=W.items)||void 0===e?void 0:e.filter(e=>e.status!==P.i.Cancelled))||[];await Promise.all(i.map(e=>S.x.updateItemStatus(e.id,P.i.Cancelled,void 0,s))),await S.x.updateStatus(W.id,P.i.Cancelled,s),n.success("ยกเลิกออเดอร์เรียบร้อย"),t.push((0,R.d$)(W.order_type))}catch(e){n.error("ไม่สามารถยกเลิกออเดอร์ได้")}finally{X()}}})},children:"ยกเลิกออเดอร์"})]})}),(0,i.jsx)(H.Z,{maxWidth:1400,children:(0,i.jsx)(M.Z,{style:{background:"transparent",border:"none"},children:(0,i.jsx)("div",{style:{...z.ZW.contentWrapper,marginTop:0,paddingBottom:40},children:(0,i.jsxs)(u.Z,{gutter:[24,24],children:[(0,i.jsx)(p.Z,{xs:24,lg:14,children:(0,i.jsxs)(h.Z,{style:z.ZW.card,children:[(0,i.jsx)(L,{level:4,style:{marginBottom:20},children:"รายการอาหาร"}),(0,i.jsx)("div",{style:{overflowY:"auto",paddingRight:8,minHeight:300,maxHeight:600},children:eo.map((e,t)=>{var s,n;return(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16,paddingBottom:16,borderBottom:"1px solid ".concat(z.QF.borderLight)},children:[(0,i.jsxs)("div",{style:{display:"flex",gap:12,flex:1,minWidth:0},children:[(0,i.jsx)(m.Z,{shape:"square",size:56,src:null===(s=e.product)||void 0===s?void 0:s.img_url,icon:(0,i.jsx)(Z.Z,{}),style:{backgroundColor:"#f0f2f5",flexShrink:0,borderRadius:10}}),(0,i.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,i.jsx)(Q,{strong:!0,style:{display:"block",fontSize:15},ellipsis:!0,children:null===(n=e.product)||void 0===n?void 0:n.display_name}),(0,i.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:4},children:[(0,i.jsx)(Q,{type:"secondary",style:{fontSize:13},children:(0,R.xG)(e.price)}),(0,i.jsxs)(c.Z,{style:{margin:0,fontSize:11,borderRadius:4},children:["x",e.quantity]})]}),e.notes&&(0,i.jsxs)(Q,{type:"secondary",style:{display:"block",fontSize:12,fontStyle:"italic",marginTop:4},children:["* ",e.notes]})]})]}),(0,i.jsx)(Q,{strong:!0,style:{fontSize:15},children:(0,R.xG)(Number(e.total_price))})]},e.id||t)})}),(0,i.jsxs)("div",{style:{...z.ZW.summaryBox,background:"#f8fafc",borderRadius:16,padding:20},children:[(0,i.jsxs)(u.Z,{justify:"space-between",style:{marginBottom:8},children:[(0,i.jsx)(Q,{type:"secondary",children:"ยอดรวม (Subtotal)"}),(0,i.jsx)(Q,{children:(0,R.xG)(el)})]}),er>0&&(0,i.jsxs)(u.Z,{justify:"space-between",style:{marginBottom:8,color:z.QF.success},children:[(0,i.jsx)(Q,{type:"success",children:"ส่วนลด (Discount)"}),(0,i.jsxs)(Q,{type:"success",children:["-",(0,R.xG)(er)]})]}),ed>0&&(0,i.jsxs)(u.Z,{justify:"space-between",style:{marginBottom:8},children:[(0,i.jsx)(Q,{type:"secondary",children:"VAT (7%)"}),(0,i.jsx)(Q,{children:(0,R.xG)(ed)})]}),(0,i.jsx)(j.Z,{style:{margin:"12px 0"}}),(0,i.jsxs)(u.Z,{justify:"space-between",align:"middle",children:[(0,i.jsx)(L,{level:4,style:{margin:0},children:"ยอดรวมสุทธิ"}),(0,i.jsx)(L,{level:3,style:{color:"#eb2f96",margin:0},children:(0,R.xG)(ea)})]})]})]})}),(0,i.jsx)(p.Z,{xs:24,lg:10,children:(0,i.jsxs)(h.Z,{style:{...z.ZW.card,textAlign:"center",padding:"24px 0"},children:[(0,i.jsxs)("div",{style:{marginBottom:32},children:[(0,i.jsx)("div",{style:{width:80,height:80,borderRadius:"50%",background:"#fff0f6",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"},children:(0,i.jsx)(v.Z,{style:{fontSize:40,color:"#eb2f96"}})}),(0,i.jsx)(L,{level:4,children:"พร้อมสำหรับการจัดส่ง"}),(0,i.jsx)(Q,{type:"secondary",children:"ตรวจสอบความถูกต้องของรายการอาหารและเครื่องดื่ม ก่อนส่งมอบให้ไรเดอร์"})]}),(0,i.jsx)(h.Z,{style:{background:"#f9fafb",borderRadius:16,border:"1px dashed #d1d5db",marginBottom:32},bodyStyle:{padding:16},children:(0,i.jsxs)(f.Z,{orientation:"vertical",style:{width:"100%"},size:12,children:[(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(Q,{type:"secondary",children:"ผู้ให้บริการ"}),(0,i.jsx)(Q,{strong:!0,children:(null===(e=W.delivery)||void 0===e?void 0:e.delivery_name)||"-"})]}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(Q,{type:"secondary",children:"รหัสออเดอร์ไรเดอร์"}),(0,i.jsx)(Q,{strong:!0,children:W.delivery_code||"-"})]}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,i.jsx)(Q,{type:"secondary",children:"เลขที่ออเดอร์ POS"}),(0,i.jsx)(Q,{strong:!0,children:W.order_no})]})]})}),!$&&(0,i.jsx)(g.Z,{message:"ไม่พบวิธีการชำระเงิน 'Delivery'",description:"กรุณาเพิ่มวิธีการชำระเงินชื่อ 'Delivery' ในเมนูตั้งค่า เพื่อให้สามารถส่งมอบสินค้าได้",type:"error",showIcon:!0,style:{marginBottom:16,textAlign:"left"}}),(0,i.jsx)(x.ZP,{type:"primary",size:"large",block:!0,icon:(0,i.jsx)(k.Z,{}),disabled:!$,style:{height:64,fontSize:18,borderRadius:16,background:$?"#eb2f96":void 0,borderColor:$?"#eb2f96":void 0,fontWeight:700,boxShadow:$?"0 8px 16px rgba(235, 47, 150, 0.25)":"none"},onClick:ec,children:"ส่งมอบสินค้าให้ไรเดอร์"}),(0,i.jsxs)("div",{style:{marginTop:20,display:"flex",alignItems:"center",justifyContent:"center",gap:8},children:[(0,i.jsx)(w.Z,{style:{color:"#8c8c8c"}}),(0,i.jsx)(Q,{type:"secondary",style:{fontSize:13},children:"เมื่อกดแล้ว ระบบจะบันทึกยอดขายและปิดออเดอร์นี้"})]})]})})]})})})}),(0,i.jsx)(N.Z,{open:et.open,type:et.type,title:et.title,content:et.content,okText:et.okText,cancelText:et.cancelText,onOk:et.onOk,onCancel:ei})]}):(0,i.jsx)(y.Z,{description:"ไม่พบข้อมูลออเดอร์"})}W().locale("th")}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=16923)}),_N_E=e.O()}]);