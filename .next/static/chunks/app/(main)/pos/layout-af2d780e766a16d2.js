(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[797],{83970:function(e,t,a){Promise.resolve().then(a.bind(a,16643))},16643:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return K}});var o=a(57437),s=a(2265),n=a(13817),l=a(8949),r=a(28006),i=a(99376),d=a(5311),c=a(62376),p=a(38434),u=a(88009),y=a(441),h=a(93132),x=a(29107),f=a(71891),m=a(99458),b=a(55322),j=a(39760),k=a(72285),Z=a(40740),g=a(35631),v=a(50742),E=a(35713),C=a(14362),T=a(9771),_=a(15718),w=()=>{let e=(0,i.useRouter)(),t=(0,i.usePathname)(),{user:a}=(0,C.a)(),{currentShift:n}=(0,r.S)(),[l,w]=(0,s.useState)(!1),[P,I]=(0,s.useState)(!1),M=(0,s.useMemo)(()=>[{key:"home",label:"หน้าแรก",icon:(0,o.jsx)(d.Z,{}),path:"/"},{key:"pos",label:"ขาย",icon:(0,o.jsx)(c.Z,{}),path:"/pos"},{key:"orders",label:"ออเดอร์",icon:(0,o.jsx)(p.Z,{}),path:"/pos/orders"},{key:"dashboard",label:"สรุป",icon:(0,o.jsx)(u.Z,{}),path:"/pos/dashboard"}],[]),R=(0,s.useMemo)(()=>{let e=[{key:"kitchen",label:"ครัว",icon:(0,o.jsx)(y.Z,{}),path:"/pos/kitchen"},{key:"tables",label:"โต๊ะ",icon:(0,o.jsx)(h.Z,{}),path:"/pos/tables"},{key:"delivery",label:"เดลิเวอรี่",icon:(0,o.jsx)(x.Z,{}),path:"/pos/delivery"}];return((null==a?void 0:a.role)==="Admin"||(null==a?void 0:a.role)==="Manager")&&e.push({key:"category",label:"หมวดหมู่",icon:(0,o.jsx)(u.Z,{}),path:"/pos/category"},{key:"products",label:"สินค้า",icon:(0,o.jsx)(c.Z,{}),path:"/pos/products"},{key:"productsUnit",label:"หน่วยสินค้า",icon:(0,o.jsx)(u.Z,{}),path:"/pos/productsUnit"},{key:"discounts",label:"ส่วนลด",icon:(0,o.jsx)(f.Z,{}),path:"/pos/discounts"},{key:"payment",label:"ชำระเงิน",icon:(0,o.jsx)(m.Z,{}),path:"/pos/paymentMethod"},{key:"settings",label:"ตั้งค่า",icon:(0,o.jsx)(b.Z,{}),path:"/pos/settings"}),e},[null==a?void 0:a.role]),S=e=>"/"===e?"/"===t:"/pos"===e?"/pos"===t||t.startsWith("/pos/channels"):t===e||t.startsWith(e+"/"),U=R.some(e=>S(e.path)),A=t=>{e.push(t),w(!1)};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(T.Z,{maxWidth:520,items:[...M.map(e=>({key:e.key,label:e.label,icon:e.icon,onClick:()=>A(e.path),active:S(e.path)})),{key:"more",label:"เพิ่มเติม",icon:(0,o.jsx)(j.Z,{}),onClick:()=>w(!0),active:l||U}]}),(0,o.jsx)(Z.Z,{open:l,onClose:()=>w(!1),placement:"bottom",title:"เมนูเพิ่มเติม",zIndex:2e3,children:(0,o.jsxs)("div",{style:{paddingBottom:"calc(12px + env(safe-area-inset-bottom))"},children:[(0,o.jsx)(g.Z,{dataSource:R,renderItem:e=>(0,o.jsx)(g.Z.Item,{style:{paddingInline:0},children:(0,o.jsx)(v.ZP,{type:"text",block:!0,icon:e.icon,style:{height:48,justifyContent:"flex-start"},onClick:()=>A(e.path),children:e.label})})}),n&&(0,o.jsx)(v.ZP,{danger:!0,block:!0,icon:(0,o.jsx)(E.Z,{dot:!0,status:"processing",color:"#ef4444",children:(0,o.jsx)(k.Z,{})}),style:{height:48,marginTop:8},onClick:()=>{I(!0),w(!1)},children:"ปิดกะ"})]})}),(0,o.jsx)(_.Z,{open:P,onCancel:()=>I(!1)})]})},P=a(34029),I=a(52717),M=a(20920),R=a(84859),S=a(53286),U=a(54528),A=a(86198),D=a(5447),Q=a(98748);let N=e=>new Promise(t=>setTimeout(t,e)),O=()=>{let e=(0,M.L)(),[t,a]=(0,s.useState)(!1),n=(0,s.useCallback)(async()=>{if(t||0===R.x.getQueue().length)return;a(!0);let e=P.ZP.loading("กำลังซิงค์รายการที่ค้างอยู่...",0),o=0,s=0;R.x.pruneExceeded();let n=R.x.getQueue();try{let e=await D.O.getCsrfToken();for(let t of n)try{let a=R.M.backoff(t.retryCount);if(a>0&&await N(a),"CREATE_ORDER"===t.type)await S.x.create(t.payload,void 0,e);else if("UPDATE_ORDER"===t.type){let{orderId:a,data:o}=t.payload;await S.x.update(a,o,void 0,e)}else if("ADD_ITEM"===t.type){let{orderId:a,itemData:o}=t.payload;await S.x.addItem(a,o,void 0,e)}else if("UPDATE_ITEM"===t.type){let{itemId:a,itemData:o}=t.payload;await S.x.updateItem(a,o,void 0,e)}else if("DELETE_ITEM"===t.type){let{itemId:a}=t.payload;await S.x.deleteItem(a,void 0,e)}else if("PAYMENT"===t.type){let{orderId:a,paymentData:o}=t.payload;await U.U.create({...o,order_id:a},void 0,e)}else if("UPDATE_QUEUE_STATUS"===t.type){let{queueId:e,status:a}=t.payload;await A.e.updateStatus(e,{status:a},void 0)}R.x.removeFromQueue(t.id),o++}catch(e){if(t.retryCount+1>R.M.maxRetry)R.x.removeFromQueue(t.id),s++;else{let a=e instanceof Error?e.message:void 0;R.x.incrementRetry(t.id,a)}}}finally{e(),a(!1),o>0&&P.ZP.success("ซิงค์สำเร็จ ".concat(o," รายการ")),s>0&&I.ZP.error({message:"ซิงค์บางรายการไม่สำเร็จ",description:"".concat(s," รายการเกินจำนวน retry ที่กำหนด"),placement:"bottomRight",duration:3})}},[t]);return(0,s.useEffect)(()=>{e?n():I.ZP.warning({message:"ออฟไลน์",description:"รายการจะถูกเก็บเข้าคิวและซิงค์ให้อัตโนมัติเมื่อออนไลน์",icon:(0,o.jsx)(Q.Z,{style:{color:"#faad14"}}),duration:2,placement:"bottomRight"})},[e,n]),null};var F=a(54343),L=a(29827),W=a(46252);let q=()=>{let{socket:e}=(0,s.useContext)(W.J),t=(0,L.NL)();(0,s.useEffect)(()=>{if(!e)return;let a=()=>{t.invalidateQueries({queryKey:["orders"]}),t.invalidateQueries({queryKey:["ordersSummary"]})},o=()=>{a()},s=()=>{a()},n=()=>{a()};return e.on("orders:create",o),e.on("orders:update",s),e.on("orders:delete",n),e.on("payments:create",s),e.on("payments:update",s),()=>{e.off("orders:create",o),e.off("orders:update",s),e.off("orders:delete",n),e.off("payments:create",s),e.off("payments:update",s)}},[e,t])};function K(e){let{children:t}=e;return q(),(0,o.jsxs)(r.r,{children:[(0,o.jsx)(O,{}),(0,o.jsx)(F.Z,{}),(0,o.jsx)(l.Z,{children:(0,o.jsxs)(n.default,{style:{minHeight:"100%",background:"transparent"},children:[(0,o.jsx)(n.default.Content,{style:{background:"transparent"},children:t}),(0,o.jsx)(w,{})]})})]})}}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=83970)}),_N_E=e.O()}]);