(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[797],{83970:function(e,t,a){Promise.resolve().then(a.bind(a,16643))},16643:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return z}});var s=a(57437),o=a(2265),r=a(13817),l=a(8949),n=a(28006),i=a(99376),d=a(5311),c=a(62376),p=a(38434),u=a(88009),y=a(441),f=a(93132),b=a(29107),h=a(71891),m=a(99458),x=a(55322),j=a(39760),k=a(72285),Z=a(40740),g=a(35631),v=a(50742),E=a(35713),O=a(14362),C=a(9771),I=a(15718),D=()=>{let e=(0,i.useRouter)(),t=(0,i.usePathname)(),{user:a}=(0,O.a)(),{currentShift:r}=(0,n.S)(),[l,D]=(0,o.useState)(!1),[T,_]=(0,o.useState)(!1),w=(0,o.useMemo)(()=>[{key:"home",label:"หน้าแรก",icon:(0,s.jsx)(d.Z,{}),path:"/"},{key:"pos",label:"ขาย",icon:(0,s.jsx)(c.Z,{}),path:"/pos"},{key:"orders",label:"ออเดอร์",icon:(0,s.jsx)(p.Z,{}),path:"/pos/orders"},{key:"dashboard",label:"สรุป",icon:(0,s.jsx)(u.Z,{}),path:"/pos/dashboard"}],[]),P=(0,o.useMemo)(()=>{let e=[{key:"kitchen",label:"ครัว",icon:(0,s.jsx)(y.Z,{}),path:"/pos/kitchen"},{key:"tables",label:"โต๊ะ",icon:(0,s.jsx)(f.Z,{}),path:"/pos/tables"},{key:"delivery",label:"เดลิเวอรี่",icon:(0,s.jsx)(b.Z,{}),path:"/pos/delivery"}];return((null==a?void 0:a.role)==="Admin"||(null==a?void 0:a.role)==="Manager")&&e.push({key:"category",label:"หมวดหมู่",icon:(0,s.jsx)(u.Z,{}),path:"/pos/category"},{key:"products",label:"สินค้า",icon:(0,s.jsx)(c.Z,{}),path:"/pos/products"},{key:"productsUnit",label:"หน่วยสินค้า",icon:(0,s.jsx)(u.Z,{}),path:"/pos/productsUnit"},{key:"discounts",label:"ส่วนลด",icon:(0,s.jsx)(h.Z,{}),path:"/pos/discounts"},{key:"payment",label:"ชำระเงิน",icon:(0,s.jsx)(m.Z,{}),path:"/pos/paymentMethod"},{key:"settings",label:"ตั้งค่า",icon:(0,s.jsx)(x.Z,{}),path:"/pos/settings"}),e},[null==a?void 0:a.role]),M=e=>"/"===e?"/"===t:"/pos"===e?"/pos"===t||t.startsWith("/pos/channels"):t===e||t.startsWith(e+"/"),R=P.some(e=>M(e.path)),S=t=>{e.push(t),D(!1)};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(C.Z,{maxWidth:520,items:[...w.map(e=>({key:e.key,label:e.label,icon:e.icon,onClick:()=>S(e.path),active:M(e.path)})),{key:"more",label:"เพิ่มเติม",icon:(0,s.jsx)(j.Z,{}),onClick:()=>D(!0),active:l||R}]}),(0,s.jsx)(Z.Z,{open:l,onClose:()=>D(!1),placement:"bottom",title:"เมนูเพิ่มเติม",zIndex:2e3,children:(0,s.jsxs)("div",{style:{paddingBottom:"calc(12px + env(safe-area-inset-bottom))"},children:[(0,s.jsx)(g.Z,{dataSource:P,renderItem:e=>(0,s.jsx)(g.Z.Item,{style:{paddingInline:0},children:(0,s.jsx)(v.ZP,{type:"text",block:!0,icon:e.icon,style:{height:48,justifyContent:"flex-start"},onClick:()=>S(e.path),children:e.label})})}),r&&(0,s.jsx)(v.ZP,{danger:!0,block:!0,icon:(0,s.jsx)(E.Z,{dot:!0,status:"processing",color:"#ef4444",children:(0,s.jsx)(k.Z,{})}),style:{height:48,marginTop:8},onClick:()=>{_(!0),D(!1)},children:"ปิดกะ"})]})}),(0,s.jsx)(I.Z,{open:T,onCancel:()=>_(!1)})]})},T=a(34029),_=a(52717),w=a(20920),P=a(84859),M=a(53286),R=a(54528),S=a(86198),U=a(5447),A=a(98748);let Q=e=>new Promise(t=>setTimeout(t,e)),N=()=>{let e=(0,w.L)(),[t,a]=(0,o.useState)(!1),r=(0,o.useCallback)(async()=>{if(t||0===P.x.getQueue().length)return;a(!0);let e=T.ZP.loading("กำลังซิงค์รายการที่ค้างอยู่...",0),s=0,o=0;P.x.pruneExceeded();let r=P.x.getQueue();try{let e=await U.O.getCsrfToken();for(let t of r)try{let a=P.M.backoff(t.retryCount);if(a>0&&await Q(a),"CREATE_ORDER"===t.type)await M.x.create(t.payload,void 0,e);else if("UPDATE_ORDER"===t.type){let{orderId:a,data:s}=t.payload;await M.x.update(a,s,void 0,e)}else if("ADD_ITEM"===t.type){let{orderId:a,itemData:s}=t.payload;await M.x.addItem(a,s,void 0,e)}else if("UPDATE_ITEM"===t.type){let{itemId:a,itemData:s}=t.payload;await M.x.updateItem(a,s,void 0,e)}else if("DELETE_ITEM"===t.type){let{itemId:a}=t.payload;await M.x.deleteItem(a,void 0,e)}else if("PAYMENT"===t.type){let{orderId:a,paymentData:s}=t.payload;await R.U.create({...s,order_id:a},void 0,e)}else if("UPDATE_QUEUE_STATUS"===t.type){let{queueId:e,status:a}=t.payload;await S.e.updateStatus(e,{status:a},void 0)}P.x.removeFromQueue(t.id),s++}catch(e){if(t.retryCount+1>P.M.maxRetry)P.x.removeFromQueue(t.id),o++;else{let a=e instanceof Error?e.message:void 0;P.x.incrementRetry(t.id,a)}}}finally{e(),a(!1),s>0&&T.ZP.success("ซิงค์สำเร็จ ".concat(s," รายการ")),o>0&&_.ZP.error({message:"ซิงค์บางรายการไม่สำเร็จ",description:"".concat(o," รายการเกินจำนวน retry ที่กำหนด"),placement:"bottomRight",duration:3})}},[t]);return(0,o.useEffect)(()=>{e?r():_.ZP.warning({message:"ออฟไลน์",description:"รายการจะถูกเก็บเข้าคิวและซิงค์ให้อัตโนมัติเมื่อออนไลน์",icon:(0,s.jsx)(A.Z,{style:{color:"#faad14"}}),duration:2,placement:"bottomRight"})},[e,r]),null};var F=a(54343),L=a(29827),W=a(46252),q=a(12028);let K=()=>{let{socket:e}=(0,o.useContext)(W.J),t=(0,L.NL)();(0,o.useEffect)(()=>{if(!e)return;let a=()=>{t.invalidateQueries({queryKey:["orders"]}),t.invalidateQueries({queryKey:["ordersSummary"]})},s=()=>{a()},o=()=>{a()},r=()=>{a()};return e.on(q.b.orders.create,s),e.on(q.b.orders.update,o),e.on(q.b.orders.delete,r),e.on(q.b.payments.create,o),e.on(q.b.payments.update,o),e.on(q.b.salesOrderItem.create,o),e.on(q.b.salesOrderItem.update,o),e.on(q.b.salesOrderItem.delete,o),e.on(q.b.salesOrderDetail.create,o),e.on(q.b.salesOrderDetail.update,o),e.on(q.b.salesOrderDetail.delete,o),()=>{e.off(q.b.orders.create,s),e.off(q.b.orders.update,o),e.off(q.b.orders.delete,r),e.off(q.b.payments.create,o),e.off(q.b.payments.update,o),e.off(q.b.salesOrderItem.create,o),e.off(q.b.salesOrderItem.update,o),e.off(q.b.salesOrderItem.delete,o),e.off(q.b.salesOrderDetail.create,o),e.off(q.b.salesOrderDetail.update,o),e.off(q.b.salesOrderDetail.delete,o)}},[e,t])};function z(e){let{children:t}=e;return K(),(0,s.jsxs)(n.r,{children:[(0,s.jsx)(N,{}),(0,s.jsx)(F.Z,{}),(0,s.jsx)(l.Z,{children:(0,s.jsxs)(r.default,{style:{minHeight:"100%",background:"transparent"},children:[(0,s.jsx)(r.default.Content,{style:{background:"transparent"},children:t}),(0,s.jsx)(D,{})]})})]})}}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=83970)}),_N_E=e.O()}]);