(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1976],{92308:function(e,t,E){Promise.resolve().then(E.bind(E,12619))},12619:function(e,t,E){"use strict";E.r(t),E.d(t,{default:function(){return G}});var i,l,n=E(57437),d=E(2265),r=E(7408),a=E(60283),s=E(34029),o=E(80009),T=E(24783),_=E(89970),c=E(50742),D=E(96931),A=E(45235),R=E(88589),u=E(93834),h=E(73179),C=E(85180),x=E(40740),O=E(76188),U=E(23496),S=E(6520),N=E(95159),P=E(89245),y=E(10798),p=E(72788),j=E(23639),I=E(11713),g=E(71096),f=E.n(g),v=E(25193),L=E(20148),b=E(37410);(i=l||(l={})).ORDER_CREATE="ORDER_CREATE",i.ORDER_UPDATE="ORDER_UPDATE",i.ORDER_DELETE="ORDER_DELETE",i.ORDER_STATUS_CHANGE="ORDER_STATUS_CHANGE",i.ORDER_CANCEL="ORDER_CANCEL",i.PAYMENT_CREATE="PAYMENT_CREATE",i.PAYMENT_UPDATE="PAYMENT_UPDATE",i.PAYMENT_DELETE="PAYMENT_DELETE",i.PAYMENT_REFUND="PAYMENT_REFUND",i.PAYMENT_ADJUST="PAYMENT_ADJUST",i.ITEM_ADD="ITEM_ADD",i.ITEM_UPDATE="ITEM_UPDATE",i.ITEM_DELETE="ITEM_DELETE",i.QUEUE_ADD="QUEUE_ADD",i.QUEUE_UPDATE="QUEUE_UPDATE",i.QUEUE_REMOVE="QUEUE_REMOVE",i.QUEUE_REORDER="QUEUE_REORDER",i.PRODUCT_CREATE="PRODUCT_CREATE",i.PRODUCT_UPDATE="PRODUCT_UPDATE",i.PRODUCT_DELETE="PRODUCT_DELETE",i.CATEGORY_CREATE="CATEGORY_CREATE",i.CATEGORY_UPDATE="CATEGORY_UPDATE",i.CATEGORY_DELETE="CATEGORY_DELETE",i.DISCOUNT_CREATE="DISCOUNT_CREATE",i.DISCOUNT_UPDATE="DISCOUNT_UPDATE",i.DISCOUNT_DELETE="DISCOUNT_DELETE",i.DISCOUNT_APPLY="DISCOUNT_APPLY",i.DELIVERY_CREATE="DELIVERY_CREATE",i.DELIVERY_UPDATE="DELIVERY_UPDATE",i.DELIVERY_DELETE="DELIVERY_DELETE",i.TABLE_CREATE="TABLE_CREATE",i.TABLE_UPDATE="TABLE_UPDATE",i.TABLE_DELETE="TABLE_DELETE",i.PAYMENT_METHOD_CREATE="PAYMENT_METHOD_CREATE",i.PAYMENT_METHOD_UPDATE="PAYMENT_METHOD_UPDATE",i.PAYMENT_METHOD_DELETE="PAYMENT_METHOD_DELETE",i.PRODUCTS_UNIT_CREATE="PRODUCTS_UNIT_CREATE",i.PRODUCTS_UNIT_UPDATE="PRODUCTS_UNIT_UPDATE",i.PRODUCTS_UNIT_DELETE="PRODUCTS_UNIT_DELETE",i.PAYMENT_ACCOUNT_CREATE="PAYMENT_ACCOUNT_CREATE",i.PAYMENT_ACCOUNT_UPDATE="PAYMENT_ACCOUNT_UPDATE",i.PAYMENT_ACCOUNT_ACTIVATE="PAYMENT_ACCOUNT_ACTIVATE",i.PAYMENT_ACCOUNT_DELETE="PAYMENT_ACCOUNT_DELETE",i.SHOP_PROFILE_UPDATE="SHOP_PROFILE_UPDATE",i.USER_CREATE="USER_CREATE",i.USER_UPDATE="USER_UPDATE",i.USER_DELETE="USER_DELETE",i.ROLE_CREATE="ROLE_CREATE",i.ROLE_UPDATE="ROLE_UPDATE",i.ROLE_DELETE="ROLE_DELETE",i.BRANCH_CREATE="BRANCH_CREATE",i.BRANCH_UPDATE="BRANCH_UPDATE",i.BRANCH_DELETE="BRANCH_DELETE",i.STOCK_INGREDIENT_CREATE="STOCK_INGREDIENT_CREATE",i.STOCK_INGREDIENT_UPDATE="STOCK_INGREDIENT_UPDATE",i.STOCK_INGREDIENT_DELETE="STOCK_INGREDIENT_DELETE",i.STOCK_INGREDIENT_UNIT_CREATE="STOCK_INGREDIENT_UNIT_CREATE",i.STOCK_INGREDIENT_UNIT_UPDATE="STOCK_INGREDIENT_UNIT_UPDATE",i.STOCK_INGREDIENT_UNIT_DELETE="STOCK_INGREDIENT_UNIT_DELETE",i.STOCK_ORDER_CREATE="STOCK_ORDER_CREATE",i.STOCK_ORDER_UPDATE="STOCK_ORDER_UPDATE",i.STOCK_ORDER_DELETE="STOCK_ORDER_DELETE",i.STOCK_ORDER_CONFIRM_PURCHASE="STOCK_ORDER_CONFIRM_PURCHASE",i.STOCK_ORDER_STATUS_UPDATE="STOCK_ORDER_STATUS_UPDATE",i.SHIFT_OPEN="SHIFT_OPEN",i.SHIFT_CLOSE="SHIFT_CLOSE";let Z={container:{background:"#f6f7fb",minHeight:"100vh",paddingBottom:80},filtersCard:{borderRadius:18,boxShadow:"0 12px 40px rgba(15, 23, 42, 0.05)",border:"1px solid #edf1f7"},statsGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:12},tableCard:{borderRadius:18,boxShadow:"0 10px 34px rgba(15, 23, 42, 0.05)",border:"1px solid #edf1f7"},jsonBlock:{background:"#0b1021",color:"#e8f0ff",borderRadius:12,padding:12,fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',fontSize:12,lineHeight:1.5,maxHeight:320,overflow:"auto",border:"1px solid #151b33"}},m=()=>(0,n.jsx)("style",{children:"\n      .audit-table .ant-table-tbody > tr:hover > td {\n        background: #f5f7ff !important;\n      }\n      .audit-table .ant-table-cell {\n        font-size: 13px;\n      }\n      .audit-chip {\n        border-radius: 999px;\n        padding: 4px 10px;\n        font-weight: 600;\n      }\n      .audit-drawer .ant-drawer-body {\n        padding: 18px;\n      }\n    "});var M=E(14362),Y=E(1665);let{RangePicker:w}=r.default,{Text:H}=a.default;function K(e){return e.replace(/_/g," / ")}function z(e){let t=e.toUpperCase();return t.includes("DELETE")||t.includes("CANCEL")?"red":t.includes("REFUND")||t.includes("CLOSE")?"volcano":t.includes("UPDATE")||t.includes("STATUS")?"geekblue":t.includes("CREATE")||t.includes("ADD")||t.includes("OPEN")?"green":"purple"}function G(){var e,t,E,i,r,a,g,G,k,B;let{user:F}=(0,M.a)(),V=(null==F?void 0:F.role)==="Admin",[Q,W]=(0,d.useState)(""),[q,J]=(0,d.useState)(),[X,$]=(0,d.useState)(),[ee,et]=(0,d.useState)(),[eE,ei]=(0,d.useState)(null),[el,en]=(0,d.useState)(1),[ed,er]=(0,d.useState)(20),[ea,es]=(0,d.useState)(null),eo=(0,d.useMemo)(()=>[Q,q,X,ee,null==eE?void 0:eE[0],null==eE?void 0:eE[1]].filter(Boolean).length,[Q,q,X,ee,eE]),eT=(0,d.useMemo)(()=>Object.values(l).map(e=>({value:e,label:K(e)})),[]),e_=(0,I.a)({queryKey:["branches",V],queryFn:()=>Y.x.getAll(),enabled:V,staleTime:3e5}),ec=(0,I.a)({queryKey:["auditLogs",el,ed,Q,q,X,ee,null==eE?void 0:null===(e=eE[0])||void 0===e?void 0:e.toISOString(),null==eE?void 0:null===(t=eE[1])||void 0===t?void 0:t.toISOString()],queryFn:async()=>{let e=new URLSearchParams;e.set("page",String(el)),e.set("limit",String(ed)),Q&&e.set("search",Q.trim()),q&&e.set("action_type",q),X&&e.set("entity_type",X.trim()),ee&&e.set("branch_id",ee),(null==eE?void 0:eE[0])&&e.set("start_date",eE[0].startOf("day").toISOString()),(null==eE?void 0:eE[1])&&e.set("end_date",eE[1].endOf("day").toISOString());let t=await fetch("/api/audit/logs?".concat(e.toString()),{cache:"no-store"}),E=await t.json().catch(()=>({}));if(!t.ok)throw Error(E.error||"โหลดข้อมูล Audit ไม่สำเร็จ");return{...E,data:(E.data||[]).map(e=>({...e,created_at:new Date(e.created_at)}))}},placeholderData:e=>e,staleTime:6e4}),eD=null!==(G=null===(E=ec.data)||void 0===E?void 0:E.data)&&void 0!==G?G:[],eA=null!==(k=null===(i=ec.data)||void 0===i?void 0:i.total)&&void 0!==k?k:0;(0,d.useEffect)(()=>{ec.error&&s.ZP.error(ec.error.message||"ไม่สามารถโหลดข้อมูล Audit")},[ec.error]);let eR=[{title:"เวลา",dataIndex:"created_at",width:170,render:e=>f()(e).format("DD MMM YYYY HH:mm"),sorter:(e,t)=>f()(e.created_at).valueOf()-f()(t.created_at).valueOf(),defaultSortOrder:"descend"},{title:"การกระทำ",dataIndex:"action_type",width:180,render:e=>(0,n.jsx)(o.Z,{color:z(e),style:{fontWeight:600},children:K(e)})},{title:"ผู้ใช้",dataIndex:"username",width:140,render:(e,t)=>(0,n.jsxs)(T.Z,{direction:"vertical",size:0,children:[(0,n.jsx)(H,{strong:!0,children:e||"ไม่ระบุ"}),t.user_id&&(0,n.jsx)(H,{type:"secondary",children:t.user_id.slice(0,8)})]})},{title:"สาขา",dataIndex:"branch_id",width:140,render:e=>e?(0,n.jsx)(o.Z,{color:"blue",children:e.slice(0,8)}):"-"},{title:"เป้าหมาย",dataIndex:"entity_type",width:180,render:(e,t)=>(0,n.jsxs)(T.Z,{direction:"vertical",size:0,children:[(0,n.jsx)(H,{children:t.entity_type||"-"}),t.entity_id&&(0,n.jsxs)(H,{type:"secondary",style:{fontSize:12},children:["ID: ",t.entity_id.slice(0,12)]})]})},{title:"รายละเอียด",dataIndex:"description",ellipsis:!0,render:e=>e?(0,n.jsx)(_.Z,{title:e,children:(0,n.jsx)(H,{children:e})}):(0,n.jsx)(H,{type:"secondary",children:"-"})},{title:"เส้นทาง",dataIndex:"path",width:220,render:(e,t)=>(0,n.jsxs)(T.Z,{size:8,children:[t.method&&(0,n.jsx)(o.Z,{color:"cyan",className:"audit-chip",children:t.method}),(0,n.jsx)(H,{type:"secondary",children:t.path||"-"})]})},{title:"IP / Agent",dataIndex:"ip_address",width:200,render:(e,t)=>(0,n.jsxs)(T.Z,{direction:"vertical",size:0,children:[(0,n.jsx)(H,{code:!0,children:t.ip_address}),t.user_agent&&(0,n.jsx)(H,{type:"secondary",style:{fontSize:12},ellipsis:!0,children:t.user_agent})]})},{title:"",key:"actions",fixed:"right",width:70,render:(e,t)=>(0,n.jsx)(c.ZP,{type:"link",icon:(0,n.jsx)(S.Z,{}),onClick:()=>es(t),"aria-label":"ดูรายละเอียด",children:"ดู"})}],eu=async e=>{if(e&&"undefined"!=typeof navigator&&navigator.clipboard)try{await navigator.clipboard.writeText(e),s.ZP.success("คัดลอก ID แล้ว")}catch(e){s.ZP.error("คัดลอกไม่สำเร็จ")}};return(0,n.jsxs)("div",{style:Z.container,children:[(0,n.jsx)(m,{}),(0,n.jsx)(L.Z,{title:"Audit Logs",subtitle:"ติดตามทุกการเปลี่ยนแปลงของระบบแบบละเอียด",icon:(0,n.jsx)(N.Z,{}),actions:(0,n.jsxs)(T.Z,{children:[(0,n.jsx)(c.ZP,{icon:(0,n.jsx)(P.Z,{}),onClick:()=>ec.refetch(),loading:ec.isFetching,children:"รีเฟรช"}),(0,n.jsx)(c.ZP,{icon:(0,n.jsx)(y.Z,{}),onClick:()=>{W(""),J(void 0),$(void 0),ei(null),V&&et(void 0),en(1),er(20)},disabled:0===eo,children:"ล้างตัวกรอง"})]})}),(0,n.jsxs)(v.Z,{children:[(0,n.jsx)(b.Z,{children:(0,n.jsxs)("div",{style:Z.statsGrid,children:[(0,n.jsx)(D.Z,{size:"small",style:{borderRadius:16},children:(0,n.jsx)(A.Z,{title:"จำนวน Log ทั้งหมด",value:eA,prefix:(0,n.jsx)(p.Z,{}),valueStyle:{fontWeight:700}})}),(0,n.jsx)(D.Z,{size:"small",style:{borderRadius:16},children:(0,n.jsx)(A.Z,{title:"บันทึกในหน้านี้",value:eD.length,suffix:"/ หน้า ".concat(null!==(B=null===(r=ec.data)||void 0===r?void 0:r.page)&&void 0!==B?B:1),valueStyle:{fontWeight:700}})}),(0,n.jsx)(D.Z,{size:"small",style:{borderRadius:16},children:(0,n.jsx)(A.Z,{title:"ตัวกรองที่ใช้",value:eo,suffix:"ตัว",valueStyle:{fontWeight:700,color:eo?"#fa8c16":void 0}})}),!V&&(0,n.jsx)(D.Z,{size:"small",style:{borderRadius:16},children:(0,n.jsx)(A.Z,{title:"สาขาที่กำลังดู",value:(null==F?void 0:null===(a=F.branch)||void 0===a?void 0:a.branch_name)||(null==F?void 0:F.branch_id)||"ไม่ระบุ",valueStyle:{fontWeight:700}})})]})}),(0,n.jsx)(b.Z,{title:"ตัวกรอง",extra:(0,n.jsx)(H,{type:"secondary",children:"ช่วยให้ค้นหาเหตุการณ์ได้เร็วขึ้น"}),children:(0,n.jsx)(D.Z,{style:Z.filtersCard,bodyStyle:{padding:16},children:(0,n.jsxs)(T.Z,{size:12,wrap:!0,children:[(0,n.jsx)(R.default,{allowClear:!0,style:{width:220},placeholder:"ค้นหา (ผู้ใช้, รายละเอียด, Entity)",value:Q,prefix:(0,n.jsx)(p.Z,{}),onChange:e=>W(e.target.value),onPressEnter:()=>ec.refetch()}),(0,n.jsx)(u.default,{allowClear:!0,showSearch:!0,style:{width:220},placeholder:"เลือก Action",value:q,options:eT,optionFilterProp:"label",onChange:e=>{J(e),en(1)}}),(0,n.jsx)(R.default,{allowClear:!0,style:{width:200},placeholder:"Entity type (เช่น Users, Orders)",value:X,onChange:e=>$(e.target.value)}),(0,n.jsx)(w,{allowClear:!0,value:eE,onChange:e=>{ei(e),en(1)}}),V&&(0,n.jsx)(u.default,{allowClear:!0,style:{width:220},placeholder:"เลือกสาขา",loading:e_.isLoading,value:ee,options:null===(g=e_.data)||void 0===g?void 0:g.map(e=>({label:e.branch_name,value:e.id})),onChange:e=>{et(e||void 0),en(1)}})]})})}),(0,n.jsx)(b.Z,{title:"รายการ Audit",children:(0,n.jsx)(D.Z,{style:Z.tableCard,bodyStyle:{padding:0},children:(0,n.jsx)(h.Z,{className:"audit-table",rowKey:"id",dataSource:eD,columns:eR,loading:ec.isLoading,scroll:{x:1200},pagination:{current:el,pageSize:ed,total:eA,showSizeChanger:!0,showTotal:e=>"ทั้งหมด ".concat(e," รายการ"),onChange:(e,t)=>{en(e),er(t)}},locale:{emptyText:(0,n.jsx)(C.Z,{description:(0,n.jsxs)(T.Z,{direction:"vertical",size:4,children:[(0,n.jsx)(H,{strong:!0,children:"ยังไม่มีข้อมูลที่ตรงเงื่อนไข"}),(0,n.jsx)(H,{type:"secondary",style:{fontSize:12},children:"ลองล้างตัวกรองหรือปรับช่วงเวลา"})]})})}})})})]}),(0,n.jsx)(x.Z,{className:"audit-drawer",title:(0,n.jsxs)(T.Z,{align:"center",children:[(0,n.jsx)(N.Z,{}),(0,n.jsx)("span",{children:"รายละเอียด Audit"})]}),open:!!ea,onClose:()=>es(null),width:640,children:ea&&(0,n.jsxs)(T.Z,{direction:"vertical",size:"middle",style:{width:"100%"},children:[(0,n.jsxs)(T.Z,{align:"center",wrap:!0,children:[(0,n.jsx)(o.Z,{color:z(ea.action_type),style:{fontWeight:700},children:K(ea.action_type)}),(0,n.jsx)(o.Z,{color:"blue",children:f()(ea.created_at).format("DD MMM YYYY HH:mm:ss")}),(0,n.jsx)(c.ZP,{size:"small",icon:(0,n.jsx)(j.Z,{}),onClick:()=>eu(ea.id),children:"คัดลอก ID"})]}),(0,n.jsxs)(O.Z,{size:"small",column:1,bordered:!0,children:[(0,n.jsxs)(O.Z.Item,{label:"ผู้ใช้งาน",children:[ea.username||"ไม่ระบุ"," ",ea.user_id&&(0,n.jsxs)(H,{type:"secondary",children:["(",ea.user_id,")"]})]}),(0,n.jsx)(O.Z.Item,{label:"สาขา",children:ea.branch_id||"ไม่ระบุ"}),(0,n.jsxs)(O.Z.Item,{label:"เป้าหมาย",children:[ea.entity_type||"-"," ",ea.entity_id&&(0,n.jsxs)(H,{type:"secondary",children:["(",ea.entity_id,")"]})]}),(0,n.jsx)(O.Z.Item,{label:"เส้นทาง",children:(0,n.jsxs)(T.Z,{size:8,children:[ea.method&&(0,n.jsx)(o.Z,{color:"cyan",children:ea.method}),(0,n.jsx)(H,{children:ea.path||"-"})]})}),(0,n.jsx)(O.Z.Item,{label:"IP / Agent",children:(0,n.jsxs)(T.Z,{direction:"vertical",size:4,children:[(0,n.jsx)(H,{code:!0,children:ea.ip_address}),ea.user_agent&&(0,n.jsx)(H,{type:"secondary",style:{fontSize:12},children:ea.user_agent})]})}),(0,n.jsx)(O.Z.Item,{label:"รายละเอียดเพิ่มเติม",children:ea.description||"-"})]}),(0,n.jsx)(U.Z,{children:"ค่าที่เปลี่ยนแปลง"}),(0,n.jsx)(D.Z,{size:"small",title:"ข้อมูลก่อน",bodyStyle:{padding:12},bordered:!0,children:ea.old_values?(0,n.jsx)("pre",{style:Z.jsonBlock,children:JSON.stringify(ea.old_values,null,2)}):(0,n.jsx)(H,{type:"secondary",children:"ไม่มีข้อมูลก่อนหน้า"})}),(0,n.jsx)(D.Z,{size:"small",title:"ข้อมูลหลัง",bodyStyle:{padding:12},bordered:!0,children:ea.new_values?(0,n.jsx)("pre",{style:Z.jsonBlock,children:JSON.stringify(ea.new_values,null,2)}):(0,n.jsx)(H,{type:"secondary",children:"ไม่มีข้อมูลใหม่"})})]})})]})}}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=92308)}),_N_E=e.O()}]);