(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2884],{5022:function(e,t,n){Promise.resolve().then(n.bind(n,78560))},78560:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return q}});var i=n(57437),r=n(2265),o=n(99376),a=n(82646),s=n(34029),l=n(50742),d=n(48651),c=n(53743),u=n(40312),h=n(49638),g=n(14362),p=n(24675),f=n(5447),x=n(4156),y=n(91652),b=n(80009),m=n(33477),j=n(17588),k=n(8900),v=n(52539),S=n(22623),_=n(96473);let{Text:C,Title:w}=a.default,I={container:{paddingBottom:160,backgroundColor:"#f8f9fc",minHeight:"100vh"},header:{background:"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)",padding:"20px 20px 60px 20px",position:"relative",overflow:"hidden"},headerDecoCircle1:{position:"absolute",top:-50,right:-50,width:150,height:150,borderRadius:"50%",background:"rgba(255,255,255,0.1)"},headerDecoCircle2:{position:"absolute",bottom:-30,left:-30,width:100,height:100,borderRadius:"50%",background:"rgba(255,255,255,0.08)"},headerContent:{position:"relative",zIndex:1,display:"flex",alignItems:"center",gap:12},headerIconBox:{width:48,height:48,borderRadius:14,background:"rgba(255,255,255,0.2)",display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(8px)"},statsCard:{margin:"-40px 16px 0 16px",padding:"16px",background:"white",borderRadius:20,boxShadow:"0 8px 24px rgba(0,0,0,0.08)",display:"flex",justifyContent:"space-around",position:"relative",zIndex:10},statItem:{textAlign:"center",flex:1},statNumber:{fontSize:24,fontWeight:700,display:"block"},statLabel:{fontSize:12,color:"#8c8c8c",marginTop:2},listContainer:{padding:"20px 16px 0 16px"},sectionTitle:{display:"flex",alignItems:"center",gap:8,marginBottom:16},itemCard:e=>({marginBottom:12,borderRadius:20,border:"none",boxShadow:e?"0 4px 16px rgba(82, 196, 26, 0.2)":"0 2px 8px rgba(0,0,0,0.04)",overflow:"hidden",transition:"all 0.3s ease"}),itemCardInner:e=>({padding:16,display:"flex",alignItems:"flex-start",background:e?"linear-gradient(135deg, #f6ffed 0%, #d9f7be 100%)":"white",position:"relative"}),itemCheckbox:{marginTop:6,marginRight:14,transform:"scale(1.3)"},itemInfo:{flex:1,minWidth:0},orderedTag:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",border:"none",borderRadius:12,padding:"4px 10px",color:"white",fontWeight:600,fontSize:12},quantitySection:{marginTop:10},quantityHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},quantityControls:{display:"flex",alignItems:"center",gap:8},quantityButton:{width:40,height:40,borderRadius:12,display:"flex",alignItems:"center",justifyContent:"center"},quantityInput:{flex:1,textAlign:"center",height:40,borderRadius:12,fontSize:16,fontWeight:600},floatingFooter:{position:"fixed",bottom:70,left:16,right:16,zIndex:99},confirmButton:e=>({height:56,borderRadius:28,fontWeight:700,fontSize:16,boxShadow:e?"0 8px 24px rgba(82, 196, 26, 0.4)":void 0,background:e?"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)":void 0,border:"none"}),modalStyles:{body:{padding:0},mask:{backdropFilter:"blur(8px)",background:"rgba(0, 0, 0, 0.45)"}}},T=()=>(0,i.jsx)("style",{children:"\n        .buying-page-modal .ant-modal-content {\n            border-radius: 24px !important;\n            overflow: hidden;\n            padding: 0 !important;\n        }\n        \n        @keyframes fadeSlideIn {\n            from {\n                opacity: 0;\n                transform: translateY(12px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n        \n        .purchase-item-card {\n            animation: fadeSlideIn 0.4s ease both;\n        }\n        \n        .purchase-item-card:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 24px rgba(0,0,0,0.1) !important;\n        }\n        \n        .buying-page .ant-input-number {\n            border-radius: 12px !important;\n        }\n        \n        .buying-page .ant-input-number-input {\n            text-align: center;\n            font-weight: 600;\n            font-size: 16px;\n        }\n        \n        .buying-page .ant-checkbox-inner {\n            border-radius: 6px;\n            width: 22px;\n            height: 22px;\n        }\n        \n        .buying-page .ant-checkbox-checked .ant-checkbox-inner {\n            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);\n            border-color: #52c41a;\n        }\n        \n        .buying-page .ant-checkbox-checked .ant-checkbox-inner::after {\n            left: 30%;\n        }\n        \n        /* Custom scrollbar */\n        .buying-page *::-webkit-scrollbar {\n            width: 6px;\n        }\n        .buying-page *::-webkit-scrollbar-track {\n            background: transparent;\n        }\n        .buying-page *::-webkit-scrollbar-thumb {\n            background: #d9d9d9;\n            border-radius: 3px;\n        }\n        .buying-page *::-webkit-scrollbar-thumb:hover {\n            background: #bfbfbf;\n        }\n    "}),P=e=>{let{orderId:t,onBack:n}=e;return(0,i.jsxs)("div",{style:I.header,children:[(0,i.jsx)("div",{style:I.headerDecoCircle1}),(0,i.jsx)("div",{style:I.headerDecoCircle2}),(0,i.jsxs)("div",{style:I.headerContent,children:[(0,i.jsx)(l.ZP,{type:"text",icon:(0,i.jsx)(j.Z,{style:{fontSize:20,color:"white"}}),onClick:n,style:{width:40,height:40,borderRadius:12,background:"rgba(255,255,255,0.2)",display:"flex",alignItems:"center",justifyContent:"center"}}),(0,i.jsx)("div",{style:I.headerIconBox,children:(0,i.jsx)(u.Z,{style:{fontSize:24,color:"white"}})}),(0,i.jsxs)("div",{children:[(0,i.jsx)(C,{style:{color:"rgba(255,255,255,0.85)",fontSize:13,display:"block"},children:"ทำการสั่งซื้อ"}),(0,i.jsxs)(w,{level:4,style:{color:"white",margin:0,fontWeight:700,letterSpacing:"0.5px"},children:["#",(null==t?void 0:t.substring(0,8).toUpperCase())||"..."]})]})]})]})},R=e=>{let{totalItems:t,purchasedItems:n,notPurchasedItems:r}=e;return(0,i.jsxs)("div",{style:I.statsCard,children:[(0,i.jsxs)("div",{style:I.statItem,children:[(0,i.jsx)("span",{style:{...I.statNumber,color:"#667eea"},children:t}),(0,i.jsx)(C,{style:I.statLabel,children:"รายการทั้งหมด"})]}),(0,i.jsx)("div",{style:{width:1,background:"#f0f0f0"}}),(0,i.jsxs)("div",{style:I.statItem,children:[(0,i.jsx)("span",{style:{...I.statNumber,color:"#52c41a"},children:n}),(0,i.jsx)(C,{style:I.statLabel,children:"เลือกซื้อแล้ว"})]}),(0,i.jsx)("div",{style:{width:1,background:"#f0f0f0"}}),(0,i.jsxs)("div",{style:I.statItem,children:[(0,i.jsx)("span",{style:{...I.statNumber,color:"#faad14"},children:r}),(0,i.jsx)(C,{style:I.statLabel,children:"ยังไม่เลือก"})]})]})},E=e=>{let{item:t,index:n,onCheck:r,onQuantityChange:o,onSetFullAmount:a}=e;return(0,i.jsx)("div",{className:"purchase-item-card",style:{...I.itemCard(t.is_purchased),animationDelay:"".concat(.05*n,"s")},onClick:()=>!t.is_purchased&&r(t.ingredient_id,!0),children:(0,i.jsxs)("div",{style:I.itemCardInner(t.is_purchased),children:[(0,i.jsx)(x.Z,{checked:t.is_purchased,onChange:e=>{e.stopPropagation(),r(t.ingredient_id,e.target.checked)},style:I.itemCheckbox}),(0,i.jsx)(y.Z,{src:t.img_url||"https://placehold.co/72x72/f5f5f5/999999?text=\uD83D\uDCE6",shape:"square",size:72,style:{borderRadius:16,border:t.is_purchased?"3px solid #52c41a":"3px solid white",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",marginRight:14,flexShrink:0}}),(0,i.jsxs)("div",{style:I.itemInfo,children:[(0,i.jsxs)("div",{style:{marginBottom:4},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:2},children:[(0,i.jsx)(C,{strong:!0,style:{fontSize:16,color:"#1a1a2e"},ellipsis:{tooltip:t.display_name},children:t.display_name}),t.is_purchased&&(0,i.jsx)(k.Z,{style:{color:"#52c41a",fontSize:16}})]}),t.description&&(0,i.jsx)(C,{type:"secondary",style:{fontSize:12,display:"block",marginBottom:4},ellipsis:{tooltip:t.description},children:t.description}),(0,i.jsxs)(b.Z,{style:I.orderedTag,children:["สั่ง ",t.ordered_quantity," ",t.unit_name]})]}),t.is_purchased?(0,i.jsxs)("div",{style:I.quantitySection,onClick:e=>e.stopPropagation(),children:[(0,i.jsxs)("div",{style:I.quantityHeader,children:[(0,i.jsxs)(C,{style:{fontSize:13,color:"#666"},children:["จำนวนที่ซื้อจริง (",t.unit_name,")"]}),(0,i.jsx)(l.ZP,{type:"link",size:"small",onClick:()=>a(t.ingredient_id),style:{padding:"4px 8px",fontSize:13,fontWeight:600,background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"เต็มจำนวน"})]}),(0,i.jsxs)("div",{style:I.quantityControls,children:[(0,i.jsx)(l.ZP,{icon:(0,i.jsx)(S.Z,{}),style:I.quantityButton,onClick:()=>{let e=Math.max(0,t.actual_quantity-1);o(t.ingredient_id,e)}}),(0,i.jsx)(m.Z,{min:0,value:t.actual_quantity,onChange:e=>o(t.ingredient_id,e),style:I.quantityInput,controls:!1}),(0,i.jsx)(l.ZP,{icon:(0,i.jsx)(_.Z,{}),style:I.quantityButton,onClick:()=>{let e=t.actual_quantity+1;o(t.ingredient_id,e)}})]})]}):(0,i.jsxs)(l.ZP,{size:"large",type:"dashed",block:!0,onClick:e=>{e.stopPropagation(),r(t.ingredient_id,!0)},style:{color:"#8c8c8c",borderRadius:12,marginTop:8},children:[(0,i.jsx)(v.Z,{style:{marginRight:6}}),"แตะเพื่อเลือกซื้อ"]})]})]})})},z=()=>(0,i.jsxs)("div",{style:{background:"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)",padding:"24px",position:"relative",overflow:"hidden"},children:[(0,i.jsx)("div",{style:{position:"absolute",top:-30,right:-30,width:100,height:100,borderRadius:"50%",background:"rgba(255,255,255,0.1)"}}),(0,i.jsx)("div",{style:{position:"absolute",bottom:-20,left:-20,width:70,height:70,borderRadius:"50%",background:"rgba(255,255,255,0.08)"}}),(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:12,position:"relative",zIndex:1},children:[(0,i.jsx)("div",{style:{width:44,height:44,borderRadius:14,background:"rgba(255,255,255,0.2)",display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(8px)"},children:(0,i.jsx)(k.Z,{style:{fontSize:22,color:"white"}})}),(0,i.jsxs)("div",{children:[(0,i.jsx)(C,{style:{color:"rgba(255,255,255,0.9)",fontSize:13,display:"block"},children:"ยืนยันการสั่งซื้อ"}),(0,i.jsx)(w,{level:4,style:{color:"white",margin:0,fontWeight:700},children:"สรุปรายการ"})]})]})]}),A=e=>{let{item:t,index:n}=e,r=t.actual_quantity-t.ordered_quantity;return(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:14,padding:14,background:"#fafafa",borderRadius:16,marginBottom:10,animation:"fadeSlideIn 0.3s ease ".concat(.05*n,"s both")},children:[(0,i.jsx)(y.Z,{src:t.img_url||"https://placehold.co/56x56/f5f5f5/999999?text=\uD83D\uDCE6",shape:"square",size:56,style:{borderRadius:12,border:"2px solid white",boxShadow:"0 4px 12px rgba(0,0,0,0.08)"}}),(0,i.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,i.jsx)(C,{strong:!0,style:{fontSize:15,display:"block",color:"#1a1a2e"},ellipsis:{tooltip:t.display_name},children:t.display_name}),(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:4},children:[(0,i.jsxs)(C,{style:{fontSize:13},children:["ซื้อ: ",(0,i.jsx)(C,{strong:!0,style:{color:"#52c41a"},children:t.actual_quantity})]}),(0,i.jsx)(C,{type:"secondary",children:"/"}),(0,i.jsxs)(C,{type:"secondary",style:{fontSize:13},children:["สั่ง: ",t.ordered_quantity]})]})]}),(0,i.jsxs)("div",{style:{textAlign:"right"},children:[(0,i.jsx)("div",{style:{padding:"8px 14px",borderRadius:12,fontWeight:600,fontSize:14,background:0===r?"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)":r>0?"linear-gradient(135deg, #1890ff 0%, #69c0ff 100%)":"linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%)",color:"white",minWidth:60,textAlign:"center"},children:0===r?"ครบ":r>0?"+".concat(r):r}),(0,i.jsx)(C,{style:{fontSize:11,color:"#8c8c8c",marginTop:2,display:"block"},children:t.unit_name})]})]})},O=e=>{let{count:t}=e;return(0,i.jsxs)("div",{style:{marginTop:16,padding:"14px 16px",background:"linear-gradient(135deg, #fffbe6 0%, #fff1b8 100%)",borderRadius:14,border:"1px solid #ffe58f",display:"flex",alignItems:"center",gap:10},children:[(0,i.jsx)("div",{style:{width:32,height:32,borderRadius:10,background:"#faad14",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:16,fontWeight:700},children:"!"}),(0,i.jsxs)(C,{style:{color:"#ad6800",fontSize:13},children:["มี ",(0,i.jsx)(C,{strong:!0,children:t})," รายการที่ ",(0,i.jsx)(C,{strong:!0,children:'"ไม่ได้เลือก"'})," (จะถูกบันทึกว่าไม่ได้ซื้อ)"]})]})},{Text:Z}=a.default;function q(){let e=(0,o.useSearchParams)(),t=(0,o.useRouter)(),n=e.get("orderId"),{user:a}=(0,g.a)(),[x,y]=(0,r.useState)(null),[b,m]=(0,r.useState)([]),[j,k]=(0,r.useState)(!1),[v,S]=(0,r.useState)(!1),{socket:_}=(0,p.s)(),C=(0,r.useCallback)(async()=>{try{var e;k(!0);let t=await fetch("/api/stock/orders/".concat(n),{cache:"no-store"});if(!t.ok)throw Error("Failed to load order");let i=await t.json();y(i);let r=(null===(e=i.ordersItems)||void 0===e?void 0:e.map(e=>{var t,n,i,r,o;return{ingredient_id:e.ingredient_id,actual_quantity:e.quantity_ordered,ordered_quantity:e.quantity_ordered,is_purchased:!1,display_name:(null===(t=e.ingredient)||void 0===t?void 0:t.display_name)||"Unknown",description:(null===(n=e.ingredient)||void 0===n?void 0:n.description)||"",unit_name:(null===(r=e.ingredient)||void 0===r?void 0:null===(i=r.unit)||void 0===i?void 0:i.display_name)||"-",img_url:null===(o=e.ingredient)||void 0===o?void 0:o.img_url}}))||[];m(r)}catch(e){s.ZP.error("Failed to load order")}finally{k(!1)}},[n]);(0,r.useEffect)(()=>{if(!a){t.push("/login");return}if("Admin"!==a.role&&"Manager"!==a.role){s.ZP.error("คุณไม่มีสิทธิ์เข้าถึงหน้านี้"),t.push("/items");return}n&&C()},[n,a,C,t]),(0,r.useEffect)(()=>{if(_&&n)return _.on("orders_updated",e=>{var i,r;if("update_order"===e.action&&e.data.id===n&&(C(),s.ZP.info("ออเดอร์มีการเปลี่ยนแปลงข้อมูล")),("update_status"===e.action||"delete"===e.action)&&((null===(i=e.data)||void 0===i?void 0:i.id)===n||e.id===n)){let n=null===(r=e.data)||void 0===r?void 0:r.status;"delete"===e.action?(s.ZP.warning("ออเดอร์นี้ถูกยกเลิกเสร็จสิ้นแล้ว"),t.push("/stock/items")):n&&"pending"!==n&&("completed"===n?s.ZP.success("การสั่งซื้อดำเนินการเสร็จสิ้นแล้ว"):s.ZP.warning("ออเดอร์นี้ถูกยกเลิกเสร็จสิ้นแล้ว"),t.push("/stock/items"))}}),()=>{_.off("orders_updated")}},[_,n,C,t]);let w=(e,t)=>{m(b.map(n=>n.ingredient_id===e?{...n,is_purchased:t}:n))},q=(e,t)=>{null!==t&&m(b.map(n=>n.ingredient_id===e?{...n,actual_quantity:t}:n))},D=e=>{m(b.map(t=>t.ingredient_id===e?{...t,actual_quantity:t.ordered_quantity,is_purchased:!0}:t))},[B,L]=(0,r.useState)("");(0,r.useEffect)(()=>{(async()=>{try{let e=await f.O.getCsrfToken();L(e)}catch(e){console.error("Failed to fetch CSRF token",e)}})()},[]);let N=async()=>{if(!a){s.ZP.error("User not found");return}try{k(!0);let e=b.map(e=>({ingredient_id:e.ingredient_id,actual_quantity:e.is_purchased?e.actual_quantity:0,is_purchased:e.is_purchased}));if(!(await fetch("/api/stock/orders/".concat(n,"/purchase"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":B},body:JSON.stringify({items:e,purchased_by_id:a.id})})).ok)throw Error("Failed to confirm purchase");s.ZP.success("บันทึกการสั่งซื้อเรียบร้อย"),S(!1),t.push("/stock/history")}catch(e){console.error(e),s.ZP.error("Failed to confirm purchase")}finally{k(!1)}},F=b.filter(e=>e.is_purchased),U=b.filter(e=>!e.is_purchased),M=F.length>0;return n?j&&!x?(0,i.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh"},children:(0,i.jsx)(d.Z,{size:"large"})}):(0,i.jsxs)("div",{className:"buying-page",style:I.container,children:[(0,i.jsx)(T,{}),(0,i.jsx)(P,{orderId:null==x?void 0:x.id,onBack:()=>t.back()}),(0,i.jsx)(R,{totalItems:b.length,purchasedItems:F.length,notPurchasedItems:U.length}),(0,i.jsxs)("div",{style:I.listContainer,children:[(0,i.jsxs)("div",{style:I.sectionTitle,children:[(0,i.jsx)(u.Z,{style:{fontSize:18,color:"#52c41a"}}),(0,i.jsx)(Z,{strong:!0,style:{fontSize:16,color:"#1a1a2e"},children:"รายการสินค้า"}),(0,i.jsxs)("div",{style:{background:"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)",color:"white",padding:"4px 12px",borderRadius:20,fontSize:12,fontWeight:600},children:[b.length," รายการ"]})]}),b.map((e,t)=>(0,i.jsx)(E,{item:e,index:t,onCheck:w,onQuantityChange:q,onSetFullAmount:D},e.ingredient_id))]}),(0,i.jsx)("div",{style:I.floatingFooter,children:(0,i.jsxs)(l.ZP,{type:"primary",size:"large",block:!0,icon:(0,i.jsx)(u.Z,{style:{fontSize:18}}),onClick:()=>S(!0),disabled:!M,style:I.confirmButton(M),children:["ยืนยันการสั่งซื้อ (",F.length," รายการ)"]})}),(0,i.jsxs)(c.Z,{open:v,onCancel:()=>S(!1),footer:null,width:520,centered:!0,className:"buying-page-modal",styles:I.modalStyles,closeIcon:null,children:[(0,i.jsx)(z,{}),(0,i.jsxs)("div",{style:{padding:"20px 24px 24px"},children:[(0,i.jsx)("div",{style:{maxHeight:320,overflowY:"auto",paddingRight:4,marginBottom:16},children:F.map((e,t)=>(0,i.jsx)(A,{item:e,index:t},e.ingredient_id))}),U.length>0&&(0,i.jsx)(O,{count:U.length}),(0,i.jsxs)("div",{style:{display:"flex",gap:12,marginTop:20},children:[(0,i.jsx)(l.ZP,{block:!0,size:"large",onClick:()=>S(!1),icon:(0,i.jsx)(h.Z,{}),style:{height:48,borderRadius:12,fontWeight:600},children:"กลับ"}),(0,i.jsx)(l.ZP,{type:"primary",block:!0,size:"large",onClick:N,loading:j,style:{height:48,borderRadius:12,fontWeight:600,background:"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)",border:"none",boxShadow:"0 4px 16px rgba(82, 196, 26, 0.35)"},children:"ยืนยันการสั่งซื้อ"})]})]})]})]}):(0,i.jsxs)("div",{style:{padding:24,display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh",flexDirection:"column",gap:16},children:[(0,i.jsx)(u.Z,{style:{fontSize:48,color:"#d9d9d9"}}),(0,i.jsx)(Z,{type:"secondary",children:"กรุณาเลือกออเดอร์ก่อน"}),(0,i.jsx)(l.ZP,{type:"primary",onClick:()=>t.push("/stock/items"),children:"กลับหน้าหลัก"})]})}},71567:function(e,t,n){"use strict";n.d(t,{q:function(){return r},v:function(){return i}});let i="/api",r={AUTH:{LOGIN:"/auth/login",ME:"/auth/me",CSRF:"/csrf"},POS:{PRODUCTS:"/pos/products",ORDERS:"/pos/orders",TABLES:"/pos/tables",DISCOUNTS:"/pos/discounts",DELIVERY:"/pos/delivery",PAYMENT_METHODS:"/pos/paymentMethod",PAYMENTS:"/pos/payments",CATEGORY:"/pos/category",SHIFTS:{BASE:"/pos/shifts",CURRENT:"/pos/shifts/current",OPEN:"/pos/shifts/open",CLOSE:"/pos/shifts/close"},DASHBOARD:{SALES:"/pos/dashboard/sales",TOP_ITEMS:"/pos/dashboard/top-items"},CHANNELS:{STATS:"/pos/orders/stats"},SHOP_PROFILE:"/pos/shopProfile",SALES_ORDER_ITEMS:"/pos/salesOrderItem",SALES_ORDER_DETAILS:"/pos/salesOrderDetail",PRODUCTS_UNIT:"/pos/productsUnit",PAYMENT_DETAILS:"/pos/paymentDetails",BRANCH:"/branches"}}},14362:function(e,t,n){"use strict";n.d(t,{AuthProvider:function(){return u},a:function(){return h}});var i=n(57437),r=n(2265),o=n(99376),a=n(5447),s=n(84859),l=n(48651),d=n(3369);let c=(0,r.createContext)(void 0),u=e=>{let{children:t}=e,[n,u]=(0,r.useState)(null),[h,g]=(0,r.useState)(!0),p=(0,o.useRouter)(),f=(0,o.usePathname)(),x=async()=>{try{let e="";e=localStorage.getItem("token_ws")||"";let t=await a.O.getMe(e);u(t)}catch(e){u(null)}finally{g(!1)}};(0,r.useEffect)(()=>{x()},[]);let{showLoading:y,hideLoading:b}=(0,d.x)();(0,r.useEffect)(()=>{h||n||"/login"===f||p.push("/login")},[n,h,f,p]);let m=async e=>{try{y("กำลังเข้าสู่ระบบ...");let t=await a.O.getCsrfToken(),{token:n,...i}=await a.O.login(e,t);n&&localStorage.setItem("token_ws",n),u(i),p.push("/")}catch(e){throw e}finally{b()}},j=async()=>{try{y("กำลังออกจากระบบ...");let e="";e=localStorage.getItem("token_ws")||"",await a.O.logout(e),localStorage.removeItem("token_ws"),s.x.clearQueue(),u(null),p.push("/login")}catch(e){console.error("Logout error:",e)}finally{b()}};return h?(0,i.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-white",children:(0,i.jsx)(l.Z,{size:"large"})}):n||"/login"===f?(0,i.jsx)(c.Provider,{value:{user:n,loading:h,login:m,logout:j,checkAuth:x},children:t}):null},h=()=>{let e=(0,r.useContext)(c);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},46252:function(e,t,n){"use strict";n.d(t,{J:function(){return s},SocketProvider:function(){return l}});var i=n(57437),r=n(2265),o=n(68680),a=n(14362);let s=(0,r.createContext)({socket:null,isConnected:!1}),l=e=>{let{children:t}=e,[n,l]=(0,r.useState)(null),[d,c]=(0,r.useState)(!1),{user:u}=(0,a.a)();return(0,r.useEffect)(()=>{if(!u){n&&(n.disconnect(),l(null),c(!1));return}let e=localStorage.getItem("token_ws"),t=(0,o.io)("http://localhost:3000",{transports:["websocket"],withCredentials:!0,auth:e?{token:e}:void 0});return t.on("connect",()=>{console.log("Socket Connected:",t.id),c(!0)}),t.on("disconnect",()=>{console.log("Socket Disconnected"),c(!1)}),l(t),()=>{t.disconnect()}},[u]),(0,i.jsx)(s.Provider,{value:{socket:n,isConnected:d},children:t})}},3369:function(e,t,n){"use strict";n.d(t,{GlobalLoadingProvider:function(){return l},O:function(){return c},x:function(){return d}});var i=n(57437),r=n(2265),o=n(48651);let a=(0,r.createContext)(void 0),s=(0,r.createContext)(void 0),l=e=>{let{children:t}=e,[n,l]=(0,r.useState)({}),[d,c]=(0,r.useState)(void 0),u=(0,r.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";l(e=>({...e,[t]:(e[t]||0)+1})),e&&c(e)},[]),h=(0,r.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";l(t=>{if(!t[e])return t;let n={...t};return n[e]-=1,n[e]<=0&&delete n[e],n})},[]),g=(0,r.useCallback)(()=>{l({}),c(void 0)},[]),p=Object.keys(n).length>0,f=(0,r.useMemo)(()=>({isLoading:p,loadingMessage:d}),[p,d]),x=(0,r.useMemo)(()=>({showLoading:u,hideLoading:h,resetLoading:g}),[u,h,g]);return(0,i.jsx)(s.Provider,{value:x,children:(0,i.jsxs)(a.Provider,{value:f,children:[t,p&&(0,i.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center pointer-events-auto bg-black/10 backdrop-blur-[1px]",children:(0,i.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:10,background:"rgba(255, 255, 255, 0.9)",padding:"20px 40px",borderRadius:12,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[(0,i.jsx)(o.Z,{size:"large"}),d&&(0,i.jsx)("div",{style:{fontSize:14,color:"#1f1f1f",fontWeight:500},children:d})]})})]})})};function d(){let e=(0,r.useContext)(a),t=(0,r.useContext)(s);if(!e||!t)throw Error("useGlobalLoading must be used within a GlobalLoadingProvider");return(0,r.useMemo)(()=>({...e,...t}),[e,t])}function c(){let e=(0,r.useContext)(s);if(!e)throw Error("useGlobalLoadingDispatch must be used within a GlobalLoadingProvider");return e}},24675:function(e,t,n){"use strict";n.d(t,{s:function(){return o}});var i=n(2265),r=n(46252);let o=()=>(0,i.useContext)(r.J)},2913:function(e,t,n){"use strict";function i(e,t){return({GET:"".concat(r.API_BASE_URL).concat(t),POST:"".concat(r.API_BASE_URL).concat(t),PUT:"".concat(r.API_BASE_URL).concat(t),DELETE:"".concat(r.API_BASE_URL).concat(t),PATCH:"".concat(r.API_BASE_URL).concat(t)})[e]}n.d(t,{b:function(){return i}});let r={get API_BASE_URL(){return"/api"}}},5447:function(e,t,n){"use strict";n.d(t,{O:function(){return o}});var i=n(71567),r=n(2913);let o={login:async(e,t,n)=>{try{let o=(0,r.b)("POST",i.q.AUTH.LOGIN),a={"Content-Type":"application/json"};t&&(a["X-CSRF-Token"]=t),n&&(a.Cookie=n);let s=await fetch(o,{method:"POST",headers:a,credentials:"include",body:JSON.stringify(e)});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.message||e.detail||"เข้าสู่ระบบไม่สำเร็จ")}let l=await s.json();return{...l.user,token:l.token}}catch(e){throw Error(e.message||"เข้าสู่ระบบไม่สำเร็จ")}},logout:async(e,t,n)=>{try{let i=(0,r.b)("POST","/auth/logout"),o={"Content-Type":"application/json"};e&&(o.Authorization="Bearer ".concat(e)),t&&(o["X-CSRF-Token"]=t),n&&(o.Cookie=n),await fetch(i,{method:"POST",headers:o,credentials:"include"})}catch(e){console.error("Logout failed",e)}},getMe:async e=>{try{let t=(0,r.b)("GET",i.q.AUTH.ME),n=await fetch(t,{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},credentials:"include",cache:"no-store"});if(!n.ok)throw Error("Unauthorized");return await n.json()}catch(e){throw e}},async getCsrfToken(){try{let e=await fetch("".concat(i.v).concat(i.q.AUTH.CSRF),{credentials:"include"});if(!e.ok)return"";return(await e.json()).csrfToken}catch(e){return console.error("Failed to fetch CSRF token",e),""}}}},84859:function(e,t,n){"use strict";n.d(t,{M:function(){return s},x:function(){return a}});let i="pos_offline_queue",r=()=>{let e=localStorage.getItem(i);return e?JSON.parse(e):[]},o=e=>{localStorage.setItem(i,JSON.stringify(e))},a={addToQueue:(e,t)=>{let n=r(),i={id:"offline-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),type:e,payload:t,timestamp:Date.now(),retryCount:0};return o([...n,i]),i},getQueue:()=>r(),removeFromQueue:e=>{o(r().filter(t=>t.id!==e))},incrementRetry:(e,t)=>{o(r().map(n=>n.id===e?{...n,retryCount:n.retryCount+1,lastError:t}:n))},clearQueue:()=>{localStorage.removeItem(i)},pruneExceeded:()=>{o(r().filter(e=>e.retryCount<=5))}},s={maxRetry:5,backoff:e=>Math.min(3e4,2e3*e)}}},function(e){e.O(0,[5015,7717,7698,742,3211,7993,8651,2646,6207,7213,9021,2224,3248,1721,9,1652,4547,9550,2971,2117,1744],function(){return e(e.s=5022)}),_N_E=e.O()}]);