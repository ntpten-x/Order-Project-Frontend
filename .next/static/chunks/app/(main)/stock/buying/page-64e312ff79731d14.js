(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2884],{5022:function(e,t,i){Promise.resolve().then(i.bind(i,78560))},78560:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return F}});var n=i(57437),r=i(2265),a=i(99376),d=i(19683),s=i(34029),o=i(50742),l=i(48651),c=i(53743),g=i(40312),p=i(49638),h=i(14362),u=i(24675),x=i(5447),y=i(4156),f=i(91652),b=i(80009),m=i(90136),j=i(17588),k=i(8900),v=i(52539),_=i(22623),C=i(96473);let{Text:w,Title:S}=d.default,I={container:{paddingBottom:160,backgroundColor:"#f8f9fc",minHeight:"100vh"},header:{background:"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)",padding:"20px 20px 60px 20px",position:"relative",overflow:"hidden"},headerDecoCircle1:{position:"absolute",top:-50,right:-50,width:150,height:150,borderRadius:"50%",background:"rgba(255,255,255,0.1)"},headerDecoCircle2:{position:"absolute",bottom:-30,left:-30,width:100,height:100,borderRadius:"50%",background:"rgba(255,255,255,0.08)"},headerContent:{position:"relative",zIndex:1,display:"flex",alignItems:"center",gap:12},headerIconBox:{width:48,height:48,borderRadius:14,background:"rgba(255,255,255,0.2)",display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(8px)"},statsCard:{margin:"-40px 16px 0 16px",padding:"16px",background:"white",borderRadius:20,boxShadow:"0 8px 24px rgba(0,0,0,0.08)",display:"flex",justifyContent:"space-around",position:"relative",zIndex:10},statItem:{textAlign:"center",flex:1},statNumber:{fontSize:24,fontWeight:700,display:"block"},statLabel:{fontSize:12,color:"#8c8c8c",marginTop:2},listContainer:{padding:"20px 16px 0 16px"},sectionTitle:{display:"flex",alignItems:"center",gap:8,marginBottom:16},itemCard:e=>({marginBottom:12,borderRadius:20,border:"none",boxShadow:e?"0 4px 16px rgba(82, 196, 26, 0.2)":"0 2px 8px rgba(0,0,0,0.04)",overflow:"hidden",transition:"all 0.3s ease"}),itemCardInner:e=>({padding:16,display:"flex",alignItems:"flex-start",background:e?"linear-gradient(135deg, #f6ffed 0%, #d9f7be 100%)":"white",position:"relative"}),itemCheckbox:{marginTop:6,marginRight:14,transform:"scale(1.3)"},itemInfo:{flex:1,minWidth:0},orderedTag:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",border:"none",borderRadius:12,padding:"4px 10px",color:"white",fontWeight:600,fontSize:12},quantitySection:{marginTop:10},quantityHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},quantityControls:{display:"flex",alignItems:"center",gap:8},quantityButton:{width:40,height:40,borderRadius:12,display:"flex",alignItems:"center",justifyContent:"center"},quantityInput:{flex:1,textAlign:"center",height:40,borderRadius:12,fontSize:16,fontWeight:600},floatingFooter:{position:"fixed",bottom:70,left:16,right:16,zIndex:99},confirmButton:e=>({height:56,borderRadius:28,fontWeight:700,fontSize:16,boxShadow:e?"0 8px 24px rgba(82, 196, 26, 0.4)":void 0,background:e?"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)":void 0,border:"none"}),modalStyles:{body:{padding:0},mask:{backdropFilter:"blur(8px)",background:"rgba(0, 0, 0, 0.45)"}}},z=()=>(0,n.jsx)("style",{children:"\n        .buying-page-modal .ant-modal-content {\n            border-radius: 24px !important;\n            overflow: hidden;\n            padding: 0 !important;\n        }\n        \n        @keyframes fadeSlideIn {\n            from {\n                opacity: 0;\n                transform: translateY(12px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n        \n        .purchase-item-card {\n            animation: fadeSlideIn 0.4s ease both;\n        }\n        \n        .purchase-item-card:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 24px rgba(0,0,0,0.1) !important;\n        }\n        \n        .buying-page .ant-input-number {\n            border-radius: 12px !important;\n        }\n        \n        .buying-page .ant-input-number-input {\n            text-align: center;\n            font-weight: 600;\n            font-size: 16px;\n        }\n        \n        .buying-page .ant-checkbox-inner {\n            border-radius: 6px;\n            width: 22px;\n            height: 22px;\n        }\n        \n        .buying-page .ant-checkbox-checked .ant-checkbox-inner {\n            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);\n            border-color: #52c41a;\n        }\n        \n        .buying-page .ant-checkbox-checked .ant-checkbox-inner::after {\n            left: 30%;\n        }\n        \n        /* Custom scrollbar */\n        .buying-page *::-webkit-scrollbar {\n            width: 6px;\n        }\n        .buying-page *::-webkit-scrollbar-track {\n            background: transparent;\n        }\n        .buying-page *::-webkit-scrollbar-thumb {\n            background: #d9d9d9;\n            border-radius: 3px;\n        }\n        .buying-page *::-webkit-scrollbar-thumb:hover {\n            background: #bfbfbf;\n        }\n    "}),Z=e=>{let{orderId:t,onBack:i}=e;return(0,n.jsxs)("div",{style:I.header,children:[(0,n.jsx)("div",{style:I.headerDecoCircle1}),(0,n.jsx)("div",{style:I.headerDecoCircle2}),(0,n.jsxs)("div",{style:I.headerContent,children:[(0,n.jsx)(o.ZP,{type:"text",icon:(0,n.jsx)(j.Z,{style:{fontSize:20,color:"white"}}),onClick:i,style:{width:40,height:40,borderRadius:12,background:"rgba(255,255,255,0.2)",display:"flex",alignItems:"center",justifyContent:"center"}}),(0,n.jsx)("div",{style:I.headerIconBox,children:(0,n.jsx)(g.Z,{style:{fontSize:24,color:"white"}})}),(0,n.jsxs)("div",{children:[(0,n.jsx)(w,{style:{color:"rgba(255,255,255,0.85)",fontSize:13,display:"block"},children:"ทำการสั่งซื้อ"}),(0,n.jsxs)(S,{level:4,style:{color:"white",margin:0,fontWeight:700,letterSpacing:"0.5px"},children:["#",(null==t?void 0:t.substring(0,8).toUpperCase())||"..."]})]})]})]})},q=e=>{let{totalItems:t,purchasedItems:i,notPurchasedItems:r}=e;return(0,n.jsxs)("div",{style:I.statsCard,children:[(0,n.jsxs)("div",{style:I.statItem,children:[(0,n.jsx)("span",{style:{...I.statNumber,color:"#667eea"},children:t}),(0,n.jsx)(w,{style:I.statLabel,children:"รายการทั้งหมด"})]}),(0,n.jsx)("div",{style:{width:1,background:"#f0f0f0"}}),(0,n.jsxs)("div",{style:I.statItem,children:[(0,n.jsx)("span",{style:{...I.statNumber,color:"#52c41a"},children:i}),(0,n.jsx)(w,{style:I.statLabel,children:"เลือกซื้อแล้ว"})]}),(0,n.jsx)("div",{style:{width:1,background:"#f0f0f0"}}),(0,n.jsxs)("div",{style:I.statItem,children:[(0,n.jsx)("span",{style:{...I.statNumber,color:"#faad14"},children:r}),(0,n.jsx)(w,{style:I.statLabel,children:"ยังไม่เลือก"})]})]})},R=e=>{let{item:t,index:i,onCheck:r,onQuantityChange:a,onSetFullAmount:d}=e;return(0,n.jsx)("div",{className:"purchase-item-card",style:{...I.itemCard(t.is_purchased),animationDelay:"".concat(.05*i,"s")},onClick:()=>!t.is_purchased&&r(t.ingredient_id,!0),children:(0,n.jsxs)("div",{style:I.itemCardInner(t.is_purchased),children:[(0,n.jsx)(y.Z,{checked:t.is_purchased,onChange:e=>{e.stopPropagation(),r(t.ingredient_id,e.target.checked)},style:I.itemCheckbox}),(0,n.jsx)(f.Z,{src:t.img_url||"https://placehold.co/72x72/f5f5f5/999999?text=\uD83D\uDCE6",shape:"square",size:72,style:{borderRadius:16,border:t.is_purchased?"3px solid #52c41a":"3px solid white",boxShadow:"0 4px 12px rgba(0,0,0,0.08)",marginRight:14,flexShrink:0}}),(0,n.jsxs)("div",{style:I.itemInfo,children:[(0,n.jsxs)("div",{style:{marginBottom:4},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:2},children:[(0,n.jsx)(w,{strong:!0,style:{fontSize:16,color:"#1a1a2e"},ellipsis:{tooltip:t.display_name},children:t.display_name}),t.is_purchased&&(0,n.jsx)(k.Z,{style:{color:"#52c41a",fontSize:16}})]}),t.description&&(0,n.jsx)(w,{type:"secondary",style:{fontSize:12,display:"block",marginBottom:4},ellipsis:{tooltip:t.description},children:t.description}),(0,n.jsxs)(b.Z,{style:I.orderedTag,children:["สั่ง ",t.ordered_quantity," ",t.unit_name]})]}),t.is_purchased?(0,n.jsxs)("div",{style:I.quantitySection,onClick:e=>e.stopPropagation(),children:[(0,n.jsxs)("div",{style:I.quantityHeader,children:[(0,n.jsxs)(w,{style:{fontSize:13,color:"#666"},children:["จำนวนที่ซื้อจริง (",t.unit_name,")"]}),(0,n.jsx)(o.ZP,{type:"link",size:"small",onClick:()=>d(t.ingredient_id),style:{padding:"4px 8px",fontSize:13,fontWeight:600,background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"เต็มจำนวน"})]}),(0,n.jsxs)("div",{style:I.quantityControls,children:[(0,n.jsx)(o.ZP,{icon:(0,n.jsx)(_.Z,{}),style:I.quantityButton,onClick:()=>{let e=Math.max(0,t.actual_quantity-1);a(t.ingredient_id,e)}}),(0,n.jsx)(m.Z,{min:0,value:t.actual_quantity,onChange:e=>a(t.ingredient_id,e),style:I.quantityInput,controls:!1}),(0,n.jsx)(o.ZP,{icon:(0,n.jsx)(C.Z,{}),style:I.quantityButton,onClick:()=>{let e=t.actual_quantity+1;a(t.ingredient_id,e)}})]})]}):(0,n.jsxs)(o.ZP,{size:"large",type:"dashed",block:!0,onClick:e=>{e.stopPropagation(),r(t.ingredient_id,!0)},style:{color:"#8c8c8c",borderRadius:12,marginTop:8},children:[(0,n.jsx)(v.Z,{style:{marginRight:6}}),"แตะเพื่อเลือกซื้อ"]})]})]})})},P=()=>(0,n.jsxs)("div",{style:{background:"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)",padding:"24px",position:"relative",overflow:"hidden"},children:[(0,n.jsx)("div",{style:{position:"absolute",top:-30,right:-30,width:100,height:100,borderRadius:"50%",background:"rgba(255,255,255,0.1)"}}),(0,n.jsx)("div",{style:{position:"absolute",bottom:-20,left:-20,width:70,height:70,borderRadius:"50%",background:"rgba(255,255,255,0.08)"}}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:12,position:"relative",zIndex:1},children:[(0,n.jsx)("div",{style:{width:44,height:44,borderRadius:14,background:"rgba(255,255,255,0.2)",display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(8px)"},children:(0,n.jsx)(k.Z,{style:{fontSize:22,color:"white"}})}),(0,n.jsxs)("div",{children:[(0,n.jsx)(w,{style:{color:"rgba(255,255,255,0.9)",fontSize:13,display:"block"},children:"ยืนยันการสั่งซื้อ"}),(0,n.jsx)(S,{level:4,style:{color:"white",margin:0,fontWeight:700},children:"สรุปรายการ"})]})]})]}),B=e=>{let{item:t,index:i}=e,r=t.actual_quantity-t.ordered_quantity;return(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:14,padding:14,background:"#fafafa",borderRadius:16,marginBottom:10,animation:"fadeSlideIn 0.3s ease ".concat(.05*i,"s both")},children:[(0,n.jsx)(f.Z,{src:t.img_url||"https://placehold.co/56x56/f5f5f5/999999?text=\uD83D\uDCE6",shape:"square",size:56,style:{borderRadius:12,border:"2px solid white",boxShadow:"0 4px 12px rgba(0,0,0,0.08)"}}),(0,n.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,n.jsx)(w,{strong:!0,style:{fontSize:15,display:"block",color:"#1a1a2e"},ellipsis:{tooltip:t.display_name},children:t.display_name}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:4},children:[(0,n.jsxs)(w,{style:{fontSize:13},children:["ซื้อ: ",(0,n.jsx)(w,{strong:!0,style:{color:"#52c41a"},children:t.actual_quantity})]}),(0,n.jsx)(w,{type:"secondary",children:"/"}),(0,n.jsxs)(w,{type:"secondary",style:{fontSize:13},children:["สั่ง: ",t.ordered_quantity]})]})]}),(0,n.jsxs)("div",{style:{textAlign:"right"},children:[(0,n.jsx)("div",{style:{padding:"8px 14px",borderRadius:12,fontWeight:600,fontSize:14,background:0===r?"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)":r>0?"linear-gradient(135deg, #1890ff 0%, #69c0ff 100%)":"linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%)",color:"white",minWidth:60,textAlign:"center"},children:0===r?"ครบ":r>0?"+".concat(r):r}),(0,n.jsx)(w,{style:{fontSize:11,color:"#8c8c8c",marginTop:2,display:"block"},children:t.unit_name})]})]})},T=e=>{let{count:t}=e;return(0,n.jsxs)("div",{style:{marginTop:16,padding:"14px 16px",background:"linear-gradient(135deg, #fffbe6 0%, #fff1b8 100%)",borderRadius:14,border:"1px solid #ffe58f",display:"flex",alignItems:"center",gap:10},children:[(0,n.jsx)("div",{style:{width:32,height:32,borderRadius:10,background:"#faad14",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:16,fontWeight:700},children:"!"}),(0,n.jsxs)(w,{style:{color:"#ad6800",fontSize:13},children:["มี ",(0,n.jsx)(w,{strong:!0,children:t})," รายการที่ ",(0,n.jsx)(w,{strong:!0,children:'"ไม่ได้เลือก"'})," (จะถูกบันทึกว่าไม่ได้ซื้อ)"]})]})},{Text:W}=d.default;function F(){let e=(0,a.useSearchParams)(),t=(0,a.useRouter)(),i=e.get("orderId"),{user:d}=(0,h.a)(),[y,f]=(0,r.useState)(null),[b,m]=(0,r.useState)([]),[j,k]=(0,r.useState)(!1),[v,_]=(0,r.useState)(!1),{socket:C}=(0,u.s)(),w=(0,r.useCallback)(async()=>{try{var e;k(!0);let t=await fetch("/api/stock/orders/".concat(i),{cache:"no-store"});if(!t.ok)throw Error("Failed to load order");let n=await t.json();f(n);let r=(null===(e=n.ordersItems)||void 0===e?void 0:e.map(e=>{var t,i,n,r,a;return{ingredient_id:e.ingredient_id,actual_quantity:e.quantity_ordered,ordered_quantity:e.quantity_ordered,is_purchased:!1,display_name:(null===(t=e.ingredient)||void 0===t?void 0:t.display_name)||"Unknown",description:(null===(i=e.ingredient)||void 0===i?void 0:i.description)||"",unit_name:(null===(r=e.ingredient)||void 0===r?void 0:null===(n=r.unit)||void 0===n?void 0:n.display_name)||"-",img_url:null===(a=e.ingredient)||void 0===a?void 0:a.img_url}}))||[];m(r)}catch(e){s.ZP.error("Failed to load order")}finally{k(!1)}},[i]);(0,r.useEffect)(()=>{if(!d){t.push("/login");return}if("Admin"!==d.role&&"Manager"!==d.role){s.ZP.error("คุณไม่มีสิทธิ์เข้าถึงหน้านี้"),t.push("/items");return}i&&w()},[i,d,w,t]),(0,r.useEffect)(()=>{if(C&&i)return C.on("orders_updated",e=>{var n,r;if("update_order"===e.action&&e.data.id===i&&(w(),s.ZP.info("ออเดอร์มีการเปลี่ยนแปลงข้อมูล")),("update_status"===e.action||"delete"===e.action)&&((null===(n=e.data)||void 0===n?void 0:n.id)===i||e.id===i)){let i=null===(r=e.data)||void 0===r?void 0:r.status;"delete"===e.action?(s.ZP.warning("ออเดอร์นี้ถูกยกเลิกเสร็จสิ้นแล้ว"),t.push("/stock/items")):i&&"pending"!==i&&("completed"===i?s.ZP.success("การสั่งซื้อดำเนินการเสร็จสิ้นแล้ว"):s.ZP.warning("ออเดอร์นี้ถูกยกเลิกเสร็จสิ้นแล้ว"),t.push("/stock/items"))}}),()=>{C.off("orders_updated")}},[C,i,w,t]);let S=(e,t)=>{m(b.map(i=>i.ingredient_id===e?{...i,is_purchased:t}:i))},F=(e,t)=>{null!==t&&m(b.map(i=>i.ingredient_id===e?{...i,actual_quantity:t}:i))},D=e=>{m(b.map(t=>t.ingredient_id===e?{...t,actual_quantity:t.ordered_quantity,is_purchased:!0}:t))},[N,E]=(0,r.useState)("");(0,r.useEffect)(()=>{(async()=>{try{let e=await x.O.getCsrfToken();E(e)}catch(e){console.error("Failed to fetch CSRF token",e)}})()},[]);let A=async()=>{if(!d){s.ZP.error("User not found");return}try{k(!0);let e=b.map(e=>({ingredient_id:e.ingredient_id,actual_quantity:e.is_purchased?e.actual_quantity:0,is_purchased:e.is_purchased}));if(!(await fetch("/api/stock/orders/".concat(i,"/purchase"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":N},body:JSON.stringify({items:e,purchased_by_id:d.id})})).ok)throw Error("Failed to confirm purchase");s.ZP.success("บันทึกการสั่งซื้อเรียบร้อย"),_(!1),t.push("/stock/history")}catch(e){console.error(e),s.ZP.error("Failed to confirm purchase")}finally{k(!1)}},H=b.filter(e=>e.is_purchased),O=b.filter(e=>!e.is_purchased),L=H.length>0;return i?j&&!y?(0,n.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh"},children:(0,n.jsx)(l.Z,{size:"large"})}):(0,n.jsxs)("div",{className:"buying-page",style:I.container,children:[(0,n.jsx)(z,{}),(0,n.jsx)(Z,{orderId:null==y?void 0:y.id,onBack:()=>t.back()}),(0,n.jsx)(q,{totalItems:b.length,purchasedItems:H.length,notPurchasedItems:O.length}),(0,n.jsxs)("div",{style:I.listContainer,children:[(0,n.jsxs)("div",{style:I.sectionTitle,children:[(0,n.jsx)(g.Z,{style:{fontSize:18,color:"#52c41a"}}),(0,n.jsx)(W,{strong:!0,style:{fontSize:16,color:"#1a1a2e"},children:"รายการสินค้า"}),(0,n.jsxs)("div",{style:{background:"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)",color:"white",padding:"4px 12px",borderRadius:20,fontSize:12,fontWeight:600},children:[b.length," รายการ"]})]}),b.map((e,t)=>(0,n.jsx)(R,{item:e,index:t,onCheck:S,onQuantityChange:F,onSetFullAmount:D},e.ingredient_id))]}),(0,n.jsx)("div",{style:I.floatingFooter,children:(0,n.jsxs)(o.ZP,{type:"primary",size:"large",block:!0,icon:(0,n.jsx)(g.Z,{style:{fontSize:18}}),onClick:()=>_(!0),disabled:!L,style:I.confirmButton(L),children:["ยืนยันการสั่งซื้อ (",H.length," รายการ)"]})}),(0,n.jsxs)(c.Z,{open:v,onCancel:()=>_(!1),footer:null,width:520,centered:!0,className:"buying-page-modal",styles:I.modalStyles,closeIcon:null,children:[(0,n.jsx)(P,{}),(0,n.jsxs)("div",{style:{padding:"20px 24px 24px"},children:[(0,n.jsx)("div",{style:{maxHeight:320,overflowY:"auto",paddingRight:4,marginBottom:16},children:H.map((e,t)=>(0,n.jsx)(B,{item:e,index:t},e.ingredient_id))}),O.length>0&&(0,n.jsx)(T,{count:O.length}),(0,n.jsxs)("div",{style:{display:"flex",gap:12,marginTop:20},children:[(0,n.jsx)(o.ZP,{block:!0,size:"large",onClick:()=>_(!1),icon:(0,n.jsx)(p.Z,{}),style:{height:48,borderRadius:12,fontWeight:600},children:"กลับ"}),(0,n.jsx)(o.ZP,{type:"primary",block:!0,size:"large",onClick:A,loading:j,style:{height:48,borderRadius:12,fontWeight:600,background:"linear-gradient(135deg, #52c41a 0%, #73d13d 100%)",border:"none",boxShadow:"0 4px 16px rgba(82, 196, 26, 0.35)"},children:"ยืนยันการสั่งซื้อ"})]})]})]})]}):(0,n.jsxs)("div",{style:{padding:24,display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh",flexDirection:"column",gap:16},children:[(0,n.jsx)(g.Z,{style:{fontSize:48,color:"#d9d9d9"}}),(0,n.jsx)(W,{type:"secondary",children:"กรุณาเลือกออเดอร์ก่อน"}),(0,n.jsx)(o.ZP,{type:"primary",onClick:()=>t.push("/stock/items"),children:"กลับหน้าหลัก"})]})}}},function(e){e.O(0,[8024,4736,8592,1744],function(){return e(e.s=5022)}),_N_E=e.O()}]);