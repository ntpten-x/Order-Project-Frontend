(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5277],{78923:function(e,t,r){Promise.resolve().then(r.bind(r,95597))},95597:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return j}});var n=r(57437),a=r(2265),o=r(13817),i=r(99376),s=r(92190),c=r(35631),l=r(50742),d=r(5311),u=r(52539),p=r(38434),f=r(84588),h=r(1915),g=r(15424),y=r(39760),b=r(14362),m=r(24675),x=r(76155),k=r(9771),v=r(12028),w=()=>{let e=(0,i.useRouter)(),t=(0,i.usePathname)(),{user:r}=(0,b.a)(),[o,w]=(0,a.useState)(0),[S,j]=(0,a.useState)(!1),{socket:C}=(0,m.s)(),O=(0,a.useCallback)(async()=>{try{let e=new URLSearchParams;e.append("status","pending"),e.append("t",Date.now().toString());let t=await x.x.getAllOrders(void 0,e);w(t.total)}catch(e){}},[]);(0,a.useEffect)(()=>{r&&O()},[r,O]),(0,a.useEffect)(()=>{if(!C)return;let e=()=>setTimeout(O,500),t=t=>{((null==t?void 0:t.action)==="create"||(null==t?void 0:t.action)==="update_status")&&e()};C.on(v.b.stockOrders.create,e),C.on(v.b.stockOrders.status,e),C.on(v.b.stockOrders.delete,e),C.on(v.g.stockOrdersUpdated,t);let r=()=>O();return window.addEventListener("focus",r),()=>{C.off(v.b.stockOrders.create,e),C.off(v.b.stockOrders.status,e),C.off(v.b.stockOrders.delete,e),C.off(v.g.stockOrdersUpdated,t),window.removeEventListener("focus",r)}},[C,O]);let P=[{key:"home",label:"หน้าแรก",icon:(0,n.jsx)(d.Z,{}),path:"/"},{key:"shopping",label:"สั่งซื้อ",icon:(0,n.jsx)(u.Z,{}),path:"/stock"},{key:"orders",label:"รายการ",icon:(0,n.jsx)(p.Z,{}),path:"/stock/items"},{key:"history",label:"ประวัติ",icon:(0,n.jsx)(f.Z,{}),path:"/stock/history"},...(null==r?void 0:r.role)==="Admin"||(null==r?void 0:r.role)==="Manager"?[{key:"ingredients",label:"วัตถุดิบ",icon:(0,n.jsx)(h.Z,{}),path:"/stock/ingredients"},{key:"ingredientsUnit",label:"หน่วย",icon:(0,n.jsx)(g.Z,{}),path:"/stock/ingredientsUnit"}]:[]],E=e=>"/"===e?"/"===t:t===e||t.startsWith(e+"/"),T=P.slice(0,4),I=P.slice(4),Z=I.some(e=>E(e.path));return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(k.Z,{maxWidth:560,items:[...T.map(t=>({key:t.key,label:t.label,icon:t.icon,onClick:()=>e.push(t.path),active:E(t.path),badgeDot:"orders"===t.key&&o>0})),...I.length?[{key:"more",label:"เพิ่มเติม",icon:(0,n.jsx)(y.Z,{}),onClick:()=>j(!0),active:Z}]:[]]}),(0,n.jsx)(s.Z,{open:S,onClose:()=>j(!1),placement:"bottom",height:"auto",title:"เมนูเพิ่มเติม",zIndex:2e3,children:(0,n.jsx)("div",{style:{paddingBottom:"calc(12px + env(safe-area-inset-bottom))"},children:(0,n.jsx)(c.Z,{dataSource:I,renderItem:t=>(0,n.jsx)(c.Z.Item,{style:{paddingInline:0},children:(0,n.jsx)(l.ZP,{type:"text",block:!0,icon:t.icon,style:{height:48,justifyContent:"flex-start"},onClick:()=>{e.push(t.path),j(!1)},children:t.label})})})})})]})},S=r(30736);function j(e){let{children:t}=e;return(0,n.jsx)(S.Z,{children:(0,n.jsxs)(o.default,{style:{minHeight:"100%",background:"transparent"},children:[(0,n.jsx)(o.default.Content,{style:{background:"transparent"},children:t}),(0,n.jsx)(w,{})]})})}},9771:function(e,t,r){"use strict";r.d(t,{Z:function(){return p}});var n=r(57437);r(2265);var a=r(39486),o=r(2651),i=r(38616),s=r(96931),c=r(35713),l=r(50742),d=r(63362);let{Text:u}=a.default;function p(e){let{items:t,maxWidth:r=440,bottomOffset:a=d.w}=e,{token:p}=o.default.useToken(),f=!i.default.useBreakpoint().md;return(0,n.jsx)("div",{style:{position:"fixed",left:"50%",transform:"translateX(-50%)",bottom:"calc(".concat(a,"px + env(safe-area-inset-bottom))"),width:"calc(100% - 24px)",maxWidth:r,zIndex:900},"aria-label":"Bottom navigation",children:(0,n.jsx)(s.Z,{size:"small",variant:"outlined",bodyStyle:{padding:8,display:"grid",gridTemplateColumns:"repeat(".concat(t.length,", minmax(0, 1fr))"),gap:4},style:{borderRadius:f?18:22,borderColor:p.colorBorderSecondary,background:"rgba(255, 255, 255, 0.92)",backdropFilter:"blur(12px)",boxShadow:p.boxShadowSecondary},children:t.map(e=>{var t,r;let a=!!e.active,o=a?p.colorPrimary:p.colorTextSecondary,i=a?p.colorPrimary:p.colorTextSecondary,s=(0,n.jsx)("span",{style:{fontSize:22,lineHeight:1,color:o},children:e.icon}),d=e.badgeDot||(null!==(t=e.badgeCount)&&void 0!==t?t:0)>0?(0,n.jsx)(c.Z,{dot:e.badgeDot,count:e.badgeCount,size:"small",children:s}):s;return(0,n.jsxs)(l.ZP,{type:"text",disabled:e.disabled,"aria-label":null!==(r=e.ariaLabel)&&void 0!==r?r:e.label,"aria-current":a?"page":void 0,onClick:e.onClick,style:{height:f?64:68,paddingInline:0,borderRadius:16,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:4,background:a?p.colorPrimaryBg:"transparent"},children:[d,(0,n.jsx)(u,{style:{fontSize:11,fontWeight:a?600:500,color:i,lineHeight:1},children:e.label})]},e.key)})})})}},63362:function(e,t,r){"use strict";r.d(t,{o:function(){return a},w:function(){return n}});let n=16,a=108},14362:function(e,t,r){"use strict";r.d(t,{AuthProvider:function(){return p},a:function(){return f}});var n=r(57437),a=r(2265),o=r(99376),i=r(5447),s=r(84859),c=r(48651),l=r(3369),d=r(36799);let u=(0,a.createContext)(void 0),p=e=>{let{children:t}=e,[r,p]=(0,a.useState)(null),[f,h]=(0,a.useState)(!0),g=(0,o.useRouter)(),y=(0,o.usePathname)(),b=async()=>{try{let e=await i.O.getMe();p(e)}catch(e){p(null)}finally{h(!1)}};(0,a.useEffect)(()=>{b()},[]);let{showLoading:m,hideLoading:x}=(0,l.x)();(0,a.useEffect)(()=>{f||r||"/login"===y||g.push("/login")},[r,f,y,g]);let k=async e=>{try{m((0,d.t)("auth.loadingLogin"));let t=await i.O.getCsrfToken(),{token:r,...n}=await i.O.login(e,t);p(n),g.push("/")}catch(e){throw e}finally{x()}},v=async()=>{try{m((0,d.t)("auth.loadingLogout")),await i.O.logout(),s.x.clearQueue(),p(null),g.push("/login")}catch(e){console.error("Logout error:",e)}finally{x()}};return f?(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",background:"#ffffff"},children:(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"12px",padding:"24px",background:"#ffffff",borderRadius:"20px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.1)"},children:[(0,n.jsx)(c.Z,{size:"large"}),(0,n.jsx)("div",{style:{color:"#64748b",fontSize:"14px",fontWeight:500},children:"กำลังตรวจสอบสิทธิ์..."})]})}):r||"/login"===y?(0,n.jsx)(u.Provider,{value:{user:r,loading:f,login:k,logout:v,checkAuth:b},children:t}):null},f=()=>{let e=(0,a.useContext)(u);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},46252:function(e,t,r){"use strict";r.d(t,{J:function(){return c},SocketProvider:function(){return l}});var n=r(57437),a=r(2265),o=r(68680),i=r(34029),s=r(14362);let c=(0,a.createContext)({socket:null,isConnected:!1}),l=e=>{let{children:t}=e,[r,l]=(0,a.useState)(null),[d,u]=(0,a.useState)(!1),p=(0,a.useRef)(!1),{user:f}=(0,s.a)();return(0,a.useEffect)(()=>{var e;if(!f){r&&(r.disconnect(),l(null),u(!1));return}let t=(null===(e=f.branch)||void 0===e?void 0:e.id)||f.branch_id||null,n=(0,o.io)("http://localhost:3000",{transports:["websocket"],withCredentials:!0,auth:{userId:f.id,branchId:t},reconnection:!0,reconnectionAttempts:5,reconnectionDelay:800,reconnectionDelayMax:8e3});return n.on("connect",()=>{console.log("Socket Connected:",n.id),u(!0),p.current=!1,i.ZP.success({content:"เชื่อมต่อเรียลไทม์แล้ว",key:"socket-status",duration:1.5})}),n.on("disconnect",()=>{console.log("Socket Disconnected"),u(!1),p.current||(p.current=!0,i.ZP.warning({content:"การเชื่อมต่อเรียลไทม์หลุด กำลังพยายามเชื่อมต่อใหม่...",key:"socket-status",duration:2}))}),n.io.on("reconnect_attempt",e=>{console.log("Socket reconnect attempt",e),u(!1)}),n.io.on("reconnect_failed",()=>{console.log("Socket reconnect failed"),i.ZP.error({content:"เชื่อมต่อเรียลไทม์ไม่สำเร็จ",key:"socket-status",duration:2})}),l(n),()=>{n.disconnect()}},[null==f?void 0:f.id]),(0,n.jsx)(c.Provider,{value:{socket:r,isConnected:d},children:t})}},3369:function(e,t,r){"use strict";r.d(t,{GlobalLoadingProvider:function(){return c},O:function(){return d},x:function(){return l}});var n=r(57437),a=r(2265),o=r(48651);let i=(0,a.createContext)(void 0),s=(0,a.createContext)(void 0),c=e=>{let{children:t}=e,[r,c]=(0,a.useState)({}),[l,d]=(0,a.useState)(void 0),u=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";c(e=>({...e,[t]:(e[t]||0)+1})),e&&d(e)},[]),p=(0,a.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";c(t=>{if(!t[e])return t;let r={...t};return r[e]-=1,r[e]<=0&&delete r[e],r})},[]),f=(0,a.useCallback)(()=>{c({}),d(void 0)},[]),h=Object.keys(r).length>0,g=(0,a.useMemo)(()=>({isLoading:h,loadingMessage:l}),[h,l]),y=(0,a.useMemo)(()=>({showLoading:u,hideLoading:p,resetLoading:f}),[u,p,f]);return(0,n.jsx)(s.Provider,{value:y,children:(0,n.jsxs)(i.Provider,{value:g,children:[t,h&&(0,n.jsx)("div",{role:"status","aria-live":"polite",className:"global-loading-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:13e3,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255, 255, 255, 0.7)",backdropFilter:"blur(6px)",WebkitBackdropFilter:"blur(6px)",transition:"opacity 0.25s ease"},children:(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:16,background:"rgba(255, 255, 255, 0.95)",padding:"28px 40px",borderRadius:20,boxShadow:"0 10px 32px rgba(15, 23, 42, 0.14)",border:"1px solid rgba(148, 163, 184, 0.35)",minWidth:240,textAlign:"center"},children:[(0,n.jsx)(o.Z,{size:"large"}),l&&(0,n.jsx)("div",{style:{fontSize:16,color:"#334155",fontWeight:600,letterSpacing:"0.01em"},children:l})]})})]})})};function l(){let e=(0,a.useContext)(i),t=(0,a.useContext)(s);if(!e||!t)throw Error("useGlobalLoading must be used within a GlobalLoadingProvider");return(0,a.useMemo)(()=>({...e,...t}),[e,t])}function d(){let e=(0,a.useContext)(s);if(!e)throw Error("useGlobalLoadingDispatch must be used within a GlobalLoadingProvider");return e}},30736:function(e,t,r){"use strict";r.d(t,{Z:function(){return i},j:function(){return s}});var n=r(57437),a=r(2265);let o=(0,a.createContext)(void 0),i=e=>{let{children:t}=e,[r,i]=(0,a.useState)([]);(0,a.useEffect)(()=>{let e=localStorage.getItem("shopping_cart");if(e)try{i(JSON.parse(e))}catch(e){console.error("Failed to parse cart from local storage",e)}},[]),(0,a.useEffect)(()=>{localStorage.setItem("shopping_cart",JSON.stringify(r))},[r]);let s=(0,a.useCallback)(e=>{i(t=>t.find(t=>t.ingredient.id===e.id)?t.map(t=>t.ingredient.id===e.id?{...t,quantity:t.quantity+1}:t):[...t,{ingredient:e,quantity:1}])},[]),c=(0,a.useCallback)(e=>{i(t=>t.filter(t=>t.ingredient.id!==e))},[]),l=(0,a.useCallback)((e,t)=>{if(t<=0){c(e);return}i(r=>r.map(r=>r.ingredient.id===e?{...r,quantity:t}:r))},[c]),d=(0,a.useCallback)((e,t)=>{i(r=>r.map(r=>r.ingredient.id===e?{...r,note:t}:r))},[]),u=(0,a.useCallback)(()=>{i([])},[]),p=r.reduce((e,t)=>e+t.quantity,0),f=a.useMemo(()=>({items:r,addToCart:s,removeFromCart:c,updateQuantity:l,updateItemNote:d,clearCart:u,itemCount:p}),[r,s,c,l,d,u,p]);return(0,n.jsx)(o.Provider,{value:f,children:t})},s=()=>{let e=(0,a.useContext)(o);if(!e)throw Error("useCart must be used within a CartProvider");return e}},24675:function(e,t,r){"use strict";r.d(t,{s:function(){return o}});var n=r(2265),a=r(46252);let o=()=>(0,n.useContext)(a.J)},84859:function(e,t,r){"use strict";r.d(t,{M:function(){return c},x:function(){return s}});let n="pos_offline_queue",a=()=>{let e=localStorage.getItem(n);return e?JSON.parse(e):[]},o=e=>{let t=Date.now();return e.filter(e=>t-e.timestamp<=6048e5)},i=e=>{localStorage.setItem(n,JSON.stringify(e))},s={addToQueue:(e,t)=>{let r=o(a()),n={id:"offline-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),type:e,payload:t,timestamp:Date.now(),retryCount:0};return i([...r,n]),n},getQueue:()=>a(),removeFromQueue:e=>{i(a().filter(t=>t.id!==e))},incrementRetry:(e,t)=>{i(a().map(r=>r.id===e?{...r,retryCount:r.retryCount+1,lastError:t}:r))},clearQueue:()=>{localStorage.removeItem(n)},pruneExceeded:()=>{i(o(a()).filter(e=>e.retryCount<=5))}},c={maxRetry:5,backoff:e=>Math.min(3e4,2e3*e)}},76155:function(e,t,r){"use strict";r.d(t,{x:function(){return s}});var n=r(2913),a=r(98170);let o="/stock/orders",i=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"application/json",r={};return t&&(r["Content-Type"]=t),e&&(r.Cookie=e),r},s={createOrder:async(e,t,r)=>{let s=(0,n.b)("POST",o),c=i(t);r&&(c["X-CSRF-Token"]=r);let l=await fetch(s,{method:"POST",headers:c,body:JSON.stringify(e)});if(!l.ok){let e=await l.text();console.error("Backend Error [createOrder]:",{status:l.status,statusText:l.statusText,url:s,body:e});let t={};try{t=JSON.parse(e)}catch(e){}throw Error((0,a.i_)(t,"ไม่สามารถสร้างออเดอร์ได้ (".concat(l.status,")")))}return(0,a.hH)(await l.json())},getAllOrders:async(e,t)=>{let r=(0,n.b)("GET",o);t&&(r+="?".concat(t.toString()));let s=i(e,""),c=await fetch(r,{cache:"no-store",headers:s});if(!c.ok){let e=await c.json().catch(()=>({}));throw Error((0,a.i_)(e,"ไม่สามารถดึงข้อมูลออเดอร์ได้"))}return(0,a.XO)(await c.json())},getOrderById:async(e,t)=>{let r=(0,n.b)("GET","".concat(o,"/").concat(e)),s=i(t,""),c=await fetch(r,{cache:"no-store",headers:s});if(!c.ok){let e=await c.json().catch(()=>({}));throw Error((0,a.i_)(e,"ไม่สามารถดึงข้อมูลออเดอร์ได้"))}return(0,a.hH)(await c.json())},updateStatus:async(e,t,r,s)=>{let c=(0,n.b)("PUT","".concat(o,"/").concat(e,"/status")),l=i(r);s&&(l["X-CSRF-Token"]=s);let d=await fetch(c,{method:"PUT",headers:l,body:JSON.stringify({status:t})});if(!d.ok){let e=await d.json().catch(()=>({}));throw Error((0,a.i_)(e,"ไม่สามารถอัปเดตสถานะออเดอร์ได้"))}return(0,a.hH)(await d.json())},updateOrder:async(e,t,r,s)=>{let c=(0,n.b)("PUT","".concat(o,"/").concat(e)),l=i(r);s&&(l["X-CSRF-Token"]=s);let d=await fetch(c,{method:"PUT",headers:l,body:JSON.stringify({items:t})});if(!d.ok){let e=await d.text();throw Error("Failed to update order: ".concat(d.status," ").concat(e))}return(0,a.hH)(await d.json())},confirmPurchase:async(e,t,r,s,c)=>{let l=(0,n.b)("POST","".concat(o,"/").concat(e,"/purchase")),d=i(s);c&&(d["X-CSRF-Token"]=c);let u=await fetch(l,{method:"POST",headers:d,body:JSON.stringify({items:t,purchased_by_id:r})});if(!u.ok){let e=await u.text();throw Error("Failed to confirm purchase: ".concat(u.status," ").concat(e))}return(0,a.hH)(await u.json())},updatePurchaseDetail:async(e,t)=>{let r=(0,n.b)("POST","/stock/ordersDetail/update"),o=i(t),s=await fetch(r,{method:"POST",headers:o,body:JSON.stringify(e)});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error((0,a.i_)(e,"ไม่สามารถอัปเดตข้อมูลการซื้อได้"))}return(0,a.hH)(await s.json())},deleteOrder:async(e,t,r)=>{let a=(0,n.b)("DELETE","".concat(o,"/").concat(e)),s=i(t,"");r&&(s["X-CSRF-Token"]=r);let c=await fetch(a,{method:"DELETE",headers:s});if(!c.ok){let e=await c.text();throw Error("Failed to delete order: ".concat(c.status," ").concat(e))}}}},12028:function(e,t,r){"use strict";r.d(t,{b:function(){return n},g:function(){return a}});let n={system:{announcement:"system:announcement"},users:{create:"users:create",update:"users:update",delete:"users:delete",status:"users:update-status"},roles:{create:"roles:create",update:"roles:update",delete:"roles:delete"},branches:{create:"branches:create",update:"branches:update",delete:"branches:delete"},products:{create:"products:create",update:"products:update",delete:"products:delete"},productsUnit:{create:"productsUnit:create",update:"productsUnit:update",delete:"productsUnit:delete"},categories:{create:"category:create",update:"category:update",delete:"category:delete"},tables:{create:"tables:create",update:"tables:update",delete:"tables:delete"},orders:{create:"orders:create",update:"orders:update",delete:"orders:delete"},payments:{create:"payments:create",update:"payments:update",delete:"payments:delete"},discounts:{create:"discounts:create",update:"discounts:update",delete:"discounts:delete"},delivery:{create:"delivery:create",update:"delivery:update",delete:"delivery:delete"},shifts:{update:"shifts:update"},orderQueue:{added:"order-queue:added",updated:"order-queue:updated",removed:"order-queue:removed",reordered:"order-queue:reordered"},ingredients:{create:"ingredients:create",update:"ingredients:update",delete:"ingredients:delete"},ingredientsUnit:{create:"ingredientsUnit:create",update:"ingredientsUnit:update",delete:"ingredientsUnit:delete"},stock:{update:"stock:update"},stockOrders:{create:"stock:orders:create",update:"stock:orders:update",status:"stock:orders:status",delete:"stock:orders:delete",detailUpdate:"stock:orders:detail:update"},paymentAccounts:{create:"payment-accounts:create",update:"payment-accounts:update",delete:"payment-accounts:delete"},paymentMethods:{create:"paymentMethod:create",update:"paymentMethod:update",delete:"paymentMethod:delete"},shopProfile:{update:"shopProfile:update"},salesOrderItem:{create:"salesOrderItem:create",update:"salesOrderItem:update",delete:"salesOrderItem:delete"},salesOrderDetail:{create:"salesOrderDetail:create",update:"salesOrderDetail:update",delete:"salesOrderDetail:delete"}},a={stockOrdersUpdated:"orders_updated"}}},function(e){e.O(0,[253,1522,3418,742,9486,4252,3916,8651,6931,4159,3831,2224,2401,3834,5713,8056,5799,3817,4149,9385,2971,2117,1744],function(){return e(e.s=78923)}),_N_E=e.O()}]);