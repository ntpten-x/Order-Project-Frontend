"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("src/middleware",{

/***/ "(middleware)/./src/middleware.ts":
/*!***************************!*\
  !*** ./src/middleware.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   middleware: () => (/* binding */ middleware)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(middleware)/./node_modules/next/dist/esm/api/server.js\");\n/* harmony import */ var _lib_rbac_policy__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./lib/rbac/policy */ \"(middleware)/./src/lib/rbac/policy.ts\");\n\n\nfunction decodeJwtPayload(token) {\n    const parts = token.split(\".\");\n    if (parts.length < 2) return null;\n    let payload = parts[1].replace(/-/g, \"+\").replace(/_/g, \"/\");\n    const pad = payload.length % 4;\n    if (pad) payload += \"=\".repeat(4 - pad);\n    try {\n        const json = atob(payload);\n        const parsed = JSON.parse(json);\n        if (!parsed || typeof parsed !== \"object\") return null;\n        return parsed;\n    } catch  {\n        return null;\n    }\n}\nfunction jsonError(status, message) {\n    return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        error: message\n    }, {\n        status\n    });\n}\nfunction middleware(req) {\n    const { pathname } = req.nextUrl;\n    // Skip static assets\n    if (pathname.startsWith(\"/_next\") || pathname.startsWith(\"/favicon.ico\") || pathname.startsWith(\"/robots.txt\") || pathname.startsWith(\"/sitemap.xml\")) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.next();\n    }\n    const policy = (0,_lib_rbac_policy__WEBPACK_IMPORTED_MODULE_1__.requiredRolesForPath)(pathname, req.method);\n    if (!policy) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.next();\n    const token = req.cookies.get(\"token\")?.value;\n    // Public access (no token required) only for login + csrf + auth login\n    const isPublic = pathname === \"/login\" || pathname.startsWith(\"/offline\") || pathname === \"/api/csrf\" || pathname.startsWith(\"/api/auth/login\") || pathname.startsWith(\"/api/auth/logout\");\n    if (!token) {\n        if (isPublic) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.next();\n        if (pathname.startsWith(\"/api\")) return jsonError(401, \"Unauthorized\");\n        const url = req.nextUrl.clone();\n        url.pathname = \"/login\";\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.redirect(url);\n    }\n    // Authenticated: determine role from JWT payload (UI gate only; backend is source of truth)\n    const payload = decodeJwtPayload(token);\n    const role = (0,_lib_rbac_policy__WEBPACK_IMPORTED_MODULE_1__.asRole)(payload?.role) ?? (0,_lib_rbac_policy__WEBPACK_IMPORTED_MODULE_1__.asRole)(payload?.user?.role);\n    if (!role) {\n        if (pathname.startsWith(\"/api\")) return jsonError(401, \"Unauthorized\");\n        const url = req.nextUrl.clone();\n        url.pathname = \"/login\";\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.redirect(url);\n    }\n    const allowed = policy.allowed;\n    const ok = allowed.includes(role) || role === \"Admin\";\n    if (ok) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.next();\n    if (pathname.startsWith(\"/api\")) return jsonError(403, \"Forbidden\");\n    const url = req.nextUrl.clone();\n    url.pathname = policy.redirectTo || \"/pos\";\n    return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.redirect(url);\n}\nconst config = {\n    matcher: [\n        \"/((?!_next/static|_next/image|favicon.ico).*)\"\n    ]\n};\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LENBQUNVLEtBQUs7SUFDN0JELElBQUlWLFFBQVEsR0FBR0ksT0FBT2MsVUFBVSxJQUFJO0lBQ3BDLE9BQU96QyxxREFBWUEsQ0FBQ21DLFFBQVEsQ0FBQ0Y7QUFDL0I7QUFFTyxNQUFNUyxTQUFTO0lBQ3BCQyxTQUFTO1FBQUM7S0FBZ0Q7QUFDNUQsRUFBRSIsInNvdXJjZXMiOlsid2VicGFjazovL19OX0UvLi9zcmMvbWlkZGxld2FyZS50cz9kMTk5Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tIFwibmV4dC9zZXJ2ZXJcIjtcbmltcG9ydCB7IGFzUm9sZSwgcmVxdWlyZWRSb2xlc0ZvclBhdGggfSBmcm9tIFwiLi9saWIvcmJhYy9wb2xpY3lcIjtcblxudHlwZSBKd3RQYXlsb2FkID0geyByb2xlPzogdW5rbm93bjsgdXNlcj86IHsgcm9sZT86IHVua25vd24gfSB9O1xuXG5mdW5jdGlvbiBkZWNvZGVKd3RQYXlsb2FkKHRva2VuOiBzdHJpbmcpOiBKd3RQYXlsb2FkIHwgbnVsbCB7XG4gIGNvbnN0IHBhcnRzID0gdG9rZW4uc3BsaXQoXCIuXCIpO1xuICBpZiAocGFydHMubGVuZ3RoIDwgMikgcmV0dXJuIG51bGw7XG4gIGxldCBwYXlsb2FkID0gcGFydHNbMV0ucmVwbGFjZSgvLS9nLCBcIitcIikucmVwbGFjZSgvXy9nLCBcIi9cIik7XG4gIGNvbnN0IHBhZCA9IHBheWxvYWQubGVuZ3RoICUgNDtcbiAgaWYgKHBhZCkgcGF5bG9hZCArPSBcIj1cIi5yZXBlYXQoNCAtIHBhZCk7XG4gIHRyeSB7XG4gICAgY29uc3QganNvbiA9IGF0b2IocGF5bG9hZCk7XG4gICAgY29uc3QgcGFyc2VkOiB1bmtub3duID0gSlNPTi5wYXJzZShqc29uKTtcbiAgICBpZiAoIXBhcnNlZCB8fCB0eXBlb2YgcGFyc2VkICE9PSBcIm9iamVjdFwiKSByZXR1cm4gbnVsbDtcbiAgICByZXR1cm4gcGFyc2VkIGFzIEp3dFBheWxvYWQ7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmZ1bmN0aW9uIGpzb25FcnJvcihzdGF0dXM6IG51bWJlciwgbWVzc2FnZTogc3RyaW5nKSB7XG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBtZXNzYWdlIH0sIHsgc3RhdHVzIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWlkZGxld2FyZShyZXE6IE5leHRSZXF1ZXN0KSB7XG4gIGNvbnN0IHsgcGF0aG5hbWUgfSA9IHJlcS5uZXh0VXJsO1xuXG4gIC8vIFNraXAgc3RhdGljIGFzc2V0c1xuICBpZiAoXG4gICAgcGF0aG5hbWUuc3RhcnRzV2l0aChcIi9fbmV4dFwiKSB8fFxuICAgIHBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvZmF2aWNvbi5pY29cIikgfHxcbiAgICBwYXRobmFtZS5zdGFydHNXaXRoKFwiL3JvYm90cy50eHRcIikgfHxcbiAgICBwYXRobmFtZS5zdGFydHNXaXRoKFwiL3NpdGVtYXAueG1sXCIpXG4gICkge1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UubmV4dCgpO1xuICB9XG5cbiAgY29uc3QgcG9saWN5ID0gcmVxdWlyZWRSb2xlc0ZvclBhdGgocGF0aG5hbWUsIHJlcS5tZXRob2QpO1xuICBpZiAoIXBvbGljeSkgcmV0dXJuIE5leHRSZXNwb25zZS5uZXh0KCk7XG5cbiAgY29uc3QgdG9rZW4gPSByZXEuY29va2llcy5nZXQoXCJ0b2tlblwiKT8udmFsdWU7XG5cbiAgLy8gUHVibGljIGFjY2VzcyAobm8gdG9rZW4gcmVxdWlyZWQpIG9ubHkgZm9yIGxvZ2luICsgY3NyZiArIGF1dGggbG9naW5cbiAgY29uc3QgaXNQdWJsaWMgPVxuICAgIHBhdGhuYW1lID09PSBcIi9sb2dpblwiIHx8XG4gICAgcGF0aG5hbWUuc3RhcnRzV2l0aChcIi9vZmZsaW5lXCIpIHx8XG4gICAgcGF0aG5hbWUgPT09IFwiL2FwaS9jc3JmXCIgfHxcbiAgICBwYXRobmFtZS5zdGFydHNXaXRoKFwiL2FwaS9hdXRoL2xvZ2luXCIpIHx8XG4gICAgcGF0aG5hbWUuc3RhcnRzV2l0aChcIi9hcGkvYXV0aC9sb2dvdXRcIik7XG5cbiAgaWYgKCF0b2tlbikge1xuICAgIGlmIChpc1B1YmxpYykgcmV0dXJuIE5leHRSZXNwb25zZS5uZXh0KCk7XG4gICAgaWYgKHBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvYXBpXCIpKSByZXR1cm4ganNvbkVycm9yKDQwMSwgXCJVbmF1dGhvcml6ZWRcIik7XG4gICAgY29uc3QgdXJsID0gcmVxLm5leHRVcmwuY2xvbmUoKTtcbiAgICB1cmwucGF0aG5hbWUgPSBcIi9sb2dpblwiO1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmVkaXJlY3QodXJsKTtcbiAgfVxuXG4gIC8vIEF1dGhlbnRpY2F0ZWQ6IGRldGVybWluZSByb2xlIGZyb20gSldUIHBheWxvYWQgKFVJIGdhdGUgb25seTsgYmFja2VuZCBpcyBzb3VyY2Ugb2YgdHJ1dGgpXG4gIGNvbnN0IHBheWxvYWQgPSBkZWNvZGVKd3RQYXlsb2FkKHRva2VuKTtcbiAgY29uc3Qgcm9sZSA9IGFzUm9sZShwYXlsb2FkPy5yb2xlKSA/PyBhc1JvbGUocGF5bG9hZD8udXNlcj8ucm9sZSk7XG5cbiAgaWYgKCFyb2xlKSB7XG4gICAgaWYgKHBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvYXBpXCIpKSByZXR1cm4ganNvbkVycm9yKDQwMSwgXCJVbmF1dGhvcml6ZWRcIik7XG4gICAgY29uc3QgdXJsID0gcmVxLm5leHRVcmwuY2xvbmUoKTtcbiAgICB1cmwucGF0aG5hbWUgPSBcIi9sb2dpblwiO1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmVkaXJlY3QodXJsKTtcbiAgfVxuXG4gIGNvbnN0IGFsbG93ZWQgPSBwb2xpY3kuYWxsb3dlZDtcbiAgY29uc3Qgb2sgPSBhbGxvd2VkLmluY2x1ZGVzKHJvbGUpIHx8IHJvbGUgPT09IFwiQWRtaW5cIjtcbiAgaWYgKG9rKSByZXR1cm4gTmV4dFJlc3BvbnNlLm5leHQoKTtcblxuICBpZiAocGF0aG5hbWUuc3RhcnRzV2l0aChcIi9hcGlcIikpIHJldHVybiBqc29uRXJyb3IoNDAzLCBcIkZvcmJpZGRlblwiKTtcblxuICBjb25zdCB1cmwgPSByZXEubmV4dFVybC5jbG9uZSgpO1xuICB1cmwucGF0aG5hbWUgPSBwb2xpY3kucmVkaXJlY3RUbyB8fCBcIi9wb3NcIjtcbiAgcmV0dXJuIE5leHRSZXNwb25zZS5yZWRpcmVjdCh1cmwpO1xufVxuXG5leHBvcnQgY29uc3QgY29uZmlnID0ge1xuICBtYXRjaGVyOiBbXCIvKCg/IV9uZXh0L3N0YXRpY3xfbmV4dC9pbWFnZXxmYXZpY29uLmljbykuKilcIl0sXG59O1xuIl0sIm5hbWVzIjpbIk5leHRSZXNwb25zZSIsImFzUm9sZSIsInJlcXVpcmVkUm9sZXNGb3JQYXRoIiwiZGVjb2RlSnd0UGF5bG9hZCIsInRva2VuIiwicGFydHMiLCJzcGxpdCIsImxlbmd0aCIsInBheWxvYWQiLCJyZXBsYWNlIiwicGFkIiwicmVwZWF0IiwianNvbiIsImF0b2IiLCJwYXJzZWQiLCJKU09OIiwicGFyc2UiLCJqc29uRXJyb3IiLCJzdGF0dXMiLCJtZXNzYWdlIiwiZXJyb3IiLCJtaWRkbGV3YXJlIiwicmVxIiwicGF0aG5hbWUiLCJuZXh0VXJsIiwic3RhcnRzV2l0aCIsIm5leHQiLCJwb2xpY3kiLCJtZXRob2QiLCJjb29raWVzIiwiZ2V0IiwidmFsdWUiLCJpc1B1YmxpYyIsInVybCIsImNsb25lIiwicmVkaXJlY3QiLCJyb2xlIiwidXNlciIsImFsbG93ZWQiLCJvayIsImluY2x1ZGVzIiwicmVkaXJlY3RUbyIsImNvbmZpZyIsIm1hdGNoZXIiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(middleware)/./src/middleware.ts\n");

/***/ })

});