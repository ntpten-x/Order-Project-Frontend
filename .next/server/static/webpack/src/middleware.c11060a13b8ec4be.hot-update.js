"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("src/middleware",{

/***/ "(middleware)/./src/middleware.ts":
/*!***************************!*\
  !*** ./src/middleware.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   middleware: () => (/* binding */ middleware)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(middleware)/./node_modules/next/dist/esm/api/server.js\");\n/* harmony import */ var _lib_rbac_policy__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./lib/rbac/policy */ \"(middleware)/./src/lib/rbac/policy.ts\");\n\n\nfunction decodeJwtPayload(token) {\n    const parts = token.split(\".\");\n    if (parts.length < 2) return null;\n    let payload = parts[1].replace(/-/g, \"+\").replace(/_/g, \"/\");\n    const pad = payload.length % 4;\n    if (pad) payload += \"=\".repeat(4 - pad);\n    try {\n        const json = atob(payload);\n        const parsed = JSON.parse(json);\n        if (!parsed || typeof parsed !== \"object\") return null;\n        return parsed;\n    } catch  {\n        return null;\n    }\n}\nfunction jsonError(status, message) {\n    return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        error: message\n    }, {\n        status\n    });\n}\nfunction middleware(req) {\n    const { pathname } = req.nextUrl;\n    // Skip static assets\n    if (pathname.startsWith(\"/_next\") || pathname.startsWith(\"/favicon.ico\") || pathname.startsWith(\"/robots.txt\") || pathname.startsWith(\"/sitemap.xml\")) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.next();\n    }\n    const policy = (0,_lib_rbac_policy__WEBPACK_IMPORTED_MODULE_1__.requiredRolesForPath)(pathname, req.method);\n    if (!policy) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.next();\n    // Public access (no token required) only for login + csrf + auth login\n    const isPublic = pathname === \"/login\" || pathname.startsWith(\"/offline\") || pathname === \"/api/csrf\" || pathname.startsWith(\"/api/auth/login\") || pathname.startsWith(\"/api/auth/logout\");\n    if (isPublic) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.next();\n    const token = req.cookies.get(\"token\")?.value;\n    const redirectToLogin = ()=>{\n        if (pathname.startsWith(\"/api\")) return jsonError(401, \"Unauthorized\");\n        const url = req.nextUrl.clone();\n        url.pathname = \"/login\";\n        const res = next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.redirect(url);\n        // Clear potentially invalid/stale token to prevent redirect loops.\n        res.cookies.delete(\"token\");\n        return res;\n    };\n    if (!token) {\n        return redirectToLogin();\n    }\n    // Authenticated: determine role from JWT payload (UI gate only; backend is source of truth)\n    const payload = decodeJwtPayload(token);\n    const role = (0,_lib_rbac_policy__WEBPACK_IMPORTED_MODULE_1__.asRole)(payload?.role) ?? (0,_lib_rbac_policy__WEBPACK_IMPORTED_MODULE_1__.asRole)(payload?.user?.role);\n    if (!role) {\n        return redirectToLogin();\n    }\n    const allowed = policy.allowed;\n    const ok = allowed.includes(role) || role === \"Admin\";\n    if (ok) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.next();\n    if (pathname.startsWith(\"/api\")) return jsonError(403, \"Forbidden\");\n    const url = req.nextUrl.clone();\n    url.pathname = policy.redirectTo || \"/pos\";\n    return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.redirect(url);\n}\nconst config = {\n    matcher: [\n        \"/((?!_next/static|_next/image|favicon.ico).*)\"\n    ]\n};\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKG1pZGRsZXdhcmUpLy4vc3JjL21pZGRsZXdhcmUudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUF3RDtBQUNTO0FBSWpFLFNBQVNHLGlCQUFpQkMsS0FBYTtJQUNyQyxNQUFNQyxRQUFRRCxNQUFNRSxLQUFLLENBQUM7SUFDMUIsSUFBSUQsTUFBTUUsTUFBTSxHQUFHLEdBQUcsT0FBTztJQUM3QixJQUFJQyxVQUFVSCxLQUFLLENBQUMsRUFBRSxDQUFDSSxPQUFPLENBQUMsTUFBTSxLQUFLQSxPQUFPLENBQUMsTUFBTTtJQUN4RCxNQUFNQyxNQUFNRixRQUFRRCxNQUFNLEdBQUc7SUFDN0IsSUFBSUcsS0FBS0YsV0FBVyxJQUFJRyxNQUFNLENBQUMsSUFBSUQ7SUFDbkMsSUFBSTtRQUNGLE1BQU1FLE9BQU9DLEtBQUtMO1FBQ2xCLE1BQU1NLFNBQWtCQyxLQUFLQyxLQUFLLENBQUNKO1FBQ25DLElBQUksQ0FBQ0UsVUFBVSxPQUFPQSxXQUFXLFVBQVUsT0FBTztRQUNsRCxPQUFPQTtJQUNULEVBQUUsT0FBTTtRQUNOLE9BQU87SUFDVDtBQUNGO0FBRUEsU0FBU0csVUFBVUMsTUFBYyxFQUFFQyxPQUFlO0lBQ2hELE9BQU9uQixxREFBWUEsQ0FBQ1ksSUFBSSxDQUFDO1FBQUVRLE9BQU9EO0lBQVEsR0FBRztRQUFFRDtJQUFPO0FBQ3hEO0FBRU8sU0FBU0csV0FBV0MsR0FBZ0I7SUFDekMsTUFBTSxFQUFFQyxRQUFRLEVBQUUsR0FBR0QsSUFBSUUsT0FBTztJQUVoQyxxQkFBcUI7SUFDckIsSUFDRUQsU0FBU0UsVUFBVSxDQUFDLGFBQ3BCRixTQUFTRSxVQUFVLENBQUMsbUJBQ3BCRixTQUFTRSxVQUFVLENBQUMsa0JBQ3BCRixTQUFTRSxVQUFVLENBQUMsaUJBQ3BCO1FBQ0EsT0FBT3pCLHFEQUFZQSxDQUFDMEIsSUFBSTtJQUMxQjtJQUVBLE1BQU1DLFNBQVN6QixzRUFBb0JBLENBQUNxQixVQUFVRCxJQUFJTSxNQUFNO0lBQ3hELElBQUksQ0FBQ0QsUUFBUSxPQUFPM0IscURBQVlBLENBQUMwQixJQUFJO0lBRXJDLHVFQUF1RTtJQUN2RSxNQUFNRyxXQUNKTixhQUFhLFlBQ2JBLFNBQVNFLFVBQVUsQ0FBQyxlQUNwQkYsYUFBYSxlQUNiQSxTQUFTRSxVQUFVLENBQUMsc0JBQ3BCRixTQUFTRSxVQUFVLENBQUM7SUFDdEIsSUFBSUksVUFBVSxPQUFPN0IscURBQVlBLENBQUMwQixJQUFJO0lBRXRDLE1BQU10QixRQUFRa0IsSUFBSVEsT0FBTyxDQUFDQyxHQUFHLENBQUMsVUFBVUM7SUFFeEMsTUFBTUMsa0JBQWtCO1FBQ3RCLElBQUlWLFNBQVNFLFVBQVUsQ0FBQyxTQUFTLE9BQU9SLFVBQVUsS0FBSztRQUN2RCxNQUFNaUIsTUFBTVosSUFBSUUsT0FBTyxDQUFDVyxLQUFLO1FBQzdCRCxJQUFJWCxRQUFRLEdBQUc7UUFDZixNQUFNYSxNQUFNcEMscURBQVlBLENBQUNxQyxRQUFRLENBQUNIO1FBQ2xDLG1FQUFtRTtRQUNuRUUsSUFBSU4sT0FBTyxDQUFDUSxNQUFNLENBQUM7UUFDbkIsT0FBT0Y7SUFDVDtJQUVBLElBQUksQ0FBQ2hDLE9BQU87UUFDVixPQUFPNkI7SUFDVDtJQUVBLDRGQUE0RjtJQUM1RixNQUFNekIsVUFBVUwsaUJBQWlCQztJQUNqQyxNQUFNbUMsT0FBT3RDLHdEQUFNQSxDQUFDTyxTQUFTK0IsU0FBU3RDLHdEQUFNQSxDQUFDTyxTQUFTZ0MsTUFBTUQ7SUFFNUQsSUFBSSxDQUFDQSxNQUFNO1FBQ1QsT0FBT047SUFDVDtJQUVBLE1BQU1RLFVBQVVkLE9BQU9jLE9BQU87SUFDOUIsTUFBTUMsS0FBS0QsUUFBUUUsUUFBUSxDQUFDSixTQUFTQSxTQUFTO0lBQzlDLElBQUlHLElBQUksT0FBTzFDLHFEQUFZQSxDQUFDMEIsSUFBSTtJQUVoQyxJQUFJSCxTQUFTRSxVQUFVLENBQUMsU0FBUyxPQUFPUixVQUFVLEtBQUs7SUFFdkQsTUFBTWlCLE1BQU1aLElBQUlFLE9BQU8sQ0FBQ1csS0FBSztJQUM3QkQsSUFBSVgsUUFBUSxHQUFHSSxPQUFPaUIsVUFBVSxJQUFJO0lBQ3BDLE9BQU81QyxxREFBWUEsQ0FBQ3FDLFFBQVEsQ0FBQ0g7QUFDL0I7QUFFTyxNQUFNVyxTQUFTO0lBQ3BCQyxTQUFTO1FBQUM7S0FBZ0Q7QUFDNUQsRUFBRSIsInNvdXJjZXMiOlsid2VicGFjazovL19OX0UvLi9zcmMvbWlkZGxld2FyZS50cz9kMTk5Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tIFwibmV4dC9zZXJ2ZXJcIjtcbmltcG9ydCB7IGFzUm9sZSwgcmVxdWlyZWRSb2xlc0ZvclBhdGggfSBmcm9tIFwiLi9saWIvcmJhYy9wb2xpY3lcIjtcblxudHlwZSBKd3RQYXlsb2FkID0geyByb2xlPzogdW5rbm93bjsgdXNlcj86IHsgcm9sZT86IHVua25vd24gfSB9O1xuXG5mdW5jdGlvbiBkZWNvZGVKd3RQYXlsb2FkKHRva2VuOiBzdHJpbmcpOiBKd3RQYXlsb2FkIHwgbnVsbCB7XG4gIGNvbnN0IHBhcnRzID0gdG9rZW4uc3BsaXQoXCIuXCIpO1xuICBpZiAocGFydHMubGVuZ3RoIDwgMikgcmV0dXJuIG51bGw7XG4gIGxldCBwYXlsb2FkID0gcGFydHNbMV0ucmVwbGFjZSgvLS9nLCBcIitcIikucmVwbGFjZSgvXy9nLCBcIi9cIik7XG4gIGNvbnN0IHBhZCA9IHBheWxvYWQubGVuZ3RoICUgNDtcbiAgaWYgKHBhZCkgcGF5bG9hZCArPSBcIj1cIi5yZXBlYXQoNCAtIHBhZCk7XG4gIHRyeSB7XG4gICAgY29uc3QganNvbiA9IGF0b2IocGF5bG9hZCk7XG4gICAgY29uc3QgcGFyc2VkOiB1bmtub3duID0gSlNPTi5wYXJzZShqc29uKTtcbiAgICBpZiAoIXBhcnNlZCB8fCB0eXBlb2YgcGFyc2VkICE9PSBcIm9iamVjdFwiKSByZXR1cm4gbnVsbDtcbiAgICByZXR1cm4gcGFyc2VkIGFzIEp3dFBheWxvYWQ7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmZ1bmN0aW9uIGpzb25FcnJvcihzdGF0dXM6IG51bWJlciwgbWVzc2FnZTogc3RyaW5nKSB7XG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBtZXNzYWdlIH0sIHsgc3RhdHVzIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWlkZGxld2FyZShyZXE6IE5leHRSZXF1ZXN0KSB7XG4gIGNvbnN0IHsgcGF0aG5hbWUgfSA9IHJlcS5uZXh0VXJsO1xuXG4gIC8vIFNraXAgc3RhdGljIGFzc2V0c1xuICBpZiAoXG4gICAgcGF0aG5hbWUuc3RhcnRzV2l0aChcIi9fbmV4dFwiKSB8fFxuICAgIHBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvZmF2aWNvbi5pY29cIikgfHxcbiAgICBwYXRobmFtZS5zdGFydHNXaXRoKFwiL3JvYm90cy50eHRcIikgfHxcbiAgICBwYXRobmFtZS5zdGFydHNXaXRoKFwiL3NpdGVtYXAueG1sXCIpXG4gICkge1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UubmV4dCgpO1xuICB9XG5cbiAgY29uc3QgcG9saWN5ID0gcmVxdWlyZWRSb2xlc0ZvclBhdGgocGF0aG5hbWUsIHJlcS5tZXRob2QpO1xuICBpZiAoIXBvbGljeSkgcmV0dXJuIE5leHRSZXNwb25zZS5uZXh0KCk7XG5cbiAgLy8gUHVibGljIGFjY2VzcyAobm8gdG9rZW4gcmVxdWlyZWQpIG9ubHkgZm9yIGxvZ2luICsgY3NyZiArIGF1dGggbG9naW5cbiAgY29uc3QgaXNQdWJsaWMgPVxuICAgIHBhdGhuYW1lID09PSBcIi9sb2dpblwiIHx8XG4gICAgcGF0aG5hbWUuc3RhcnRzV2l0aChcIi9vZmZsaW5lXCIpIHx8XG4gICAgcGF0aG5hbWUgPT09IFwiL2FwaS9jc3JmXCIgfHxcbiAgICBwYXRobmFtZS5zdGFydHNXaXRoKFwiL2FwaS9hdXRoL2xvZ2luXCIpIHx8XG4gICAgcGF0aG5hbWUuc3RhcnRzV2l0aChcIi9hcGkvYXV0aC9sb2dvdXRcIik7XG4gIGlmIChpc1B1YmxpYykgcmV0dXJuIE5leHRSZXNwb25zZS5uZXh0KCk7XG5cbiAgY29uc3QgdG9rZW4gPSByZXEuY29va2llcy5nZXQoXCJ0b2tlblwiKT8udmFsdWU7XG5cbiAgY29uc3QgcmVkaXJlY3RUb0xvZ2luID0gKCkgPT4ge1xuICAgIGlmIChwYXRobmFtZS5zdGFydHNXaXRoKFwiL2FwaVwiKSkgcmV0dXJuIGpzb25FcnJvcig0MDEsIFwiVW5hdXRob3JpemVkXCIpO1xuICAgIGNvbnN0IHVybCA9IHJlcS5uZXh0VXJsLmNsb25lKCk7XG4gICAgdXJsLnBhdGhuYW1lID0gXCIvbG9naW5cIjtcbiAgICBjb25zdCByZXMgPSBOZXh0UmVzcG9uc2UucmVkaXJlY3QodXJsKTtcbiAgICAvLyBDbGVhciBwb3RlbnRpYWxseSBpbnZhbGlkL3N0YWxlIHRva2VuIHRvIHByZXZlbnQgcmVkaXJlY3QgbG9vcHMuXG4gICAgcmVzLmNvb2tpZXMuZGVsZXRlKFwidG9rZW5cIik7XG4gICAgcmV0dXJuIHJlcztcbiAgfTtcblxuICBpZiAoIXRva2VuKSB7XG4gICAgcmV0dXJuIHJlZGlyZWN0VG9Mb2dpbigpO1xuICB9XG5cbiAgLy8gQXV0aGVudGljYXRlZDogZGV0ZXJtaW5lIHJvbGUgZnJvbSBKV1QgcGF5bG9hZCAoVUkgZ2F0ZSBvbmx5OyBiYWNrZW5kIGlzIHNvdXJjZSBvZiB0cnV0aClcbiAgY29uc3QgcGF5bG9hZCA9IGRlY29kZUp3dFBheWxvYWQodG9rZW4pO1xuICBjb25zdCByb2xlID0gYXNSb2xlKHBheWxvYWQ/LnJvbGUpID8/IGFzUm9sZShwYXlsb2FkPy51c2VyPy5yb2xlKTtcblxuICBpZiAoIXJvbGUpIHtcbiAgICByZXR1cm4gcmVkaXJlY3RUb0xvZ2luKCk7XG4gIH1cblxuICBjb25zdCBhbGxvd2VkID0gcG9saWN5LmFsbG93ZWQ7XG4gIGNvbnN0IG9rID0gYWxsb3dlZC5pbmNsdWRlcyhyb2xlKSB8fCByb2xlID09PSBcIkFkbWluXCI7XG4gIGlmIChvaykgcmV0dXJuIE5leHRSZXNwb25zZS5uZXh0KCk7XG5cbiAgaWYgKHBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvYXBpXCIpKSByZXR1cm4ganNvbkVycm9yKDQwMywgXCJGb3JiaWRkZW5cIik7XG5cbiAgY29uc3QgdXJsID0gcmVxLm5leHRVcmwuY2xvbmUoKTtcbiAgdXJsLnBhdGhuYW1lID0gcG9saWN5LnJlZGlyZWN0VG8gfHwgXCIvcG9zXCI7XG4gIHJldHVybiBOZXh0UmVzcG9uc2UucmVkaXJlY3QodXJsKTtcbn1cblxuZXhwb3J0IGNvbnN0IGNvbmZpZyA9IHtcbiAgbWF0Y2hlcjogW1wiLygoPyFfbmV4dC9zdGF0aWN8X25leHQvaW1hZ2V8ZmF2aWNvbi5pY28pLiopXCJdLFxufTtcbiJdLCJuYW1lcyI6WyJOZXh0UmVzcG9uc2UiLCJhc1JvbGUiLCJyZXF1aXJlZFJvbGVzRm9yUGF0aCIsImRlY29kZUp3dFBheWxvYWQiLCJ0b2tlbiIsInBhcnRzIiwic3BsaXQiLCJsZW5ndGgiLCJwYXlsb2FkIiwicmVwbGFjZSIsInBhZCIsInJlcGVhdCIsImpzb24iLCJhdG9iIiwicGFyc2VkIiwiSlNPTiIsInBhcnNlIiwianNvbkVycm9yIiwic3RhdHVzIiwibWVzc2FnZSIsImVycm9yIiwibWlkZGxld2FyZSIsInJlcSIsInBhdGhuYW1lIiwibmV4dFVybCIsInN0YXJ0c1dpdGgiLCJuZXh0IiwicG9saWN5IiwibWV0aG9kIiwiaXNQdWJsaWMiLCJjb29raWVzIiwiZ2V0IiwidmFsdWUiLCJyZWRpcmVjdFRvTG9naW4iLCJ1cmwiLCJjbG9uZSIsInJlcyIsInJlZGlyZWN0IiwiZGVsZXRlIiwicm9sZSIsInVzZXIiLCJhbGxvd2VkIiwib2siLCJpbmNsdWRlcyIsInJlZGlyZWN0VG8iLCJjb25maWciLCJtYXRjaGVyIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(middleware)/./src/middleware.ts\n");

/***/ })

});