import { spawn } from "node:child_process";
import fs from "node:fs/promises";
import path from "node:path";

const isWin = process.platform === "win32";
const ROOT_DIR = path.resolve(process.cwd(), "..");
const REPORT_PATH = path.join(ROOT_DIR, "GO_LIVE_SIGNOFF_REPORT.md");

const allSteps = [
  { id: "P1", name: "Phase 1 Backend static + unit", cmd: "npm --prefix ../Order-Project-Backend run test:go-live:phase1" },
  { id: "P2", name: "Phase 2 Backend migration + DB integration", cmd: "npm --prefix ../Order-Project-Backend run test:go-live:phase2" },
  { id: "P3", name: "Phase 3 Realtime/socket contract", cmd: "npm --prefix ../Order-Project-Backend run test:go-live:phase3" },
  { id: "P4", name: "Phase 4 Load/timeout smoke", cmd: "npm --prefix ../Order-Project-Backend run test:go-live:phase4" },
  { id: "P5", name: "Phase 5 Frontend lint + API smoke", cmd: "npm run test:go-live:phase5" },
  { id: "P6", name: "Phase 6 Frontend resilience", cmd: "npm run test:go-live:phase6" },
  { id: "P7", name: "Phase 7 Operational sign-off", cmd: "npm run test:go-live:phase7" },
];

function pickSteps() {
  const scope = (process.env.SIGNOFF_SCOPE || "full").toLowerCase();
  if (scope === "phase7") return allSteps.filter((s) => s.id === "P7");
  if (scope === "quick") return allSteps.filter((s) => ["P4", "P5", "P6", "P7"].includes(s.id));
  return allSteps;
}

function runCommand(command, env) {
  return new Promise((resolve) => {
    const start = Date.now();
    const child = isWin
      ? spawn("cmd.exe", ["/d", "/s", "/c", command], { env, shell: false })
      : spawn("sh", ["-lc", command], { env, shell: false });

    let stdout = "";
    let stderr = "";

    child.stdout?.on("data", (chunk) => {
      const text = chunk.toString();
      stdout += text;
      process.stdout.write(text);
    });

    child.stderr?.on("data", (chunk) => {
      const text = chunk.toString();
      stderr += text;
      process.stderr.write(text);
    });

    child.on("close", (code) => {
      resolve({
        code: code ?? 1,
        durationMs: Date.now() - start,
        stdout,
        stderr,
      });
    });

    child.on("error", (error) => {
      stderr += `\n${String(error)}`;
      resolve({
        code: 1,
        durationMs: Date.now() - start,
        stdout,
        stderr,
      });
    });
  });
}

function formatDuration(ms) {
  const sec = Math.round(ms / 1000);
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}m ${s}s`;
}

async function main() {
  const steps = pickSteps();
  const env = {
    ...process.env,
    NO_PROXY: "127.0.0.1,localhost",
    no_proxy: "127.0.0.1,localhost",
  };

  const startedAt = new Date();
  const results = [];

  for (const step of steps) {
    console.log(`\n[signoff] running ${step.id}: ${step.name}`);
    const result = await runCommand(step.cmd, env);
    const pass = result.code === 0;
    results.push({ ...step, ...result, pass });
    if (!pass) {
      console.error(`[signoff] failed at ${step.id}`);
      break;
    }
  }

  const finishedAt = new Date();
  const overallPass = results.length === steps.length && results.every((r) => r.pass);
  const scopeLabel = (process.env.SIGNOFF_SCOPE || "full").toLowerCase();

  const lines = [];
  lines.push("# Go-Live Production Sign-off Report");
  lines.push("");
  lines.push(`- Status: **${overallPass ? "PASS" : "FAIL"}**`);
  lines.push(`- Scope: \`${scopeLabel}\``);
  lines.push(`- Started at: ${startedAt.toISOString()}`);
  lines.push(`- Finished at: ${finishedAt.toISOString()}`);
  lines.push(`- Machine: ${process.env.COMPUTERNAME || process.env.HOSTNAME || "unknown"}`);
  lines.push(`- Generated by: \`npm run test:go-live:phase7:signoff\``);
  lines.push("");
  lines.push("## Gate Results");
  lines.push("");
  lines.push("| Phase | Check | Result | Duration |");
  lines.push("| --- | --- | --- | --- |");
  for (const r of results) {
    lines.push(`| ${r.id} | ${r.name} | ${r.pass ? "PASS" : "FAIL"} | ${formatDuration(r.durationMs)} |`);
  }
  lines.push("");
  lines.push("## Decision");
  lines.push("");
  lines.push(
    overallPass
      ? "System is approved for go-live under the tested scope."
      : "System is not approved for go-live. Fix failing phase(s) and rerun sign-off."
  );
  lines.push("");
  lines.push("## Notes");
  lines.push("");
  lines.push("- This report is generated from automated execution outputs.");
  lines.push("- For production release governance, keep this file attached to change request/release ticket.");

  await fs.writeFile(REPORT_PATH, `${lines.join("\n")}\n`, "utf8");
  console.log(`\n[signoff] report written: ${REPORT_PATH}`);

  process.exit(overallPass ? 0 : 1);
}

main().catch((error) => {
  console.error("[signoff] failed:", error);
  process.exit(1);
});
