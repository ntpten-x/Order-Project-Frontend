import { spawn } from "node:child_process";
import fs from "node:fs/promises";
import path from "node:path";

const isWin = process.platform === "win32";
const ROOT_DIR = path.resolve(process.cwd(), "..");
const REPORT_PATH = path.join(ROOT_DIR, "GO_LIVE_STOCK_PHASE9_SIGNOFF_REPORT.md");

function pickSteps(scope) {
  const steps = [
    { id: "S1", name: "Frontend lint", cmd: "npm run lint" },
    { id: "S2", name: "Frontend build", cmd: "npm run build" },
    { id: "S3", name: "Stock phase9 e2e + perf(default)", cmd: "npm run test:go-live:phase9" },
    { id: "S4", name: "Stock perf(strict)", cmd: "npm run perf:stock:phase9", env: { PERF_PROFILE: "strict" } },
  ];

  if (scope === "quick") return steps.filter((s) => ["S3"].includes(s.id));
  if (scope === "phase9") return steps.filter((s) => ["S3"].includes(s.id));
  if (scope === "standard") return steps.filter((s) => ["S1", "S2", "S3"].includes(s.id));
  return steps;
}

function runCommand(command, env) {
  return new Promise((resolve) => {
    const start = Date.now();
    const child = isWin
      ? spawn("cmd.exe", ["/d", "/s", "/c", command], { env, shell: false })
      : spawn("sh", ["-lc", command], { env, shell: false });

    let stdout = "";
    let stderr = "";

    child.stdout?.on("data", (chunk) => {
      const text = chunk.toString();
      stdout += text;
      process.stdout.write(text);
    });

    child.stderr?.on("data", (chunk) => {
      const text = chunk.toString();
      stderr += text;
      process.stderr.write(text);
    });

    child.on("close", (code) => {
      resolve({
        code: code ?? 1,
        durationMs: Date.now() - start,
        stdout,
        stderr,
      });
    });

    child.on("error", (error) => {
      stderr += `\n${String(error)}`;
      resolve({
        code: 1,
        durationMs: Date.now() - start,
        stdout,
        stderr,
      });
    });
  });
}

function formatDuration(ms) {
  const sec = Math.round(ms / 1000);
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}m ${s}s`;
}

async function main() {
  const scope = (process.env.SIGNOFF_SCOPE || "standard").toLowerCase();
  const steps = pickSteps(scope);
  const env = {
    ...process.env,
    NO_PROXY: "127.0.0.1,localhost",
    no_proxy: "127.0.0.1,localhost",
    HTTP_PROXY: "",
    HTTPS_PROXY: "",
    ALL_PROXY: "",
  };

  const startedAt = new Date();
  const results = [];

  for (const step of steps) {
    console.log(`\n[phase9-signoff] running ${step.id}: ${step.name}`);
    const result = await runCommand(step.cmd, { ...env, ...(step.env || {}) });
    const pass = result.code === 0;
    results.push({ ...step, ...result, pass });
    if (!pass) {
      console.error(`[phase9-signoff] failed at ${step.id}`);
      break;
    }
  }

  const finishedAt = new Date();
  const overallPass = results.length === steps.length && results.every((r) => r.pass);

  const lines = [];
  lines.push("# Stock Phase9 Go-Live Sign-off Report");
  lines.push("");
  lines.push(`- Status: **${overallPass ? "PASS" : "FAIL"}**`);
  lines.push(`- Scope: \`${scope}\``);
  lines.push(`- Started at: ${startedAt.toISOString()}`);
  lines.push(`- Finished at: ${finishedAt.toISOString()}`);
  lines.push(`- Machine: ${process.env.COMPUTERNAME || process.env.HOSTNAME || "unknown"}`);
  lines.push("- Generated by: `npm run test:go-live:phase9:signoff`");
  lines.push("");
  lines.push("## Gate Results");
  lines.push("");
  lines.push("| Step | Check | Result | Duration |");
  lines.push("| --- | --- | --- | --- |");
  for (const r of results) {
    lines.push(`| ${r.id} | ${r.name} | ${r.pass ? "PASS" : "FAIL"} | ${formatDuration(r.durationMs)} |`);
  }
  lines.push("");
  lines.push("## Decision");
  lines.push("");
  lines.push(
    overallPass
      ? "Stock system is approved for go-live under the tested scope."
      : "Stock system is not approved for go-live. Fix failed step(s) and rerun sign-off."
  );

  await fs.writeFile(REPORT_PATH, `${lines.join("\n")}\n`, "utf8");
  console.log(`\n[phase9-signoff] report written: ${REPORT_PATH}`);

  process.exit(overallPass ? 0 : 1);
}

main().catch((error) => {
  console.error("[phase9-signoff] failed:", error);
  process.exit(1);
});

